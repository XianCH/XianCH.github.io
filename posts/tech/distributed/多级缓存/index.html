<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>å¤šçº§ç¼“å­˜ | X14n&#39;s Blog</title>
<meta name="keywords" content="">
<meta name="description" content="1.ä»€ä¹ˆæ˜¯å¤šçº§ç¼“å­˜ ä¼ ç»Ÿçš„ç¼“å­˜ç­–ç•¥ä¸€èˆ¬æ˜¯è¯·æ±‚åˆ°è¾¾Tomcatåï¼Œå…ˆæŸ¥è¯¢Redisï¼Œå¦‚æœæœªå‘½ä¸­åˆ™æŸ¥è¯¢æ•°æ®åº“ï¼Œå¦‚å›¾ï¼š å­˜åœ¨ä¸‹é¢çš„é—®é¢˜ï¼š â€¢è¯·æ±‚è¦ç»è¿‡Tomcatå¤„ç†ï¼ŒTomcatçš„æ€§èƒ½æˆä¸ºæ•´ä¸ªç³»ç»Ÿçš„ç“¶é¢ˆ â€¢Redisç¼“å­˜å¤±æ•ˆæ—¶ï¼Œä¼šå¯¹æ•°æ®åº“äº§ç”Ÿå†²å‡» å¤šçº§ç¼“å­˜å°±æ˜¯å……åˆ†åˆ©ç”¨è¯·æ±‚å¤„ç†çš„æ¯ä¸ªç¯èŠ‚ï¼Œåˆ†åˆ«æ·»">
<meta name="author" content="x14n">
<link rel="canonical" href="https://XianCH.github.io/posts/tech/distributed/%E5%A4%9A%E7%BA%A7%E7%BC%93%E5%AD%98/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.css" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.js" onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://XianCH.github.io/img/favicon.icon">
<link rel="icon" type="image/png" sizes="16x16" href="https://XianCH.github.io/img/main.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://XianCH.github.io/img/main.png">
<link rel="apple-touch-icon" href="https://XianCH.github.io/img/main.png">
<link rel="mask-icon" href="https://XianCH.github.io/img/main.png">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="zh" href="https://XianCH.github.io/posts/tech/distributed/%E5%A4%9A%E7%BA%A7%E7%BC%93%E5%AD%98/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript>
<script defer src="https://unpkg.com/mermaid@8.8.1/dist/mermaid.min.js"></script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
<script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.3/dist/jquery.min.js"></script>



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = ""; 
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
<meta property="og:title" content="å¤šçº§ç¼“å­˜" />
<meta property="og:description" content="1.ä»€ä¹ˆæ˜¯å¤šçº§ç¼“å­˜ ä¼ ç»Ÿçš„ç¼“å­˜ç­–ç•¥ä¸€èˆ¬æ˜¯è¯·æ±‚åˆ°è¾¾Tomcatåï¼Œå…ˆæŸ¥è¯¢Redisï¼Œå¦‚æœæœªå‘½ä¸­åˆ™æŸ¥è¯¢æ•°æ®åº“ï¼Œå¦‚å›¾ï¼š å­˜åœ¨ä¸‹é¢çš„é—®é¢˜ï¼š â€¢è¯·æ±‚è¦ç»è¿‡Tomcatå¤„ç†ï¼ŒTomcatçš„æ€§èƒ½æˆä¸ºæ•´ä¸ªç³»ç»Ÿçš„ç“¶é¢ˆ â€¢Redisç¼“å­˜å¤±æ•ˆæ—¶ï¼Œä¼šå¯¹æ•°æ®åº“äº§ç”Ÿå†²å‡» å¤šçº§ç¼“å­˜å°±æ˜¯å……åˆ†åˆ©ç”¨è¯·æ±‚å¤„ç†çš„æ¯ä¸ªç¯èŠ‚ï¼Œåˆ†åˆ«æ·»" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://XianCH.github.io/posts/tech/distributed/%E5%A4%9A%E7%BA%A7%E7%BC%93%E5%AD%98/" />
<meta property="og:image" content="https://XianCH.github.io/postsImg/redistest.png" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-12-26T10:16:51+00:00" />
<meta property="article:modified_time" content="2023-09-22T10:16:51+00:00" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://XianCH.github.io/postsImg/redistest.png" />
<meta name="twitter:title" content="å¤šçº§ç¼“å­˜"/>
<meta name="twitter:description" content="1.ä»€ä¹ˆæ˜¯å¤šçº§ç¼“å­˜ ä¼ ç»Ÿçš„ç¼“å­˜ç­–ç•¥ä¸€èˆ¬æ˜¯è¯·æ±‚åˆ°è¾¾Tomcatåï¼Œå…ˆæŸ¥è¯¢Redisï¼Œå¦‚æœæœªå‘½ä¸­åˆ™æŸ¥è¯¢æ•°æ®åº“ï¼Œå¦‚å›¾ï¼š å­˜åœ¨ä¸‹é¢çš„é—®é¢˜ï¼š â€¢è¯·æ±‚è¦ç»è¿‡Tomcatå¤„ç†ï¼ŒTomcatçš„æ€§èƒ½æˆä¸ºæ•´ä¸ªç³»ç»Ÿçš„ç“¶é¢ˆ â€¢Redisç¼“å­˜å¤±æ•ˆæ—¶ï¼Œä¼šå¯¹æ•°æ®åº“äº§ç”Ÿå†²å‡» å¤šçº§ç¼“å­˜å°±æ˜¯å……åˆ†åˆ©ç”¨è¯·æ±‚å¤„ç†çš„æ¯ä¸ªç¯èŠ‚ï¼Œåˆ†åˆ«æ·»"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [

        {
          "@type": "ListItem",
          "position":  1 ,
          "name": "ğŸ“šæ–‡ç« ",
          "item": "https://XianCH.github.io/posts/"
        },

        {
          "@type": "ListItem",
          "position":  2 ,
          "name": "ğŸ‘¨ğŸ»â€ğŸ’» æŠ€æœ¯",
          "item": "https://XianCH.github.io/posts/tech/"
        }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "å¤šçº§ç¼“å­˜",
      "item": "https://XianCH.github.io/posts/tech/distributed/%E5%A4%9A%E7%BA%A7%E7%BC%93%E5%AD%98/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "å¤šçº§ç¼“å­˜",
  "name": "å¤šçº§ç¼“å­˜",
  "description": "1.ä»€ä¹ˆæ˜¯å¤šçº§ç¼“å­˜ ä¼ ç»Ÿçš„ç¼“å­˜ç­–ç•¥ä¸€èˆ¬æ˜¯è¯·æ±‚åˆ°è¾¾Tomcatåï¼Œå…ˆæŸ¥è¯¢Redisï¼Œå¦‚æœæœªå‘½ä¸­åˆ™æŸ¥è¯¢æ•°æ®åº“ï¼Œå¦‚å›¾ï¼š å­˜åœ¨ä¸‹é¢çš„é—®é¢˜ï¼š â€¢è¯·æ±‚è¦ç»è¿‡Tomcatå¤„ç†ï¼ŒTomcatçš„æ€§èƒ½æˆä¸ºæ•´ä¸ªç³»ç»Ÿçš„ç“¶é¢ˆ â€¢Redisç¼“å­˜å¤±æ•ˆæ—¶ï¼Œä¼šå¯¹æ•°æ®åº“äº§ç”Ÿå†²å‡» å¤šçº§ç¼“å­˜å°±æ˜¯å……åˆ†åˆ©ç”¨è¯·æ±‚å¤„ç†çš„æ¯ä¸ªç¯èŠ‚ï¼Œåˆ†åˆ«æ·»",
  "keywords": [
    ""
  ],
  "articleBody": "1.ä»€ä¹ˆæ˜¯å¤šçº§ç¼“å­˜ ä¼ ç»Ÿçš„ç¼“å­˜ç­–ç•¥ä¸€èˆ¬æ˜¯è¯·æ±‚åˆ°è¾¾Tomcatåï¼Œå…ˆæŸ¥è¯¢Redisï¼Œå¦‚æœæœªå‘½ä¸­åˆ™æŸ¥è¯¢æ•°æ®åº“ï¼Œå¦‚å›¾ï¼š\nå­˜åœ¨ä¸‹é¢çš„é—®é¢˜ï¼š\nâ€¢è¯·æ±‚è¦ç»è¿‡Tomcatå¤„ç†ï¼ŒTomcatçš„æ€§èƒ½æˆä¸ºæ•´ä¸ªç³»ç»Ÿçš„ç“¶é¢ˆ\nâ€¢Redisç¼“å­˜å¤±æ•ˆæ—¶ï¼Œä¼šå¯¹æ•°æ®åº“äº§ç”Ÿå†²å‡»\nå¤šçº§ç¼“å­˜å°±æ˜¯å……åˆ†åˆ©ç”¨è¯·æ±‚å¤„ç†çš„æ¯ä¸ªç¯èŠ‚ï¼Œåˆ†åˆ«æ·»åŠ ç¼“å­˜ï¼Œå‡è½»Tomcatå‹åŠ›ï¼Œæå‡æœåŠ¡æ€§èƒ½ï¼š\næµè§ˆå™¨è®¿é—®é™æ€èµ„æºæ—¶ï¼Œä¼˜å…ˆè¯»å–æµè§ˆå™¨æœ¬åœ°ç¼“å­˜ è®¿é—®éé™æ€èµ„æºï¼ˆajaxæŸ¥è¯¢æ•°æ®ï¼‰æ—¶ï¼Œè®¿é—®æœåŠ¡ç«¯ è¯·æ±‚åˆ°è¾¾Nginxåï¼Œä¼˜å…ˆè¯»å–Nginxæœ¬åœ°ç¼“å­˜ å¦‚æœNginxæœ¬åœ°ç¼“å­˜æœªå‘½ä¸­ï¼Œåˆ™å»ç›´æ¥æŸ¥è¯¢Redisï¼ˆä¸ç»è¿‡Tomcatï¼‰ å¦‚æœRedisæŸ¥è¯¢æœªå‘½ä¸­ï¼Œåˆ™æŸ¥è¯¢Tomcat è¯·æ±‚è¿›å…¥Tomcatåï¼Œä¼˜å…ˆæŸ¥è¯¢JVMè¿›ç¨‹ç¼“å­˜ å¦‚æœJVMè¿›ç¨‹ç¼“å­˜æœªå‘½ä¸­ï¼Œåˆ™æŸ¥è¯¢æ•°æ®åº“ åœ¨å¤šçº§ç¼“å­˜æ¶æ„ä¸­ï¼ŒNginxå†…éƒ¨éœ€è¦ç¼–å†™æœ¬åœ°ç¼“å­˜æŸ¥è¯¢ã€RedisæŸ¥è¯¢ã€TomcatæŸ¥è¯¢çš„ä¸šåŠ¡é€»è¾‘ï¼Œå› æ­¤è¿™æ ·çš„nginxæœåŠ¡ä¸å†æ˜¯ä¸€ä¸ªåå‘ä»£ç†æœåŠ¡å™¨ï¼Œè€Œæ˜¯ä¸€ä¸ªç¼–å†™ä¸šåŠ¡çš„WebæœåŠ¡å™¨äº†ã€‚\nå› æ­¤è¿™æ ·çš„ä¸šåŠ¡NginxæœåŠ¡ä¹Ÿéœ€è¦æ­å»ºé›†ç¾¤æ¥æé«˜å¹¶å‘ï¼Œå†æœ‰ä¸“é—¨çš„nginxæœåŠ¡æ¥åšåå‘ä»£ç†ï¼Œå¦‚å›¾ï¼š\nå¦å¤–ï¼Œæˆ‘ä»¬çš„TomcatæœåŠ¡å°†æ¥ä¹Ÿä¼šéƒ¨ç½²ä¸ºé›†ç¾¤æ¨¡å¼ï¼š\nå¯è§ï¼Œå¤šçº§ç¼“å­˜çš„å…³é”®æœ‰ä¸¤ä¸ªï¼š\nä¸€ä¸ªæ˜¯åœ¨nginxä¸­ç¼–å†™ä¸šåŠ¡ï¼Œå®ç°nginxæœ¬åœ°ç¼“å­˜ã€Redisã€Tomcatçš„æŸ¥è¯¢\nå¦ä¸€ä¸ªå°±æ˜¯åœ¨Tomcatä¸­å®ç°JVMè¿›ç¨‹ç¼“å­˜\nå…¶ä¸­Nginxç¼–ç¨‹åˆ™ä¼šç”¨åˆ°OpenRestyæ¡†æ¶ç»“åˆLuaè¿™æ ·çš„è¯­è¨€ã€‚\nè¿™ä¹Ÿæ˜¯ä»Šå¤©è¯¾ç¨‹çš„éš¾ç‚¹å’Œé‡ç‚¹ã€‚\n2.JVMè¿›ç¨‹ç¼“å­˜ ä¸ºäº†æ¼”ç¤ºå¤šçº§ç¼“å­˜çš„æ¡ˆä¾‹ï¼Œæˆ‘ä»¬å…ˆå‡†å¤‡ä¸€ä¸ªå•†å“æŸ¥è¯¢çš„ä¸šåŠ¡ã€‚\n2.1.å¯¼å…¥æ¡ˆä¾‹ å‚è€ƒè¯¾å‰èµ„æ–™çš„ï¼šã€Šæ¡ˆä¾‹å¯¼å…¥è¯´æ˜.mdã€‹\n2.2.åˆè¯†Caffeine ç¼“å­˜åœ¨æ—¥å¸¸å¼€å‘ä¸­å¯åŠ¨è‡³å…³é‡è¦çš„ä½œç”¨ï¼Œç”±äºæ˜¯å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œæ•°æ®çš„è¯»å–é€Ÿåº¦æ˜¯éå¸¸å¿«çš„ï¼Œèƒ½å¤§é‡å‡å°‘å¯¹æ•°æ®åº“çš„è®¿é—®ï¼Œå‡å°‘æ•°æ®åº“çš„å‹åŠ›ã€‚æˆ‘ä»¬æŠŠç¼“å­˜åˆ†ä¸ºä¸¤ç±»ï¼š\nåˆ†å¸ƒå¼ç¼“å­˜ï¼Œä¾‹å¦‚Redisï¼š ä¼˜ç‚¹ï¼šå­˜å‚¨å®¹é‡æ›´å¤§ã€å¯é æ€§æ›´å¥½ã€å¯ä»¥åœ¨é›†ç¾¤é—´å…±äº« ç¼ºç‚¹ï¼šè®¿é—®ç¼“å­˜æœ‰ç½‘ç»œå¼€é”€ åœºæ™¯ï¼šç¼“å­˜æ•°æ®é‡è¾ƒå¤§ã€å¯é æ€§è¦æ±‚è¾ƒé«˜ã€éœ€è¦åœ¨é›†ç¾¤é—´å…±äº« è¿›ç¨‹æœ¬åœ°ç¼“å­˜ï¼Œä¾‹å¦‚HashMapã€GuavaCacheï¼š ä¼˜ç‚¹ï¼šè¯»å–æœ¬åœ°å†…å­˜ï¼Œæ²¡æœ‰ç½‘ç»œå¼€é”€ï¼Œé€Ÿåº¦æ›´å¿« ç¼ºç‚¹ï¼šå­˜å‚¨å®¹é‡æœ‰é™ã€å¯é æ€§è¾ƒä½ã€æ— æ³•å…±äº« åœºæ™¯ï¼šæ€§èƒ½è¦æ±‚è¾ƒé«˜ï¼Œç¼“å­˜æ•°æ®é‡è¾ƒå° æˆ‘ä»¬ä»Šå¤©ä¼šåˆ©ç”¨Caffeineæ¡†æ¶æ¥å®ç°JVMè¿›ç¨‹ç¼“å­˜ã€‚\nCaffeineæ˜¯ä¸€ä¸ªåŸºäºJava8å¼€å‘çš„ï¼Œæä¾›äº†è¿‘ä¹æœ€ä½³å‘½ä¸­ç‡çš„é«˜æ€§èƒ½çš„æœ¬åœ°ç¼“å­˜åº“ã€‚ç›®å‰Springå†…éƒ¨çš„ç¼“å­˜ä½¿ç”¨çš„å°±æ˜¯Caffeineã€‚GitHubåœ°å€ï¼šhttps://github.com/ben-manes/caffeine\nCaffeineçš„æ€§èƒ½éå¸¸å¥½ï¼Œä¸‹å›¾æ˜¯å®˜æ–¹ç»™å‡ºçš„æ€§èƒ½å¯¹æ¯”ï¼š\nå¯ä»¥çœ‹åˆ°Caffeineçš„æ€§èƒ½é¥é¥é¢†å…ˆï¼\nç¼“å­˜ä½¿ç”¨çš„åŸºæœ¬APIï¼š\n@Test void testBasicOps() { // æ„å»ºcacheå¯¹è±¡ Cache\u003cString, String\u003e cache = Caffeine.newBuilder().build(); // å­˜æ•°æ® cache.put(\"gf\", \"è¿ªä¸½çƒ­å·´\"); // å–æ•°æ® String gf = cache.getIfPresent(\"gf\"); System.out.println(\"gf = \" + gf); // å–æ•°æ®ï¼ŒåŒ…å«ä¸¤ä¸ªå‚æ•°ï¼š // å‚æ•°ä¸€ï¼šç¼“å­˜çš„key // å‚æ•°äºŒï¼šLambdaè¡¨è¾¾å¼ï¼Œè¡¨è¾¾å¼å‚æ•°å°±æ˜¯ç¼“å­˜çš„keyï¼Œæ–¹æ³•ä½“æ˜¯æŸ¥è¯¢æ•°æ®åº“çš„é€»è¾‘ // ä¼˜å…ˆæ ¹æ®keyæŸ¥è¯¢JVMç¼“å­˜ï¼Œå¦‚æœæœªå‘½ä¸­ï¼Œåˆ™æ‰§è¡Œå‚æ•°äºŒçš„Lambdaè¡¨è¾¾å¼ String defaultGF = cache.get(\"defaultGF\", key -\u003e { // æ ¹æ®keyå»æ•°æ®åº“æŸ¥è¯¢æ•°æ® return \"æŸ³å²©\"; }); System.out.println(\"defaultGF = \" + defaultGF); } Caffeineæ—¢ç„¶æ˜¯ç¼“å­˜çš„ä¸€ç§ï¼Œè‚¯å®šéœ€è¦æœ‰ç¼“å­˜çš„æ¸…é™¤ç­–ç•¥ï¼Œä¸ç„¶çš„è¯å†…å­˜æ€»ä¼šæœ‰è€—å°½çš„æ—¶å€™ã€‚\nCaffeineæä¾›äº†ä¸‰ç§ç¼“å­˜é©±é€ç­–ç•¥ï¼š\nåŸºäºå®¹é‡ï¼šè®¾ç½®ç¼“å­˜çš„æ•°é‡ä¸Šé™\n// åˆ›å»ºç¼“å­˜å¯¹è±¡ Cache\u003cString, String\u003e cache = Caffeine.newBuilder() .maximumSize(1) // è®¾ç½®ç¼“å­˜å¤§å°ä¸Šé™ä¸º 1 .build(); åŸºäºæ—¶é—´ï¼šè®¾ç½®ç¼“å­˜çš„æœ‰æ•ˆæ—¶é—´\n// åˆ›å»ºç¼“å­˜å¯¹è±¡ Cache\u003cString, String\u003e cache = Caffeine.newBuilder() // è®¾ç½®ç¼“å­˜æœ‰æ•ˆæœŸä¸º 10 ç§’ï¼Œä»æœ€åä¸€æ¬¡å†™å…¥å¼€å§‹è®¡æ—¶ .expireAfterWrite(Duration.ofSeconds(10)) .build(); åŸºäºå¼•ç”¨ï¼šè®¾ç½®ç¼“å­˜ä¸ºè½¯å¼•ç”¨æˆ–å¼±å¼•ç”¨ï¼Œåˆ©ç”¨GCæ¥å›æ”¶ç¼“å­˜æ•°æ®ã€‚æ€§èƒ½è¾ƒå·®ï¼Œä¸å»ºè®®ä½¿ç”¨ã€‚\næ³¨æ„ï¼šåœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œå½“ä¸€ä¸ªç¼“å­˜å…ƒç´ è¿‡æœŸçš„æ—¶å€™ï¼ŒCaffeineä¸ä¼šè‡ªåŠ¨ç«‹å³å°†å…¶æ¸…ç†å’Œé©±é€ã€‚è€Œæ˜¯åœ¨ä¸€æ¬¡è¯»æˆ–å†™æ“ä½œåï¼Œæˆ–è€…åœ¨ç©ºé—²æ—¶é—´å®Œæˆå¯¹å¤±æ•ˆæ•°æ®çš„é©±é€ã€‚\n2.3.å®ç°JVMè¿›ç¨‹ç¼“å­˜ 2.3.1.éœ€æ±‚ åˆ©ç”¨Caffeineå®ç°ä¸‹åˆ—éœ€æ±‚ï¼š\nç»™æ ¹æ®idæŸ¥è¯¢å•†å“çš„ä¸šåŠ¡æ·»åŠ ç¼“å­˜ï¼Œç¼“å­˜æœªå‘½ä¸­æ—¶æŸ¥è¯¢æ•°æ®åº“ ç»™æ ¹æ®idæŸ¥è¯¢å•†å“åº“å­˜çš„ä¸šåŠ¡æ·»åŠ ç¼“å­˜ï¼Œç¼“å­˜æœªå‘½ä¸­æ—¶æŸ¥è¯¢æ•°æ®åº“ ç¼“å­˜åˆå§‹å¤§å°ä¸º100 ç¼“å­˜ä¸Šé™ä¸º10000 2.3.2.å®ç° é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦å®šä¹‰ä¸¤ä¸ªCaffeineçš„ç¼“å­˜å¯¹è±¡ï¼Œåˆ†åˆ«ä¿å­˜å•†å“ã€åº“å­˜çš„ç¼“å­˜æ•°æ®ã€‚\nåœ¨item-serviceçš„com.heima.item.configåŒ…ä¸‹å®šä¹‰CaffeineConfigç±»ï¼š\npackage com.heima.item.config; import com.github.benmanes.caffeine.cache.Cache; import com.github.benmanes.caffeine.cache.Caffeine; import com.heima.item.pojo.Item; import com.heima.item.pojo.ItemStock; import org.springframework.context.annotation.Bean; import org.springframework.context.annotation.Configuration; @Configuration public class CaffeineConfig { @Bean public Cache\u003cLong, Item\u003e itemCache(){ return Caffeine.newBuilder() .initialCapacity(100) .maximumSize(10_000) .build(); } @Bean public Cache\u003cLong, ItemStock\u003e stockCache(){ return Caffeine.newBuilder() .initialCapacity(100) .maximumSize(10_000) .build(); } } ç„¶åï¼Œä¿®æ”¹item-serviceä¸­çš„com.heima.item.webåŒ…ä¸‹çš„ItemControllerç±»ï¼Œæ·»åŠ ç¼“å­˜é€»è¾‘ï¼š\n@RestController @RequestMapping(\"item\") public class ItemController { @Autowired private IItemService itemService; @Autowired private IItemStockService stockService; @Autowired private Cache\u003cLong, Item\u003e itemCache; @Autowired private Cache\u003cLong, ItemStock\u003e stockCache; // ...å…¶å®ƒç•¥ @GetMapping(\"/{id}\") public Item findById(@PathVariable(\"id\") Long id) { return itemCache.get(id, key -\u003e itemService.query() .ne(\"status\", 3).eq(\"id\", key) .one() ); } @GetMapping(\"/stock/{id}\") public ItemStock findStockById(@PathVariable(\"id\") Long id) { return stockCache.get(id, key -\u003e stockService.getById(key)); } } 3.Luaè¯­æ³•å…¥é—¨ Nginxç¼–ç¨‹éœ€è¦ç”¨åˆ°Luaè¯­è¨€ï¼Œå› æ­¤æˆ‘ä»¬å¿…é¡»å…ˆå…¥é—¨Luaçš„åŸºæœ¬è¯­æ³•ã€‚\n3.1.åˆè¯†Lua Lua æ˜¯ä¸€ç§è½»é‡å°å·§çš„è„šæœ¬è¯­è¨€ï¼Œç”¨æ ‡å‡†Cè¯­è¨€ç¼–å†™å¹¶ä»¥æºä»£ç å½¢å¼å¼€æ”¾ï¼Œ å…¶è®¾è®¡ç›®çš„æ˜¯ä¸ºäº†åµŒå…¥åº”ç”¨ç¨‹åºä¸­ï¼Œä»è€Œä¸ºåº”ç”¨ç¨‹åºæä¾›çµæ´»çš„æ‰©å±•å’Œå®šåˆ¶åŠŸèƒ½ã€‚å®˜ç½‘ï¼šhttps://www.lua.org/\nLuaç»å¸¸åµŒå…¥åˆ°Cè¯­è¨€å¼€å‘çš„ç¨‹åºä¸­ï¼Œä¾‹å¦‚æ¸¸æˆå¼€å‘ã€æ¸¸æˆæ’ä»¶ç­‰ã€‚\nNginxæœ¬èº«ä¹Ÿæ˜¯Cè¯­è¨€å¼€å‘ï¼Œå› æ­¤ä¹Ÿå…è®¸åŸºäºLuaåšæ‹“å±•ã€‚\n3.1.HelloWorld CentOS7é»˜è®¤å·²ç»å®‰è£…äº†Luaè¯­è¨€ç¯å¢ƒï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥è¿è¡ŒLuaä»£ç ã€‚\n1ï¼‰åœ¨Linuxè™šæ‹Ÿæœºçš„ä»»æ„ç›®å½•ä¸‹ï¼Œæ–°å»ºä¸€ä¸ªhello.luaæ–‡ä»¶\n2ï¼‰æ·»åŠ ä¸‹é¢çš„å†…å®¹\nprint(\"Hello World!\") 3ï¼‰è¿è¡Œ\n3.2.å˜é‡å’Œå¾ªç¯ å­¦ä¹ ä»»ä½•è¯­è¨€å¿…ç„¶ç¦»ä¸å¼€å˜é‡ï¼Œè€Œå˜é‡çš„å£°æ˜å¿…é¡»å…ˆçŸ¥é“æ•°æ®çš„ç±»å‹ã€‚\n3.2.1.Luaçš„æ•°æ®ç±»å‹ Luaä¸­æ”¯æŒçš„å¸¸è§æ•°æ®ç±»å‹åŒ…æ‹¬ï¼š\nå¦å¤–ï¼ŒLuaæä¾›äº†type()å‡½æ•°æ¥åˆ¤æ–­ä¸€ä¸ªå˜é‡çš„æ•°æ®ç±»å‹ï¼š\n3.2.2.å£°æ˜å˜é‡ Luaå£°æ˜å˜é‡çš„æ—¶å€™æ— éœ€æŒ‡å®šæ•°æ®ç±»å‹ï¼Œè€Œæ˜¯ç”¨localæ¥å£°æ˜å˜é‡ä¸ºå±€éƒ¨å˜é‡ï¼š\n-- å£°æ˜å­—ç¬¦ä¸²ï¼Œå¯ä»¥ç”¨å•å¼•å·æˆ–åŒå¼•å·ï¼Œ local str = 'hello' -- å­—ç¬¦ä¸²æ‹¼æ¥å¯ä»¥ä½¿ç”¨ .. local str2 = 'hello' .. 'world' -- å£°æ˜æ•°å­— local num = 21 -- å£°æ˜å¸ƒå°”ç±»å‹ local flag = true Luaä¸­çš„tableç±»å‹æ—¢å¯ä»¥ä½œä¸ºæ•°ç»„ï¼Œåˆå¯ä»¥ä½œä¸ºJavaä¸­çš„mapæ¥ä½¿ç”¨ã€‚æ•°ç»„å°±æ˜¯ç‰¹æ®Šçš„tableï¼Œkeyæ˜¯æ•°ç»„è§’æ ‡è€Œå·²ï¼š\n-- å£°æ˜æ•°ç»„ ï¼Œkeyä¸ºè§’æ ‡çš„ table local arr = {'java', 'python', 'lua'} -- å£°æ˜tableï¼Œç±»ä¼¼javaçš„map local map = {name='Jack', age=21} Luaä¸­çš„æ•°ç»„è§’æ ‡æ˜¯ä»1å¼€å§‹ï¼Œè®¿é—®çš„æ—¶å€™ä¸Javaä¸­ç±»ä¼¼ï¼š\n-- è®¿é—®æ•°ç»„ï¼Œluaæ•°ç»„çš„è§’æ ‡ä»1å¼€å§‹ print(arr[1]) Luaä¸­çš„tableå¯ä»¥ç”¨keyæ¥è®¿é—®ï¼š\n-- è®¿é—®table print(map['name']) print(map.name) 3.2.3.å¾ªç¯ å¯¹äºtableï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨forå¾ªç¯æ¥éå†ã€‚ä¸è¿‡æ•°ç»„å’Œæ™®é€štableéå†ç•¥æœ‰å·®å¼‚ã€‚\néå†æ•°ç»„ï¼š\n-- å£°æ˜æ•°ç»„ keyä¸ºç´¢å¼•çš„ table local arr = {'java', 'python', 'lua'} -- éå†æ•°ç»„ for index,value in ipairs(arr) do print(index, value) end éå†æ™®é€štable\n-- å£°æ˜mapï¼Œä¹Ÿå°±æ˜¯table local map = {name='Jack', age=21} -- éå†table for key,value in pairs(map) do print(key, value) end 3.3.æ¡ä»¶æ§åˆ¶ã€å‡½æ•° Luaä¸­çš„æ¡ä»¶æ§åˆ¶å’Œå‡½æ•°å£°æ˜ä¸Javaç±»ä¼¼ã€‚\n3.3.1.å‡½æ•° å®šä¹‰å‡½æ•°çš„è¯­æ³•ï¼š\nfunction å‡½æ•°å( argument1, argument2..., argumentn) -- å‡½æ•°ä½“ return è¿”å›å€¼ end ä¾‹å¦‚ï¼Œå®šä¹‰ä¸€ä¸ªå‡½æ•°ï¼Œç”¨æ¥æ‰“å°æ•°ç»„ï¼š\nfunction printArr(arr) for index, value in ipairs(arr) do print(value) end end 3.3.2.æ¡ä»¶æ§åˆ¶ ç±»ä¼¼Javaçš„æ¡ä»¶æ§åˆ¶ï¼Œä¾‹å¦‚ifã€elseè¯­æ³•ï¼š\nif(å¸ƒå°”è¡¨è¾¾å¼) then --[ å¸ƒå°”è¡¨è¾¾å¼ä¸º true æ—¶æ‰§è¡Œè¯¥è¯­å¥å— --] else --[ å¸ƒå°”è¡¨è¾¾å¼ä¸º false æ—¶æ‰§è¡Œè¯¥è¯­å¥å— --] end ä¸javaä¸åŒï¼Œå¸ƒå°”è¡¨è¾¾å¼ä¸­çš„é€»è¾‘è¿ç®—æ˜¯åŸºäºè‹±æ–‡å•è¯ï¼š\n3.3.3.æ¡ˆä¾‹ éœ€æ±‚ï¼šè‡ªå®šä¹‰ä¸€ä¸ªå‡½æ•°ï¼Œå¯ä»¥æ‰“å°tableï¼Œå½“å‚æ•°ä¸ºnilæ—¶ï¼Œæ‰“å°é”™è¯¯ä¿¡æ¯\nfunction printArr(arr) if not arr then print('æ•°ç»„ä¸èƒ½ä¸ºç©ºï¼') end for index, value in ipairs(arr) do print(value) end end 4.å®ç°å¤šçº§ç¼“å­˜ å¤šçº§ç¼“å­˜çš„å®ç°ç¦»ä¸å¼€Nginxç¼–ç¨‹ï¼Œè€ŒNginxç¼–ç¨‹åˆç¦»ä¸å¼€OpenRestyã€‚\n4.1.å®‰è£…OpenResty OpenRestyÂ® æ˜¯ä¸€ä¸ªåŸºäº Nginxçš„é«˜æ€§èƒ½ Web å¹³å°ï¼Œç”¨äºæ–¹ä¾¿åœ°æ­å»ºèƒ½å¤Ÿå¤„ç†è¶…é«˜å¹¶å‘ã€æ‰©å±•æ€§æé«˜çš„åŠ¨æ€ Web åº”ç”¨ã€Web æœåŠ¡å’ŒåŠ¨æ€ç½‘å…³ã€‚å…·å¤‡ä¸‹åˆ—ç‰¹ç‚¹ï¼š\nå…·å¤‡Nginxçš„å®Œæ•´åŠŸèƒ½ åŸºäºLuaè¯­è¨€è¿›è¡Œæ‰©å±•ï¼Œé›†æˆäº†å¤§é‡ç²¾è‰¯çš„ Lua åº“ã€ç¬¬ä¸‰æ–¹æ¨¡å— å…è®¸ä½¿ç”¨Luaè‡ªå®šä¹‰ä¸šåŠ¡é€»è¾‘ã€è‡ªå®šä¹‰åº“ å®˜æ–¹ç½‘ç«™ï¼š https://openresty.org/cn/\nå®‰è£…Luaå¯ä»¥å‚è€ƒè¯¾å‰èµ„æ–™æä¾›çš„ã€Šå®‰è£…OpenResty.mdã€‹ï¼š\n4.2.OpenRestyå¿«é€Ÿå…¥é—¨ æˆ‘ä»¬å¸Œæœ›è¾¾åˆ°çš„å¤šçº§ç¼“å­˜æ¶æ„å¦‚å›¾ï¼š\nå…¶ä¸­ï¼š\nwindowsä¸Šçš„nginxç”¨æ¥åšåå‘ä»£ç†æœåŠ¡ï¼Œå°†å‰ç«¯çš„æŸ¥è¯¢å•†å“çš„ajaxè¯·æ±‚ä»£ç†åˆ°OpenRestyé›†ç¾¤\nOpenRestyé›†ç¾¤ç”¨æ¥ç¼–å†™å¤šçº§ç¼“å­˜ä¸šåŠ¡\n4.2.1.åå‘ä»£ç†æµç¨‹ ç°åœ¨ï¼Œå•†å“è¯¦æƒ…é¡µä½¿ç”¨çš„æ˜¯å‡çš„å•†å“æ•°æ®ã€‚ä¸è¿‡åœ¨æµè§ˆå™¨ä¸­ï¼Œå¯ä»¥çœ‹åˆ°é¡µé¢æœ‰å‘èµ·ajaxè¯·æ±‚æŸ¥è¯¢çœŸå®å•†å“æ•°æ®ã€‚\nè¿™ä¸ªè¯·æ±‚å¦‚ä¸‹ï¼š\nè¯·æ±‚åœ°å€æ˜¯localhostï¼Œç«¯å£æ˜¯80ï¼Œå°±è¢«windowsä¸Šå®‰è£…çš„NginxæœåŠ¡ç»™æ¥æ”¶åˆ°äº†ã€‚ç„¶åä»£ç†ç»™äº†OpenRestyé›†ç¾¤ï¼š\næˆ‘ä»¬éœ€è¦åœ¨OpenRestyä¸­ç¼–å†™ä¸šåŠ¡ï¼ŒæŸ¥è¯¢å•†å“æ•°æ®å¹¶è¿”å›åˆ°æµè§ˆå™¨ã€‚\nä½†æ˜¯è¿™æ¬¡ï¼Œæˆ‘ä»¬å…ˆåœ¨OpenRestyæ¥æ”¶è¯·æ±‚ï¼Œè¿”å›å‡çš„å•†å“æ•°æ®ã€‚\n4.2.2.OpenRestyç›‘å¬è¯·æ±‚ OpenRestyçš„å¾ˆå¤šåŠŸèƒ½éƒ½ä¾èµ–äºå…¶ç›®å½•ä¸‹çš„Luaåº“ï¼Œéœ€è¦åœ¨nginx.confä¸­æŒ‡å®šä¾èµ–åº“çš„ç›®å½•ï¼Œå¹¶å¯¼å…¥ä¾èµ–ï¼š\n1ï¼‰æ·»åŠ å¯¹OpenRestyçš„Luaæ¨¡å—çš„åŠ è½½\nä¿®æ”¹/usr/local/openresty/nginx/conf/nginx.confæ–‡ä»¶ï¼Œåœ¨å…¶ä¸­çš„httpä¸‹é¢ï¼Œæ·»åŠ ä¸‹é¢ä»£ç ï¼š\n#lua æ¨¡å— lua_package_path \"/usr/local/openresty/lualib/?.lua;;\"; #cæ¨¡å— lua_package_cpath \"/usr/local/openresty/lualib/?.so;;\"; 2ï¼‰ç›‘å¬/api/itemè·¯å¾„\nä¿®æ”¹/usr/local/openresty/nginx/conf/nginx.confæ–‡ä»¶ï¼Œåœ¨nginx.confçš„serverä¸‹é¢ï¼Œæ·»åŠ å¯¹/api/itemè¿™ä¸ªè·¯å¾„çš„ç›‘å¬ï¼š\nlocation /api/item { # é»˜è®¤çš„å“åº”ç±»å‹ default_type application/json; # å“åº”ç»“æœç”±lua/item.luaæ–‡ä»¶æ¥å†³å®š content_by_lua_file lua/item.lua; } è¿™ä¸ªç›‘å¬ï¼Œå°±ç±»ä¼¼äºSpringMVCä¸­çš„@GetMapping(\"/api/item\")åšè·¯å¾„æ˜ å°„ã€‚\nè€Œcontent_by_lua_file lua/item.luaåˆ™ç›¸å½“äºè°ƒç”¨item.luaè¿™ä¸ªæ–‡ä»¶ï¼Œæ‰§è¡Œå…¶ä¸­çš„ä¸šåŠ¡ï¼ŒæŠŠç»“æœè¿”å›ç»™ç”¨æˆ·ã€‚ç›¸å½“äºjavaä¸­è°ƒç”¨serviceã€‚\n4.2.3.ç¼–å†™item.lua 1ï¼‰åœ¨/usr/loca/openresty/nginxç›®å½•åˆ›å»ºæ–‡ä»¶å¤¹ï¼šlua\n2ï¼‰åœ¨/usr/loca/openresty/nginx/luaæ–‡ä»¶å¤¹ä¸‹ï¼Œæ–°å»ºæ–‡ä»¶ï¼šitem.lua\n3ï¼‰ç¼–å†™item.luaï¼Œè¿”å›å‡æ•°æ®\nitem.luaä¸­ï¼Œåˆ©ç”¨ngx.say()å‡½æ•°è¿”å›æ•°æ®åˆ°Responseä¸­\nngx.say('{\"id\":10001,\"name\":\"SALSA AIR\",\"title\":\"RIMOWA 21å¯¸æ‰˜è¿ç®±æ‹‰æ†ç®± SALSA AIRç³»åˆ—æœç»¿è‰² 820.70.36.4\",\"price\":17900,\"image\":\"https://m.360buyimg.com/mobilecms/s720x720_jfs/t6934/364/1195375010/84676/e9f2c55f/597ece38N0ddcbc77.jpg!q70.jpg.webp\",\"category\":\"æ‹‰æ†ç®±\",\"brand\":\"RIMOWA\",\"spec\":\"\",\"status\":1,\"createTime\":\"2019-04-30T16:00:00.000+00:00\",\"updateTime\":\"2019-04-30T16:00:00.000+00:00\",\"stock\":2999,\"sold\":31290}') 4ï¼‰é‡æ–°åŠ è½½é…ç½®\nnginx -s reload åˆ·æ–°å•†å“é¡µé¢ï¼šhttp://localhost/item.html?id=1001ï¼Œå³å¯çœ‹åˆ°æ•ˆæœï¼š\n4.3.è¯·æ±‚å‚æ•°å¤„ç† ä¸Šä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬åœ¨OpenRestyæ¥æ”¶å‰ç«¯è¯·æ±‚ï¼Œä½†æ˜¯è¿”å›çš„æ˜¯å‡æ•°æ®ã€‚\nè¦è¿”å›çœŸå®æ•°æ®ï¼Œå¿…é¡»æ ¹æ®å‰ç«¯ä¼ é€’æ¥çš„å•†å“idï¼ŒæŸ¥è¯¢å•†å“ä¿¡æ¯æ‰å¯ä»¥ã€‚\né‚£ä¹ˆå¦‚ä½•è·å–å‰ç«¯ä¼ é€’çš„å•†å“å‚æ•°å‘¢ï¼Ÿ\n4.3.1.è·å–å‚æ•°çš„API OpenRestyä¸­æä¾›äº†ä¸€äº›APIç”¨æ¥è·å–ä¸åŒç±»å‹çš„å‰ç«¯è¯·æ±‚å‚æ•°ï¼š\n4.3.2.è·å–å‚æ•°å¹¶è¿”å› åœ¨å‰ç«¯å‘èµ·çš„ajaxè¯·æ±‚å¦‚å›¾ï¼š\nå¯ä»¥çœ‹åˆ°å•†å“idæ˜¯ä»¥è·¯å¾„å ä½ç¬¦æ–¹å¼ä¼ é€’çš„ï¼Œå› æ­¤å¯ä»¥åˆ©ç”¨æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…çš„æ–¹å¼æ¥è·å–ID\n1ï¼‰è·å–å•†å“id\nä¿®æ”¹/usr/loca/openresty/nginx/nginx.confæ–‡ä»¶ä¸­ç›‘å¬/api/itemçš„ä»£ç ï¼Œåˆ©ç”¨æ­£åˆ™è¡¨è¾¾å¼è·å–IDï¼š\nlocation ~ /api/item/(\\d+) { # é»˜è®¤çš„å“åº”ç±»å‹ default_type application/json; # å“åº”ç»“æœç”±lua/item.luaæ–‡ä»¶æ¥å†³å®š content_by_lua_file lua/item.lua; } 2ï¼‰æ‹¼æ¥IDå¹¶è¿”å›\nä¿®æ”¹/usr/loca/openresty/nginx/lua/item.luaæ–‡ä»¶ï¼Œè·å–idå¹¶æ‹¼æ¥åˆ°ç»“æœä¸­è¿”å›ï¼š\n-- è·å–å•†å“id local id = ngx.var[1] -- æ‹¼æ¥å¹¶è¿”å› ngx.say('{\"id\":' .. id .. ',\"name\":\"SALSA AIR\",\"title\":\"RIMOWA 21å¯¸æ‰˜è¿ç®±æ‹‰æ†ç®± SALSA AIRç³»åˆ—æœç»¿è‰² 820.70.36.4\",\"price\":17900,\"image\":\"https://m.360buyimg.com/mobilecms/s720x720_jfs/t6934/364/1195375010/84676/e9f2c55f/597ece38N0ddcbc77.jpg!q70.jpg.webp\",\"category\":\"æ‹‰æ†ç®±\",\"brand\":\"RIMOWA\",\"spec\":\"\",\"status\":1,\"createTime\":\"2019-04-30T16:00:00.000+00:00\",\"updateTime\":\"2019-04-30T16:00:00.000+00:00\",\"stock\":2999,\"sold\":31290}') 3ï¼‰é‡æ–°åŠ è½½å¹¶æµ‹è¯•\nè¿è¡Œå‘½ä»¤ä»¥é‡æ–°åŠ è½½OpenRestyé…ç½®ï¼š\nnginx -s reload åˆ·æ–°é¡µé¢å¯ä»¥çœ‹åˆ°ç»“æœä¸­å·²ç»å¸¦ä¸Šäº†IDï¼š\n4.4.æŸ¥è¯¢Tomcat æ‹¿åˆ°å•†å“IDåï¼Œæœ¬åº”å»ç¼“å­˜ä¸­æŸ¥è¯¢å•†å“ä¿¡æ¯ï¼Œä¸è¿‡ç›®å‰æˆ‘ä»¬è¿˜æœªå»ºç«‹nginxã€redisç¼“å­˜ã€‚å› æ­¤ï¼Œè¿™é‡Œæˆ‘ä»¬å…ˆæ ¹æ®å•†å“idå»tomcatæŸ¥è¯¢å•†å“ä¿¡æ¯ã€‚æˆ‘ä»¬å®ç°å¦‚å›¾éƒ¨åˆ†ï¼š\néœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬çš„OpenRestyæ˜¯åœ¨è™šæ‹Ÿæœºï¼ŒTomcatæ˜¯åœ¨Windowsç”µè„‘ä¸Šã€‚ä¸¤è€…IPä¸€å®šä¸è¦æé”™äº†ã€‚\n4.4.1.å‘é€httpè¯·æ±‚çš„API nginxæä¾›äº†å†…éƒ¨APIç”¨ä»¥å‘é€httpè¯·æ±‚ï¼š\nlocal resp = ngx.location.capture(\"/path\",{ method = ngx.HTTP_GET, -- è¯·æ±‚æ–¹å¼ args = {a=1,b=2}, -- getæ–¹å¼ä¼ å‚æ•° }) è¿”å›çš„å“åº”å†…å®¹åŒ…æ‹¬ï¼š\nresp.statusï¼šå“åº”çŠ¶æ€ç  resp.headerï¼šå“åº”å¤´ï¼Œæ˜¯ä¸€ä¸ªtable resp.bodyï¼šå“åº”ä½“ï¼Œå°±æ˜¯å“åº”æ•°æ® æ³¨æ„ï¼šè¿™é‡Œçš„pathæ˜¯è·¯å¾„ï¼Œå¹¶ä¸åŒ…å«IPå’Œç«¯å£ã€‚è¿™ä¸ªè¯·æ±‚ä¼šè¢«nginxå†…éƒ¨çš„serverç›‘å¬å¹¶å¤„ç†ã€‚\nä½†æ˜¯æˆ‘ä»¬å¸Œæœ›è¿™ä¸ªè¯·æ±‚å‘é€åˆ°TomcatæœåŠ¡å™¨ï¼Œæ‰€ä»¥è¿˜éœ€è¦ç¼–å†™ä¸€ä¸ªserveræ¥å¯¹è¿™ä¸ªè·¯å¾„åšåå‘ä»£ç†ï¼š\nlocation /path { # è¿™é‡Œæ˜¯windowsç”µè„‘çš„ipå’ŒJavaæœåŠ¡ç«¯å£ï¼Œéœ€è¦ç¡®ä¿windowsé˜²ç«å¢™å¤„äºå…³é—­çŠ¶æ€ proxy_pass http://192.168.150.1:8081; } åŸç†å¦‚å›¾ï¼š\n4.4.2.å°è£…httpå·¥å…· ä¸‹é¢ï¼Œæˆ‘ä»¬å°è£…ä¸€ä¸ªå‘é€Httpè¯·æ±‚çš„å·¥å…·ï¼ŒåŸºäºngx.location.captureæ¥å®ç°æŸ¥è¯¢tomcatã€‚\n1ï¼‰æ·»åŠ åå‘ä»£ç†ï¼Œåˆ°windowsçš„JavaæœåŠ¡\nå› ä¸ºitem-serviceä¸­çš„æ¥å£éƒ½æ˜¯/itemå¼€å¤´ï¼Œæ‰€ä»¥æˆ‘ä»¬ç›‘å¬/itemè·¯å¾„ï¼Œä»£ç†åˆ°windowsä¸Šçš„tomcatæœåŠ¡ã€‚\nä¿®æ”¹ /usr/local/openresty/nginx/conf/nginx.confæ–‡ä»¶ï¼Œæ·»åŠ ä¸€ä¸ªlocationï¼š\nlocation /item { proxy_pass http://192.168.150.1:8081; } ä»¥åï¼Œåªè¦æˆ‘ä»¬è°ƒç”¨ngx.location.capture(\"/item\")ï¼Œå°±ä¸€å®šèƒ½å‘é€è¯·æ±‚åˆ°windowsçš„tomcatæœåŠ¡ã€‚\n2ï¼‰å°è£…å·¥å…·ç±»\nä¹‹å‰æˆ‘ä»¬è¯´è¿‡ï¼ŒOpenRestyå¯åŠ¨æ—¶ä¼šåŠ è½½ä»¥ä¸‹ä¸¤ä¸ªç›®å½•ä¸­çš„å·¥å…·æ–‡ä»¶ï¼š\næ‰€ä»¥ï¼Œè‡ªå®šä¹‰çš„httpå·¥å…·ä¹Ÿéœ€è¦æ”¾åˆ°è¿™ä¸ªç›®å½•ä¸‹ã€‚\nåœ¨/usr/local/openresty/lualibç›®å½•ä¸‹ï¼Œæ–°å»ºä¸€ä¸ªcommon.luaæ–‡ä»¶ï¼š\nvi /usr/local/openresty/lualib/common.lua å†…å®¹å¦‚ä¸‹:\n-- å°è£…å‡½æ•°ï¼Œå‘é€httpè¯·æ±‚ï¼Œå¹¶è§£æå“åº” local function read_http(path, params) local resp = ngx.location.capture(path,{ method = ngx.HTTP_GET, args = params, }) if not resp then -- è®°å½•é”™è¯¯ä¿¡æ¯ï¼Œè¿”å›404 ngx.log(ngx.ERR, \"httpè¯·æ±‚æŸ¥è¯¢å¤±è´¥, path: \", path , \", args: \", args) ngx.exit(404) end return resp.body end -- å°†æ–¹æ³•å¯¼å‡º local _M = { read_http = read_http } return _M è¿™ä¸ªå·¥å…·å°†read_httpå‡½æ•°å°è£…åˆ°_Mè¿™ä¸ªtableç±»å‹çš„å˜é‡ä¸­ï¼Œå¹¶ä¸”è¿”å›ï¼Œè¿™ç±»ä¼¼äºå¯¼å‡ºã€‚\nä½¿ç”¨çš„æ—¶å€™ï¼Œå¯ä»¥åˆ©ç”¨require('common')æ¥å¯¼å…¥è¯¥å‡½æ•°åº“ï¼Œè¿™é‡Œçš„commonæ˜¯å‡½æ•°åº“çš„æ–‡ä»¶åã€‚\n3ï¼‰å®ç°å•†å“æŸ¥è¯¢\næœ€åï¼Œæˆ‘ä»¬ä¿®æ”¹/usr/local/openresty/lua/item.luaæ–‡ä»¶ï¼Œåˆ©ç”¨åˆšåˆšå°è£…çš„å‡½æ•°åº“å®ç°å¯¹tomcatçš„æŸ¥è¯¢ï¼š\n-- å¼•å…¥è‡ªå®šä¹‰commonå·¥å…·æ¨¡å—ï¼Œè¿”å›å€¼æ˜¯commonä¸­è¿”å›çš„ _M local common = require(\"common\") -- ä» commonä¸­è·å–read_httpè¿™ä¸ªå‡½æ•° local read_http = common.read_http -- è·å–è·¯å¾„å‚æ•° local id = ngx.var[1] -- æ ¹æ®idæŸ¥è¯¢å•†å“ local itemJSON = read_http(\"/item/\".. id, nil) -- æ ¹æ®idæŸ¥è¯¢å•†å“åº“å­˜ local itemStockJSON = read_http(\"/item/stock/\".. id, nil) è¿™é‡ŒæŸ¥è¯¢åˆ°çš„ç»“æœæ˜¯jsonå­—ç¬¦ä¸²ï¼Œå¹¶ä¸”åŒ…å«å•†å“ã€åº“å­˜ä¸¤ä¸ªjsonå­—ç¬¦ä¸²ï¼Œé¡µé¢æœ€ç»ˆéœ€è¦çš„æ˜¯æŠŠä¸¤ä¸ªjsonæ‹¼æ¥ä¸ºä¸€ä¸ªjsonï¼š\nè¿™å°±éœ€è¦æˆ‘ä»¬å…ˆæŠŠJSONå˜ä¸ºluaçš„tableï¼Œå®Œæˆæ•°æ®æ•´åˆåï¼Œå†è½¬ä¸ºJSONã€‚\n4.4.3.CJSONå·¥å…·ç±» OpenRestyæä¾›äº†ä¸€ä¸ªcjsonçš„æ¨¡å—ç”¨æ¥å¤„ç†JSONçš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚\nå®˜æ–¹åœ°å€ï¼š https://github.com/openresty/lua-cjson/\n1ï¼‰å¼•å…¥cjsonæ¨¡å—ï¼š\nlocal cjson = require \"cjson\" 2ï¼‰åºåˆ—åŒ–ï¼š\nlocal obj = { name = 'jack', age = 21 } -- æŠŠ table åºåˆ—åŒ–ä¸º json local json = cjson.encode(obj) 3ï¼‰ååºåˆ—åŒ–ï¼š\nlocal json = '{\"name\": \"jack\", \"age\": 21}' -- ååºåˆ—åŒ– jsonä¸º table local obj = cjson.decode(json); print(obj.name) 4.4.4.å®ç°TomcatæŸ¥è¯¢ ä¸‹é¢ï¼Œæˆ‘ä»¬ä¿®æ”¹ä¹‹å‰çš„item.luaä¸­çš„ä¸šåŠ¡ï¼Œæ·»åŠ jsonå¤„ç†åŠŸèƒ½ï¼š\n-- å¯¼å…¥commonå‡½æ•°åº“ local common = require('common') local read_http = common.read_http -- å¯¼å…¥cjsonåº“ local cjson = require('cjson') -- è·å–è·¯å¾„å‚æ•° local id = ngx.var[1] -- æ ¹æ®idæŸ¥è¯¢å•†å“ local itemJSON = read_http(\"/item/\".. id, nil) -- æ ¹æ®idæŸ¥è¯¢å•†å“åº“å­˜ local itemStockJSON = read_http(\"/item/stock/\".. id, nil) -- JSONè½¬åŒ–ä¸ºluaçš„table local item = cjson.decode(itemJSON) local stock = cjson.decode(stockJSON) -- ç»„åˆæ•°æ® item.stock = stock.stock item.sold = stock.sold -- æŠŠitemåºåˆ—åŒ–ä¸ºjson è¿”å›ç»“æœ ngx.say(cjson.encode(item)) 4.4.5.åŸºäºIDè´Ÿè½½å‡è¡¡ åˆšæ‰çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬çš„tomcatæ˜¯å•æœºéƒ¨ç½²ã€‚è€Œå®é™…å¼€å‘ä¸­ï¼Œtomcatä¸€å®šæ˜¯é›†ç¾¤æ¨¡å¼ï¼š\nå› æ­¤ï¼ŒOpenRestyéœ€è¦å¯¹tomcaté›†ç¾¤åšè´Ÿè½½å‡è¡¡ã€‚\nè€Œé»˜è®¤çš„è´Ÿè½½å‡è¡¡è§„åˆ™æ˜¯è½®è¯¢æ¨¡å¼ï¼Œå½“æˆ‘ä»¬æŸ¥è¯¢/item/10001æ—¶ï¼š\nç¬¬ä¸€æ¬¡ä¼šè®¿é—®8081ç«¯å£çš„tomcatæœåŠ¡ï¼Œåœ¨è¯¥æœåŠ¡å†…éƒ¨å°±å½¢æˆäº†JVMè¿›ç¨‹ç¼“å­˜ ç¬¬äºŒæ¬¡ä¼šè®¿é—®8082ç«¯å£çš„tomcatæœåŠ¡ï¼Œè¯¥æœåŠ¡å†…éƒ¨æ²¡æœ‰JVMç¼“å­˜ï¼ˆå› ä¸ºJVMç¼“å­˜æ— æ³•å…±äº«ï¼‰ï¼Œä¼šæŸ¥è¯¢æ•°æ®åº“ â€¦ ä½ çœ‹ï¼Œå› ä¸ºè½®è¯¢çš„åŸå› ï¼Œç¬¬ä¸€æ¬¡æŸ¥è¯¢8081å½¢æˆçš„JVMç¼“å­˜å¹¶æœªç”Ÿæ•ˆï¼Œç›´åˆ°ä¸‹ä¸€æ¬¡å†æ¬¡è®¿é—®åˆ°8081æ—¶æ‰å¯ä»¥ç”Ÿæ•ˆï¼Œç¼“å­˜å‘½ä¸­ç‡å¤ªä½äº†ã€‚\næ€ä¹ˆåŠï¼Ÿ\nå¦‚æœèƒ½è®©åŒä¸€ä¸ªå•†å“ï¼Œæ¯æ¬¡æŸ¥è¯¢æ—¶éƒ½è®¿é—®åŒä¸€ä¸ªtomcatæœåŠ¡ï¼Œé‚£ä¹ˆJVMç¼“å­˜å°±ä¸€å®šèƒ½ç”Ÿæ•ˆäº†ã€‚\nä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬éœ€è¦æ ¹æ®å•†å“idåšè´Ÿè½½å‡è¡¡ï¼Œè€Œä¸æ˜¯è½®è¯¢ã€‚\n1ï¼‰åŸç† nginxæä¾›äº†åŸºäºè¯·æ±‚è·¯å¾„åšè´Ÿè½½å‡è¡¡çš„ç®—æ³•ï¼š\nnginxæ ¹æ®è¯·æ±‚è·¯å¾„åšhashè¿ç®—ï¼ŒæŠŠå¾—åˆ°çš„æ•°å€¼å¯¹tomcatæœåŠ¡çš„æ•°é‡å–ä½™ï¼Œä½™æ•°æ˜¯å‡ ï¼Œå°±è®¿é—®ç¬¬å‡ ä¸ªæœåŠ¡ï¼Œå®ç°è´Ÿè½½å‡è¡¡ã€‚\nä¾‹å¦‚ï¼š\næˆ‘ä»¬çš„è¯·æ±‚è·¯å¾„æ˜¯ /item/10001 tomcatæ€»æ•°ä¸º2å°ï¼ˆ8081ã€8082ï¼‰ å¯¹è¯·æ±‚è·¯å¾„/item/1001åšhashè¿ç®—æ±‚ä½™çš„ç»“æœä¸º1 åˆ™è®¿é—®ç¬¬ä¸€ä¸ªtomcatæœåŠ¡ï¼Œä¹Ÿå°±æ˜¯8081 åªè¦idä¸å˜ï¼Œæ¯æ¬¡hashè¿ç®—ç»“æœä¹Ÿä¸ä¼šå˜ï¼Œé‚£å°±å¯ä»¥ä¿è¯åŒä¸€ä¸ªå•†å“ï¼Œä¸€ç›´è®¿é—®åŒä¸€ä¸ªtomcatæœåŠ¡ï¼Œç¡®ä¿JVMç¼“å­˜ç”Ÿæ•ˆã€‚\n2ï¼‰å®ç° ä¿®æ”¹/usr/local/openresty/nginx/conf/nginx.confæ–‡ä»¶ï¼Œå®ç°åŸºäºIDåšè´Ÿè½½å‡è¡¡ã€‚\né¦–å…ˆï¼Œå®šä¹‰tomcaté›†ç¾¤ï¼Œå¹¶è®¾ç½®åŸºäºè·¯å¾„åšè´Ÿè½½å‡è¡¡ï¼š\nupstream tomcat-cluster { hash $request_uri; server 192.168.150.1:8081; server 192.168.150.1:8082; } ç„¶åï¼Œä¿®æ”¹å¯¹tomcatæœåŠ¡çš„åå‘ä»£ç†ï¼Œç›®æ ‡æŒ‡å‘tomcaté›†ç¾¤ï¼š\nlocation /item { proxy_pass http://tomcat-cluster; } é‡æ–°åŠ è½½OpenResty\nnginx -s reload 3ï¼‰æµ‹è¯• å¯åŠ¨ä¸¤å°tomcatæœåŠ¡ï¼š\nåŒæ—¶å¯åŠ¨ï¼š\næ¸…ç©ºæ—¥å¿—åï¼Œå†æ¬¡è®¿é—®é¡µé¢ï¼Œå¯ä»¥çœ‹åˆ°ä¸åŒidçš„å•†å“ï¼Œè®¿é—®åˆ°äº†ä¸åŒçš„tomcatæœåŠ¡ï¼š\n4.5.Redisç¼“å­˜é¢„çƒ­ Redisç¼“å­˜ä¼šé¢ä¸´å†·å¯åŠ¨é—®é¢˜ï¼š\nå†·å¯åŠ¨ï¼šæœåŠ¡åˆšåˆšå¯åŠ¨æ—¶ï¼ŒRedisä¸­å¹¶æ²¡æœ‰ç¼“å­˜ï¼Œå¦‚æœæ‰€æœ‰å•†å“æ•°æ®éƒ½åœ¨ç¬¬ä¸€æ¬¡æŸ¥è¯¢æ—¶æ·»åŠ ç¼“å­˜ï¼Œå¯èƒ½ä¼šç»™æ•°æ®åº“å¸¦æ¥è¾ƒå¤§å‹åŠ›ã€‚\nç¼“å­˜é¢„çƒ­ï¼šåœ¨å®é™…å¼€å‘ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨å¤§æ•°æ®ç»Ÿè®¡ç”¨æˆ·è®¿é—®çš„çƒ­ç‚¹æ•°æ®ï¼Œåœ¨é¡¹ç›®å¯åŠ¨æ—¶å°†è¿™äº›çƒ­ç‚¹æ•°æ®æå‰æŸ¥è¯¢å¹¶ä¿å­˜åˆ°Redisä¸­ã€‚\næˆ‘ä»¬æ•°æ®é‡è¾ƒå°‘ï¼Œå¹¶ä¸”æ²¡æœ‰æ•°æ®ç»Ÿè®¡ç›¸å…³åŠŸèƒ½ï¼Œç›®å‰å¯ä»¥åœ¨å¯åŠ¨æ—¶å°†æ‰€æœ‰æ•°æ®éƒ½æ”¾å…¥ç¼“å­˜ä¸­ã€‚\n1ï¼‰åˆ©ç”¨Dockerå®‰è£…Redis\ndocker run --name redis -p 6379:6379 -d redis redis-server --appendonly yes 2ï¼‰åœ¨item-serviceæœåŠ¡ä¸­å¼•å…¥Redisä¾èµ–\norg.springframework.boot spring-boot-starter-data-redis 3ï¼‰é…ç½®Redisåœ°å€\nspring: redis: host: 192.168.150.101 4ï¼‰ç¼–å†™åˆå§‹åŒ–ç±»\nç¼“å­˜é¢„çƒ­éœ€è¦åœ¨é¡¹ç›®å¯åŠ¨æ—¶å®Œæˆï¼Œå¹¶ä¸”å¿…é¡»æ˜¯æ‹¿åˆ°RedisTemplateä¹‹åã€‚\nè¿™é‡Œæˆ‘ä»¬åˆ©ç”¨InitializingBeanæ¥å£æ¥å®ç°ï¼Œå› ä¸ºInitializingBeanå¯ä»¥åœ¨å¯¹è±¡è¢«Springåˆ›å»ºå¹¶ä¸”æˆå‘˜å˜é‡å…¨éƒ¨æ³¨å…¥åæ‰§è¡Œã€‚\npackage com.heima.item.config; import com.fasterxml.jackson.core.JsonProcessingException; import com.fasterxml.jackson.databind.ObjectMapper; import com.heima.item.pojo.Item; import com.heima.item.pojo.ItemStock; import com.heima.item.service.IItemService; import com.heima.item.service.IItemStockService; import org.springframework.beans.factory.InitializingBean; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.data.redis.core.StringRedisTemplate; import org.springframework.stereotype.Component; import java.util.List; @Component public class RedisHandler implements InitializingBean { @Autowired private StringRedisTemplate redisTemplate; @Autowired private IItemService itemService; @Autowired private IItemStockService stockService; private static final ObjectMapper MAPPER = new ObjectMapper(); @Override public void afterPropertiesSet() throws Exception { // åˆå§‹åŒ–ç¼“å­˜ // 1.æŸ¥è¯¢å•†å“ä¿¡æ¯ List\u003cItem\u003e itemList = itemService.list(); // 2.æ”¾å…¥ç¼“å­˜ for (Item item : itemList) { // 2.1.itemåºåˆ—åŒ–ä¸ºJSON String json = MAPPER.writeValueAsString(item); // 2.2.å­˜å…¥redis redisTemplate.opsForValue().set(\"item:id:\" + item.getId(), json); } // 3.æŸ¥è¯¢å•†å“åº“å­˜ä¿¡æ¯ List\u003cItemStock\u003e stockList = stockService.list(); // 4.æ”¾å…¥ç¼“å­˜ for (ItemStock stock : stockList) { // 2.1.itemåºåˆ—åŒ–ä¸ºJSON String json = MAPPER.writeValueAsString(stock); // 2.2.å­˜å…¥redis redisTemplate.opsForValue().set(\"item:stock:id:\" + stock.getId(), json); } } } 4.6.æŸ¥è¯¢Redisç¼“å­˜ ç°åœ¨ï¼ŒRedisç¼“å­˜å·²ç»å‡†å¤‡å°±ç»ªï¼Œæˆ‘ä»¬å¯ä»¥å†OpenRestyä¸­å®ç°æŸ¥è¯¢Redisçš„é€»è¾‘äº†ã€‚å¦‚ä¸‹å›¾çº¢æ¡†æ‰€ç¤ºï¼š\nå½“è¯·æ±‚è¿›å…¥OpenRestyä¹‹åï¼š\nä¼˜å…ˆæŸ¥è¯¢Redisç¼“å­˜ å¦‚æœRedisç¼“å­˜æœªå‘½ä¸­ï¼Œå†æŸ¥è¯¢Tomcat 4.6.1.å°è£…Rediså·¥å…· OpenRestyæä¾›äº†æ“ä½œRedisçš„æ¨¡å—ï¼Œæˆ‘ä»¬åªè¦å¼•å…¥è¯¥æ¨¡å—å°±èƒ½ç›´æ¥ä½¿ç”¨ã€‚ä½†æ˜¯ä¸ºäº†æ–¹ä¾¿ï¼Œæˆ‘ä»¬å°†Redisæ“ä½œå°è£…åˆ°ä¹‹å‰çš„common.luaå·¥å…·åº“ä¸­ã€‚\nä¿®æ”¹/usr/local/openresty/lualib/common.luaæ–‡ä»¶ï¼š\n1ï¼‰å¼•å…¥Redisæ¨¡å—ï¼Œå¹¶åˆå§‹åŒ–Rediså¯¹è±¡\n-- å¯¼å…¥redis local redis = require('resty.redis') -- åˆå§‹åŒ–redis local red = redis:new() red:set_timeouts(1000, 1000, 1000) 2ï¼‰å°è£…å‡½æ•°ï¼Œç”¨æ¥é‡Šæ”¾Redisè¿æ¥ï¼Œå…¶å®æ˜¯æ”¾å…¥è¿æ¥æ± \nlocal function close_redis(red) local pool_max_idle_time = 10000 local pool_size = 100 local ok, err = red:set_keepalive(pool_max_idle_time, pool_size) if not ok then ngx.log(ngx.ERR, \"æ”¾å…¥redisè¿æ¥æ± å¤±è´¥: \", err) end end 3ï¼‰å°è£…å‡½æ•°ï¼Œæ ¹æ®keyæŸ¥è¯¢Redisæ•°æ®\nlocal function read_redis(ip, port, key) local ok, err = red:connect(ip, port) if not ok then ngx.log(ngx.ERR, \"è¿æ¥rediså¤±è´¥ : \", err) return nil end local resp, err = red:get(key) if not resp then ngx.log(ngx.ERR, \"æŸ¥è¯¢Rediså¤±è´¥: \", err, \", key = \" , key) end if resp == ngx.null then resp = nil ngx.log(ngx.ERR, \"æŸ¥è¯¢Redisæ•°æ®ä¸ºç©º, key = \", key) end close_redis(red) return resp end 4ï¼‰å¯¼å‡º\n-- å°†æ–¹æ³•å¯¼å‡º local _M = { read_http = read_http, read_redis = read_redis } return _M å®Œæ•´çš„common.luaï¼š\n-- å¯¼å…¥redis local redis = require('resty.redis') -- åˆå§‹åŒ–redis local red = redis:new() red:set_timeouts(1000, 1000, 1000) -- å…³é—­redisè¿æ¥çš„å·¥å…·æ–¹æ³•ï¼Œå…¶å®æ˜¯æ”¾å…¥è¿æ¥æ±  local function close_redis(red) local pool_max_idle_time = 10000 -- è¿æ¥çš„ç©ºé—²æ—¶é—´ï¼Œå•ä½æ˜¯æ¯«ç§’ local pool_size = 100 --è¿æ¥æ± å¤§å° local ok, err = red:set_keepalive(pool_max_idle_time, pool_size) if not ok then ngx.log(ngx.ERR, \"æ”¾å…¥redisè¿æ¥æ± å¤±è´¥: \", err) end end -- æŸ¥è¯¢redisçš„æ–¹æ³• ipå’Œportæ˜¯redisåœ°å€ï¼Œkeyæ˜¯æŸ¥è¯¢çš„key local function read_redis(ip, port, key) -- è·å–ä¸€ä¸ªè¿æ¥ local ok, err = red:connect(ip, port) if not ok then ngx.log(ngx.ERR, \"è¿æ¥rediså¤±è´¥ : \", err) return nil end -- æŸ¥è¯¢redis local resp, err = red:get(key) -- æŸ¥è¯¢å¤±è´¥å¤„ç† if not resp then ngx.log(ngx.ERR, \"æŸ¥è¯¢Rediså¤±è´¥: \", err, \", key = \" , key) end --å¾—åˆ°çš„æ•°æ®ä¸ºç©ºå¤„ç† if resp == ngx.null then resp = nil ngx.log(ngx.ERR, \"æŸ¥è¯¢Redisæ•°æ®ä¸ºç©º, key = \", key) end close_redis(red) return resp end -- å°è£…å‡½æ•°ï¼Œå‘é€httpè¯·æ±‚ï¼Œå¹¶è§£æå“åº” local function read_http(path, params) local resp = ngx.location.capture(path,{ method = ngx.HTTP_GET, args = params, }) if not resp then -- è®°å½•é”™è¯¯ä¿¡æ¯ï¼Œè¿”å›404 ngx.log(ngx.ERR, \"httpæŸ¥è¯¢å¤±è´¥, path: \", path , \", args: \", args) ngx.exit(404) end return resp.body end -- å°†æ–¹æ³•å¯¼å‡º local _M = { read_http = read_http, read_redis = read_redis } return _M 4.6.2.å®ç°RedisæŸ¥è¯¢ æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥å»ä¿®æ”¹item.luaæ–‡ä»¶ï¼Œå®ç°å¯¹Redisçš„æŸ¥è¯¢äº†ã€‚\næŸ¥è¯¢é€»è¾‘æ˜¯ï¼š\næ ¹æ®idæŸ¥è¯¢Redis å¦‚æœæŸ¥è¯¢å¤±è´¥åˆ™ç»§ç»­æŸ¥è¯¢Tomcat å°†æŸ¥è¯¢ç»“æœè¿”å› 1ï¼‰ä¿®æ”¹/usr/local/openresty/lua/item.luaæ–‡ä»¶ï¼Œæ·»åŠ ä¸€ä¸ªæŸ¥è¯¢å‡½æ•°ï¼š\n-- å¯¼å…¥commonå‡½æ•°åº“ local common = require('common') local read_http = common.read_http local read_redis = common.read_redis -- å°è£…æŸ¥è¯¢å‡½æ•° function read_data(key, path, params) local val = read_redis(\"127.0.0.1\", 6379, key) if not val then ngx.log(ngx.ERR, \"redisæŸ¥è¯¢å¤±è´¥ï¼Œå°è¯•æŸ¥è¯¢httpï¼Œ key: \", key) val = read_http(path, params) end return val end 2ï¼‰è€Œåä¿®æ”¹å•†å“æŸ¥è¯¢ã€åº“å­˜æŸ¥è¯¢çš„ä¸šåŠ¡ï¼š\n3ï¼‰å®Œæ•´çš„item.luaä»£ç ï¼š\n-- å¯¼å…¥commonå‡½æ•°åº“ local common = require('common') local read_http = common.read_http local read_redis = common.read_redis -- å¯¼å…¥cjsonåº“ local cjson = require('cjson') -- å°è£…æŸ¥è¯¢å‡½æ•° function read_data(key, path, params) -- æŸ¥è¯¢æœ¬åœ°ç¼“å­˜ local val = read_redis(\"127.0.0.1\", 6379, key) -- åˆ¤æ–­æŸ¥è¯¢ç»“æœ if not val then ngx.log(ngx.ERR, \"redisæŸ¥è¯¢å¤±è´¥ï¼Œå°è¯•æŸ¥è¯¢httpï¼Œ key: \", key) -- redisæŸ¥è¯¢å¤±è´¥ï¼Œå»æŸ¥è¯¢http val = read_http(path, params) end -- è¿”å›æ•°æ® return val end -- è·å–è·¯å¾„å‚æ•° local id = ngx.var[1] local itemJSON = read_data(\"item:id:\" .. id, \"/item/\" .. id, nil) local stockJSON = read_data(\"item:stock:id:\" .. id, \"/item/stock/\" .. id, nil) -- JSONè½¬åŒ–ä¸ºluaçš„table local item = cjson.decode(itemJSON) local stock = cjson.decode(stockJSON) -- ç»„åˆæ•°æ® item.stock = stock.stock item.sold = stock.sold -- æŠŠitemåºåˆ—åŒ–ä¸ºjson è¿”å›ç»“æœ ngx.say(cjson.encode(item)) 4.7.Nginxæœ¬åœ°ç¼“å­˜ ç°åœ¨ï¼Œæ•´ä¸ªå¤šçº§ç¼“å­˜ä¸­åªå·®æœ€åä¸€ç¯ï¼Œä¹Ÿå°±æ˜¯nginxçš„æœ¬åœ°ç¼“å­˜äº†ã€‚å¦‚å›¾ï¼š\n4.7.1.æœ¬åœ°ç¼“å­˜API OpenRestyä¸ºNginxæä¾›äº†shard dictçš„åŠŸèƒ½ï¼Œå¯ä»¥åœ¨nginxçš„å¤šä¸ªworkerä¹‹é—´å…±äº«æ•°æ®ï¼Œå®ç°ç¼“å­˜åŠŸèƒ½ã€‚\n1ï¼‰å¼€å¯å…±äº«å­—å…¸ï¼Œåœ¨nginx.confçš„httpä¸‹æ·»åŠ é…ç½®ï¼š\n# å…±äº«å­—å…¸ï¼Œä¹Ÿå°±æ˜¯æœ¬åœ°ç¼“å­˜ï¼Œåç§°å«åšï¼šitem_cacheï¼Œå¤§å°150m lua_shared_dict item_cache 150m; 2ï¼‰æ“ä½œå…±äº«å­—å…¸ï¼š\n-- è·å–æœ¬åœ°ç¼“å­˜å¯¹è±¡ local item_cache = ngx.shared.item_cache -- å­˜å‚¨, æŒ‡å®škeyã€valueã€è¿‡æœŸæ—¶é—´ï¼Œå•ä½sï¼Œé»˜è®¤ä¸º0ä»£è¡¨æ°¸ä¸è¿‡æœŸ item_cache:set('key', 'value', 1000) -- è¯»å– local val = item_cache:get('key') 4.7.2.å®ç°æœ¬åœ°ç¼“å­˜æŸ¥è¯¢ 1ï¼‰ä¿®æ”¹/usr/local/openresty/lua/item.luaæ–‡ä»¶ï¼Œä¿®æ”¹read_dataæŸ¥è¯¢å‡½æ•°ï¼Œæ·»åŠ æœ¬åœ°ç¼“å­˜é€»è¾‘ï¼š\n-- å¯¼å…¥å…±äº«è¯å…¸ï¼Œæœ¬åœ°ç¼“å­˜ local item_cache = ngx.shared.item_cache -- å°è£…æŸ¥è¯¢å‡½æ•° function read_data(key, expire, path, params) -- æŸ¥è¯¢æœ¬åœ°ç¼“å­˜ local val = item_cache:get(key) if not val then ngx.log(ngx.ERR, \"æœ¬åœ°ç¼“å­˜æŸ¥è¯¢å¤±è´¥ï¼Œå°è¯•æŸ¥è¯¢Redisï¼Œ key: \", key) -- æŸ¥è¯¢redis val = read_redis(\"127.0.0.1\", 6379, key) -- åˆ¤æ–­æŸ¥è¯¢ç»“æœ if not val then ngx.log(ngx.ERR, \"redisæŸ¥è¯¢å¤±è´¥ï¼Œå°è¯•æŸ¥è¯¢httpï¼Œ key: \", key) -- redisæŸ¥è¯¢å¤±è´¥ï¼Œå»æŸ¥è¯¢http val = read_http(path, params) end end -- æŸ¥è¯¢æˆåŠŸï¼ŒæŠŠæ•°æ®å†™å…¥æœ¬åœ°ç¼“å­˜ item_cache:set(key, val, expire) -- è¿”å›æ•°æ® return val end 2ï¼‰ä¿®æ”¹item.luaä¸­æŸ¥è¯¢å•†å“å’Œåº“å­˜çš„ä¸šåŠ¡ï¼Œå®ç°æœ€æ–°çš„read_dataå‡½æ•°ï¼š\nå…¶å®å°±æ˜¯å¤šäº†ç¼“å­˜æ—¶é—´å‚æ•°ï¼Œè¿‡æœŸånginxç¼“å­˜ä¼šè‡ªåŠ¨åˆ é™¤ï¼Œä¸‹æ¬¡è®¿é—®å³å¯æ›´æ–°ç¼“å­˜ã€‚\nè¿™é‡Œç»™å•†å“åŸºæœ¬ä¿¡æ¯è®¾ç½®è¶…æ—¶æ—¶é—´ä¸º30åˆ†é’Ÿï¼Œåº“å­˜ä¸º1åˆ†é’Ÿã€‚\nå› ä¸ºåº“å­˜æ›´æ–°é¢‘ç‡è¾ƒé«˜ï¼Œå¦‚æœç¼“å­˜æ—¶é—´è¿‡é•¿ï¼Œå¯èƒ½ä¸æ•°æ®åº“å·®å¼‚è¾ƒå¤§ã€‚\n3ï¼‰å®Œæ•´çš„item.luaæ–‡ä»¶ï¼š\n-- å¯¼å…¥commonå‡½æ•°åº“ local common = require('common') local read_http = common.read_http local read_redis = common.read_redis -- å¯¼å…¥cjsonåº“ local cjson = require('cjson') -- å¯¼å…¥å…±äº«è¯å…¸ï¼Œæœ¬åœ°ç¼“å­˜ local item_cache = ngx.shared.item_cache -- å°è£…æŸ¥è¯¢å‡½æ•° function read_data(key, expire, path, params) -- æŸ¥è¯¢æœ¬åœ°ç¼“å­˜ local val = item_cache:get(key) if not val then ngx.log(ngx.ERR, \"æœ¬åœ°ç¼“å­˜æŸ¥è¯¢å¤±è´¥ï¼Œå°è¯•æŸ¥è¯¢Redisï¼Œ key: \", key) -- æŸ¥è¯¢redis val = read_redis(\"127.0.0.1\", 6379, key) -- åˆ¤æ–­æŸ¥è¯¢ç»“æœ if not val then ngx.log(ngx.ERR, \"redisæŸ¥è¯¢å¤±è´¥ï¼Œå°è¯•æŸ¥è¯¢httpï¼Œ key: \", key) -- redisæŸ¥è¯¢å¤±è´¥ï¼Œå»æŸ¥è¯¢http val = read_http(path, params) end end -- æŸ¥è¯¢æˆåŠŸï¼ŒæŠŠæ•°æ®å†™å…¥æœ¬åœ°ç¼“å­˜ item_cache:set(key, val, expire) -- è¿”å›æ•°æ® return val end -- è·å–è·¯å¾„å‚æ•° local id = ngx.var[1] -- æŸ¥è¯¢å•†å“ä¿¡æ¯ local itemJSON = read_data(\"item:id:\" .. id, 1800, \"/item/\" .. id, nil) -- æŸ¥è¯¢åº“å­˜ä¿¡æ¯ local stockJSON = read_data(\"item:stock:id:\" .. id, 60, \"/item/stock/\" .. id, nil) -- JSONè½¬åŒ–ä¸ºluaçš„table local item = cjson.decode(itemJSON) local stock = cjson.decode(stockJSON) -- ç»„åˆæ•°æ® item.stock = stock.stock item.sold = stock.sold -- æŠŠitemåºåˆ—åŒ–ä¸ºjson è¿”å›ç»“æœ ngx.say(cjson.encode(item)) 5.ç¼“å­˜åŒæ­¥ å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæµè§ˆå™¨æŸ¥è¯¢åˆ°çš„éƒ½æ˜¯ç¼“å­˜æ•°æ®ï¼Œå¦‚æœç¼“å­˜æ•°æ®ä¸æ•°æ®åº“æ•°æ®å­˜åœ¨è¾ƒå¤§å·®å¼‚ï¼Œå¯èƒ½ä¼šäº§ç”Ÿæ¯”è¾ƒä¸¥é‡çš„åæœã€‚\næ‰€ä»¥æˆ‘ä»¬å¿…é¡»ä¿è¯æ•°æ®åº“æ•°æ®ã€ç¼“å­˜æ•°æ®çš„ä¸€è‡´æ€§ï¼Œè¿™å°±æ˜¯ç¼“å­˜ä¸æ•°æ®åº“çš„åŒæ­¥ã€‚\n5.1.æ•°æ®åŒæ­¥ç­–ç•¥ ç¼“å­˜æ•°æ®åŒæ­¥çš„å¸¸è§æ–¹å¼æœ‰ä¸‰ç§ï¼š\nè®¾ç½®æœ‰æ•ˆæœŸï¼šç»™ç¼“å­˜è®¾ç½®æœ‰æ•ˆæœŸï¼Œåˆ°æœŸåè‡ªåŠ¨åˆ é™¤ã€‚å†æ¬¡æŸ¥è¯¢æ—¶æ›´æ–°\nä¼˜åŠ¿ï¼šç®€å•ã€æ–¹ä¾¿ ç¼ºç‚¹ï¼šæ—¶æ•ˆæ€§å·®ï¼Œç¼“å­˜è¿‡æœŸä¹‹å‰å¯èƒ½ä¸ä¸€è‡´ åœºæ™¯ï¼šæ›´æ–°é¢‘ç‡è¾ƒä½ï¼Œæ—¶æ•ˆæ€§è¦æ±‚ä½çš„ä¸šåŠ¡ åŒæ­¥åŒå†™ï¼šåœ¨ä¿®æ”¹æ•°æ®åº“çš„åŒæ—¶ï¼Œç›´æ¥ä¿®æ”¹ç¼“å­˜\nä¼˜åŠ¿ï¼šæ—¶æ•ˆæ€§å¼ºï¼Œç¼“å­˜ä¸æ•°æ®åº“å¼ºä¸€è‡´ ç¼ºç‚¹ï¼šæœ‰ä»£ç ä¾µå…¥ï¼Œè€¦åˆåº¦é«˜ï¼› åœºæ™¯ï¼šå¯¹ä¸€è‡´æ€§ã€æ—¶æ•ˆæ€§è¦æ±‚è¾ƒé«˜çš„ç¼“å­˜æ•°æ® **å¼‚æ­¥é€šçŸ¥ï¼š**ä¿®æ”¹æ•°æ®åº“æ—¶å‘é€äº‹ä»¶é€šçŸ¥ï¼Œç›¸å…³æœåŠ¡ç›‘å¬åˆ°é€šçŸ¥åä¿®æ”¹ç¼“å­˜æ•°æ®\nä¼˜åŠ¿ï¼šä½è€¦åˆï¼Œå¯ä»¥åŒæ—¶é€šçŸ¥å¤šä¸ªç¼“å­˜æœåŠ¡ ç¼ºç‚¹ï¼šæ—¶æ•ˆæ€§ä¸€èˆ¬ï¼Œå¯èƒ½å­˜åœ¨ä¸­é—´ä¸ä¸€è‡´çŠ¶æ€ åœºæ™¯ï¼šæ—¶æ•ˆæ€§è¦æ±‚ä¸€èˆ¬ï¼Œæœ‰å¤šä¸ªæœåŠ¡éœ€è¦åŒæ­¥ è€Œå¼‚æ­¥å®ç°åˆå¯ä»¥åŸºäºMQæˆ–è€…Canalæ¥å®ç°ï¼š\n1ï¼‰åŸºäºMQçš„å¼‚æ­¥é€šçŸ¥ï¼š\nè§£è¯»ï¼š\nå•†å“æœåŠ¡å®Œæˆå¯¹æ•°æ®çš„ä¿®æ”¹åï¼Œåªéœ€è¦å‘é€ä¸€æ¡æ¶ˆæ¯åˆ°MQä¸­ã€‚ ç¼“å­˜æœåŠ¡ç›‘å¬MQæ¶ˆæ¯ï¼Œç„¶åå®Œæˆå¯¹ç¼“å­˜çš„æ›´æ–° ä¾ç„¶æœ‰å°‘é‡çš„ä»£ç ä¾µå…¥ã€‚\n2ï¼‰åŸºäºCanalçš„é€šçŸ¥\nè§£è¯»ï¼š\nå•†å“æœåŠ¡å®Œæˆå•†å“ä¿®æ”¹åï¼Œä¸šåŠ¡ç›´æ¥ç»“æŸï¼Œæ²¡æœ‰ä»»ä½•ä»£ç ä¾µå…¥ Canalç›‘å¬MySQLå˜åŒ–ï¼Œå½“å‘ç°å˜åŒ–åï¼Œç«‹å³é€šçŸ¥ç¼“å­˜æœåŠ¡ ç¼“å­˜æœåŠ¡æ¥æ”¶åˆ°canalé€šçŸ¥ï¼Œæ›´æ–°ç¼“å­˜ ä»£ç é›¶ä¾µå…¥\n5.2.å®‰è£…Canal 5.2.1.è®¤è¯†Canal Canal [kÉ™â€™nÃ¦l]ï¼Œè¯‘æ„ä¸ºæ°´é“/ç®¡é“/æ²Ÿæ¸ ï¼Œcanalæ˜¯é˜¿é‡Œå·´å·´æ——ä¸‹çš„ä¸€æ¬¾å¼€æºé¡¹ç›®ï¼ŒåŸºäºJavaå¼€å‘ã€‚åŸºäºæ•°æ®åº“å¢é‡æ—¥å¿—è§£æï¼Œæä¾›å¢é‡æ•°æ®è®¢é˜…\u0026æ¶ˆè´¹ã€‚GitHubçš„åœ°å€ï¼šhttps://github.com/alibaba/canal\nCanalæ˜¯åŸºäºmysqlçš„ä¸»ä»åŒæ­¥æ¥å®ç°çš„ï¼ŒMySQLä¸»ä»åŒæ­¥çš„åŸç†å¦‚ä¸‹ï¼š\n1ï¼‰MySQL master å°†æ•°æ®å˜æ›´å†™å…¥äºŒè¿›åˆ¶æ—¥å¿—( binary logï¼‰ï¼Œå…¶ä¸­è®°å½•çš„æ•°æ®å«åšbinary log events 2ï¼‰MySQL slave å°† master çš„ binary log eventsæ‹·è´åˆ°å®ƒçš„ä¸­ç»§æ—¥å¿—(relay log) 3ï¼‰MySQL slave é‡æ”¾ relay log ä¸­äº‹ä»¶ï¼Œå°†æ•°æ®å˜æ›´åæ˜ å®ƒè‡ªå·±çš„æ•°æ® è€ŒCanalå°±æ˜¯æŠŠè‡ªå·±ä¼ªè£…æˆMySQLçš„ä¸€ä¸ªslaveèŠ‚ç‚¹ï¼Œä»è€Œç›‘å¬masterçš„binary logå˜åŒ–ã€‚å†æŠŠå¾—åˆ°çš„å˜åŒ–ä¿¡æ¯é€šçŸ¥ç»™Canalçš„å®¢æˆ·ç«¯ï¼Œè¿›è€Œå®Œæˆå¯¹å…¶å®ƒæ•°æ®åº“çš„åŒæ­¥ã€‚\n5.2.2.å®‰è£…Canal å®‰è£…å’Œé…ç½®Canalå‚è€ƒè¯¾å‰èµ„æ–™æ–‡æ¡£ï¼š\n5.3.ç›‘å¬Canal Canalæä¾›äº†å„ç§è¯­è¨€çš„å®¢æˆ·ç«¯ï¼Œå½“Canalç›‘å¬åˆ°binlogå˜åŒ–æ—¶ï¼Œä¼šé€šçŸ¥Canalçš„å®¢æˆ·ç«¯ã€‚\næˆ‘ä»¬å¯ä»¥åˆ©ç”¨Canalæä¾›çš„Javaå®¢æˆ·ç«¯ï¼Œç›‘å¬Canalé€šçŸ¥æ¶ˆæ¯ã€‚å½“æ”¶åˆ°å˜åŒ–çš„æ¶ˆæ¯æ—¶ï¼Œå®Œæˆå¯¹ç¼“å­˜çš„æ›´æ–°ã€‚\nä¸è¿‡è¿™é‡Œæˆ‘ä»¬ä¼šä½¿ç”¨GitHubä¸Šçš„ç¬¬ä¸‰æ–¹å¼€æºçš„canal-starterå®¢æˆ·ç«¯ã€‚åœ°å€ï¼šhttps://github.com/NormanGyllenhaal/canal-client\nä¸SpringBootå®Œç¾æ•´åˆï¼Œè‡ªåŠ¨è£…é…ï¼Œæ¯”å®˜æ–¹å®¢æˆ·ç«¯è¦ç®€å•å¥½ç”¨å¾ˆå¤šã€‚\n5.3.1.å¼•å…¥ä¾èµ–ï¼š top.javatool canal-spring-boot-starter 1.2.1-RELEASE 5.3.2.ç¼–å†™é…ç½®ï¼š canal: destination: heima # canalçš„é›†ç¾¤åå­—ï¼Œè¦ä¸å®‰è£…canalæ—¶è®¾ç½®çš„åç§°ä¸€è‡´ server: 192.168.150.101:11111 # canalæœåŠ¡åœ°å€ 5.3.3.ä¿®æ”¹Itemå®ä½“ç±» é€šè¿‡@Idã€@Columnã€ç­‰æ³¨è§£å®ŒæˆItemä¸æ•°æ®åº“è¡¨å­—æ®µçš„æ˜ å°„ï¼š\npackage com.heima.item.pojo; import com.baomidou.mybatisplus.annotation.IdType; import com.baomidou.mybatisplus.annotation.TableField; import com.baomidou.mybatisplus.annotation.TableId; import com.baomidou.mybatisplus.annotation.TableName; import lombok.Data; import org.springframework.data.annotation.Id; import org.springframework.data.annotation.Transient; import javax.persistence.Column; import java.util.Date; @Data @TableName(\"tb_item\") public class Item { @TableId(type = IdType.AUTO) @Id private Long id;//å•†å“id @Column(name = \"name\") private String name;//å•†å“åç§° private String title;//å•†å“æ ‡é¢˜ private Long price;//ä»·æ ¼ï¼ˆåˆ†ï¼‰ private String image;//å•†å“å›¾ç‰‡ private String category;//åˆ†ç±»åç§° private String brand;//å“ç‰Œåç§° private String spec;//è§„æ ¼ private Integer status;//å•†å“çŠ¶æ€ 1-æ­£å¸¸ï¼Œ2-ä¸‹æ¶ private Date createTime;//åˆ›å»ºæ—¶é—´ private Date updateTime;//æ›´æ–°æ—¶é—´ @TableField(exist = false) @Transient private Integer stock; @TableField(exist = false) @Transient private Integer sold; } 5.3.4.ç¼–å†™ç›‘å¬å™¨ é€šè¿‡å®ç°EntryHandleræ¥å£ç¼–å†™ç›‘å¬å™¨ï¼Œç›‘å¬Canalæ¶ˆæ¯ã€‚æ³¨æ„ä¸¤ç‚¹ï¼š\nå®ç°ç±»é€šè¿‡@CanalTable(\"tb_item\")æŒ‡å®šç›‘å¬çš„è¡¨ä¿¡æ¯ EntryHandlerçš„æ³›å‹æ˜¯ä¸è¡¨å¯¹åº”çš„å®ä½“ç±» package com.heima.item.canal; import com.github.benmanes.caffeine.cache.Cache; import com.heima.item.config.RedisHandler; import com.heima.item.pojo.Item; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.stereotype.Component; import top.javatool.canal.client.annotation.CanalTable; import top.javatool.canal.client.handler.EntryHandler; @CanalTable(\"tb_item\") @Component public class ItemHandler implements EntryHandler\u003cItem\u003e { @Autowired private RedisHandler redisHandler; @Autowired private Cache\u003cLong, Item\u003e itemCache; @Override public void insert(Item item) { // å†™æ•°æ®åˆ°JVMè¿›ç¨‹ç¼“å­˜ itemCache.put(item.getId(), item); // å†™æ•°æ®åˆ°redis redisHandler.saveItem(item); } @Override public void update(Item before, Item after) { // å†™æ•°æ®åˆ°JVMè¿›ç¨‹ç¼“å­˜ itemCache.put(after.getId(), after); // å†™æ•°æ®åˆ°redis redisHandler.saveItem(after); } @Override public void delete(Item item) { // åˆ é™¤æ•°æ®åˆ°JVMè¿›ç¨‹ç¼“å­˜ itemCache.invalidate(item.getId()); // åˆ é™¤æ•°æ®åˆ°redis redisHandler.deleteItemById(item.getId()); } } åœ¨è¿™é‡Œå¯¹Redisçš„æ“ä½œéƒ½å°è£…åˆ°äº†RedisHandlerè¿™ä¸ªå¯¹è±¡ä¸­ï¼Œæ˜¯æˆ‘ä»¬ä¹‹å‰åšç¼“å­˜é¢„çƒ­æ—¶ç¼–å†™çš„ä¸€ä¸ªç±»ï¼Œå†…å®¹å¦‚ä¸‹ï¼š\npackage com.heima.item.config; import com.fasterxml.jackson.core.JsonProcessingException; import com.fasterxml.jackson.databind.ObjectMapper; import com.heima.item.pojo.Item; import com.heima.item.pojo.ItemStock; import com.heima.item.service.IItemService; import com.heima.item.service.IItemStockService; import org.springframework.beans.factory.InitializingBean; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.data.redis.core.StringRedisTemplate; import org.springframework.stereotype.Component; import java.util.List; @Component public class RedisHandler implements InitializingBean { @Autowired private StringRedisTemplate redisTemplate; @Autowired private IItemService itemService; @Autowired private IItemStockService stockService; private static final ObjectMapper MAPPER = new ObjectMapper(); @Override public void afterPropertiesSet() throws Exception { // åˆå§‹åŒ–ç¼“å­˜ // 1.æŸ¥è¯¢å•†å“ä¿¡æ¯ List\u003cItem\u003e itemList = itemService.list(); // 2.æ”¾å…¥ç¼“å­˜ for (Item item : itemList) { // 2.1.itemåºåˆ—åŒ–ä¸ºJSON String json = MAPPER.writeValueAsString(item); // 2.2.å­˜å…¥redis redisTemplate.opsForValue().set(\"item:id:\" + item.getId(), json); } // 3.æŸ¥è¯¢å•†å“åº“å­˜ä¿¡æ¯ List\u003cItemStock\u003e stockList = stockService.list(); // 4.æ”¾å…¥ç¼“å­˜ for (ItemStock stock : stockList) { // 2.1.itemåºåˆ—åŒ–ä¸ºJSON String json = MAPPER.writeValueAsString(stock); // 2.2.å­˜å…¥redis redisTemplate.opsForValue().set(\"item:stock:id:\" + stock.getId(), json); } } public void saveItem(Item item) { try { String json = MAPPER.writeValueAsString(item); redisTemplate.opsForValue().set(\"item:id:\" + item.getId(), json); } catch (JsonProcessingException e) { throw new RuntimeException(e); } } public void deleteItemById(Long id) { redisTemplate.delete(\"item:id:\" + id); } } ",
  "wordCount" : "13287",
  "inLanguage": "zh",
  "image":"https://XianCH.github.io/postsImg/redistest.png","datePublished": "2022-12-26T10:16:51Z",
  "dateModified": "2023-09-22T10:16:51Z",
  "author":[{
    "@type": "Person",
    "name": "x14n"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://XianCH.github.io/posts/tech/distributed/%E5%A4%9A%E7%BA%A7%E7%BC%93%E5%AD%98/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "X14n's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://XianCH.github.io/img/favicon.icon"
    }
  }
}
</script>
</head>

<body class=" dark" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://XianCH.github.io/" accesskey="h" title="x14n&#39;s Blog (Alt + H)">
            <img src="https://XianCH.github.io/img/main.png" alt="logo" aria-label="logo"
                 height="35">x14n&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                         fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                         stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                         fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                         stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
                <ul class="lang-switch"><li>|</li>
                </ul>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://XianCH.github.io/search" title="ğŸ” æœç´¢ (Alt &#43; /)" accesskey=/>
                <span>ğŸ” æœç´¢</span>
                </a>
            </li>
            <li>
                <a href="https://XianCH.github.io/" title="ğŸ  ä¸»é¡µ">
                <span>ğŸ  ä¸»é¡µ</span>
                </a>
            </li>
            <li>
                <a href="https://XianCH.github.io/posts" title="ğŸ“š æ–‡ç« ">
                <span>ğŸ“š æ–‡ç« </span>
                </a>
            </li>
            <li>
                <a href="https://XianCH.github.io/tags" title="ğŸ§© æ ‡ç­¾">
                <span>ğŸ§© æ ‡ç­¾</span>
                </a>
            </li>
            <li>
                <a href="https://XianCH.github.io/archives/" title="â±ï¸ æ—¶é—´è½´">
                <span>â±ï¸ æ—¶é—´è½´</span>
                </a>
            </li>
            <li>
                <a href="https://XianCH.github.io/about" title="ğŸ™‹ğŸ»â€â™‚ï¸ å…³äº">
                <span>ğŸ™‹ğŸ»â€â™‚ï¸ å…³äº</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main page">
<style>
    i[id*="post_meta_style"] {
        display: flex;
        align-items: center;
        margin: 0 0 10px 0;
    }
</style>

<article class="post-single">
    <div id="single-content">
        <header class="post-header">
            <div class="breadcrumbs"><a href="https://XianCH.github.io/">ğŸ  ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href="https://XianCH.github.io/posts/">ğŸ“šæ–‡ç« </a>&nbsp;Â»&nbsp;<a href="https://XianCH.github.io/posts/tech/">ğŸ‘¨ğŸ»â€ğŸ’» æŠ€æœ¯</a></div>
            <h1 class="post-title">
                å¤šçº§ç¼“å­˜
            </h1>
            <div class="post-meta">

<style>
    i[id*="post_meta_style"] {
        display: flex;
        align-items: center;
        margin: 0 0 10px 0;
    }

    .parent-post-meta {
        display: flex;
        flex-wrap: wrap;
        opacity: 0.8;
    }
</style>

<span class="parent-post-meta">
    <span id="post_meta_style_1">
        <span class="fa fa-calendar-check-o"></span>
        <span>2022-12-26
            &nbsp;&nbsp;
        </span>
    </span>
    
    
    
    
    
    
    
    <span id="post_meta_style_3">
        <span class="fa fa-file-word-o"></span>
        <span>13287å­—
            &nbsp;&nbsp;
        </span>
    </span>
    <span id="post_meta_style_4">
        <span class="fa fa-clock-o"></span>
        <span>27åˆ†é’Ÿ
            &nbsp;&nbsp;
        </span>
    </span>
    <span id="post_meta_style_5">
        <span class="fa fa-user-o"></span>
        <span>x14n
            &nbsp;&nbsp;
        </span>
    </span>
    <span id="post_meta_style_6">
        <span class="fa fa-tags" style="opacity: 0.8"></span>
        <span>
            <span class="post-tags-meta">
                <a href="https://XianCH.github.io/tags/distributed/" style="color: var(--secondary)!important;">Distributed</a>
            </span>
        </span>
    </span>
</span>
<span style="opacity: 0.8;">
                    <span id="post_meta_style_7">
                        &nbsp;&nbsp;
                        <span class="fa fa-eye" ></span>
                        <span>
                            <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv"></span></span>
                            &nbsp;&nbsp;
                        </span>
                    </span>
                    <span id="post_meta_style_8">
                        <span class="fa fa-commenting-o"></span>
                        <span>
                            <script src="https://cdn.staticfile.org/twikoo/1.5.8/twikoo.all.min.js"></script>
                            <script>
                                let url = document.documentURI
                                
                                let dnsUrl = "https://XianCH.github.io/"
                                let urlSplit = url.split(dnsUrl)
                                let finalUrl = urlSplit[1]
                                if (finalUrl[0] !== '/') {
                                    finalUrl = '/'+finalUrl
                                }
                                twikoo.getCommentsCount({
                                    envId:  null , 
                                region:  null , 
                                urls: [ 
                                    
                                    finalUrl,
                                ],
                                    includeReply: false 
                                }).then(function (res) {
                                    let count = res[0].count
                                    const obj = document.getElementById("comment_count");
                                    obj.innerText = count
                                    
                                    
                                    
                                }).catch(function (err) {
                                    
                                    console.error(err);
                                });
                            </script>
                            <span id="comment_count"></span>
                        </span>
                    </span>
                </span>

</div>
        </header> 
<figure class="entry-cover1"><img style="zoom:;" loading="lazy" src="https://XianCH.github.io/postsImg/redistest.png" alt="">
    
</figure><aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">ç›®å½•</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#1%e4%bb%80%e4%b9%88%e6%98%af%e5%a4%9a%e7%ba%a7%e7%bc%93%e5%ad%98" aria-label="1.ä»€ä¹ˆæ˜¯å¤šçº§ç¼“å­˜">1.ä»€ä¹ˆæ˜¯å¤šçº§ç¼“å­˜</a></li>
                <li>
                    <a href="#2jvm%e8%bf%9b%e7%a8%8b%e7%bc%93%e5%ad%98" aria-label="2.JVMè¿›ç¨‹ç¼“å­˜">2.JVMè¿›ç¨‹ç¼“å­˜</a><ul>
                        
                <li>
                    <a href="#21%e5%af%bc%e5%85%a5%e6%a1%88%e4%be%8b" aria-label="2.1.å¯¼å…¥æ¡ˆä¾‹">2.1.å¯¼å…¥æ¡ˆä¾‹</a></li>
                <li>
                    <a href="#22%e5%88%9d%e8%af%86caffeine" aria-label="2.2.åˆè¯†Caffeine">2.2.åˆè¯†Caffeine</a></li>
                <li>
                    <a href="#23%e5%ae%9e%e7%8e%b0jvm%e8%bf%9b%e7%a8%8b%e7%bc%93%e5%ad%98" aria-label="2.3.å®ç°JVMè¿›ç¨‹ç¼“å­˜">2.3.å®ç°JVMè¿›ç¨‹ç¼“å­˜</a><ul>
                        
                <li>
                    <a href="#231%e9%9c%80%e6%b1%82" aria-label="2.3.1.éœ€æ±‚">2.3.1.éœ€æ±‚</a></li>
                <li>
                    <a href="#232%e5%ae%9e%e7%8e%b0" aria-label="2.3.2.å®ç°">2.3.2.å®ç°</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#3lua%e8%af%ad%e6%b3%95%e5%85%a5%e9%97%a8" aria-label="3.Luaè¯­æ³•å…¥é—¨">3.Luaè¯­æ³•å…¥é—¨</a><ul>
                        
                <li>
                    <a href="#31%e5%88%9d%e8%af%86lua" aria-label="3.1.åˆè¯†Lua">3.1.åˆè¯†Lua</a></li>
                <li>
                    <a href="#31helloworld" aria-label="3.1.HelloWorld">3.1.HelloWorld</a></li>
                <li>
                    <a href="#32%e5%8f%98%e9%87%8f%e5%92%8c%e5%be%aa%e7%8e%af" aria-label="3.2.å˜é‡å’Œå¾ªç¯">3.2.å˜é‡å’Œå¾ªç¯</a><ul>
                        
                <li>
                    <a href="#321lua%e7%9a%84%e6%95%b0%e6%8d%ae%e7%b1%bb%e5%9e%8b" aria-label="3.2.1.Luaçš„æ•°æ®ç±»å‹">3.2.1.Luaçš„æ•°æ®ç±»å‹</a></li>
                <li>
                    <a href="#322%e5%a3%b0%e6%98%8e%e5%8f%98%e9%87%8f" aria-label="3.2.2.å£°æ˜å˜é‡">3.2.2.å£°æ˜å˜é‡</a></li>
                <li>
                    <a href="#323%e5%be%aa%e7%8e%af" aria-label="3.2.3.å¾ªç¯">3.2.3.å¾ªç¯</a></li></ul>
                </li>
                <li>
                    <a href="#33%e6%9d%a1%e4%bb%b6%e6%8e%a7%e5%88%b6%e5%87%bd%e6%95%b0" aria-label="3.3.æ¡ä»¶æ§åˆ¶ã€å‡½æ•°">3.3.æ¡ä»¶æ§åˆ¶ã€å‡½æ•°</a><ul>
                        
                <li>
                    <a href="#331%e5%87%bd%e6%95%b0" aria-label="3.3.1.å‡½æ•°">3.3.1.å‡½æ•°</a></li>
                <li>
                    <a href="#332%e6%9d%a1%e4%bb%b6%e6%8e%a7%e5%88%b6" aria-label="3.3.2.æ¡ä»¶æ§åˆ¶">3.3.2.æ¡ä»¶æ§åˆ¶</a></li>
                <li>
                    <a href="#333%e6%a1%88%e4%be%8b" aria-label="3.3.3.æ¡ˆä¾‹">3.3.3.æ¡ˆä¾‹</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#4%e5%ae%9e%e7%8e%b0%e5%a4%9a%e7%ba%a7%e7%bc%93%e5%ad%98" aria-label="4.å®ç°å¤šçº§ç¼“å­˜">4.å®ç°å¤šçº§ç¼“å­˜</a><ul>
                        
                <li>
                    <a href="#41%e5%ae%89%e8%a3%85openresty" aria-label="4.1.å®‰è£…OpenResty">4.1.å®‰è£…OpenResty</a></li>
                <li>
                    <a href="#42openresty%e5%bf%ab%e9%80%9f%e5%85%a5%e9%97%a8" aria-label="4.2.OpenRestyå¿«é€Ÿå…¥é—¨">4.2.OpenRestyå¿«é€Ÿå…¥é—¨</a><ul>
                        
                <li>
                    <a href="#421%e5%8f%8d%e5%90%91%e4%bb%a3%e7%90%86%e6%b5%81%e7%a8%8b" aria-label="4.2.1.åå‘ä»£ç†æµç¨‹">4.2.1.åå‘ä»£ç†æµç¨‹</a></li>
                <li>
                    <a href="#422openresty%e7%9b%91%e5%90%ac%e8%af%b7%e6%b1%82" aria-label="4.2.2.OpenRestyç›‘å¬è¯·æ±‚">4.2.2.OpenRestyç›‘å¬è¯·æ±‚</a></li>
                <li>
                    <a href="#423%e7%bc%96%e5%86%99itemlua" aria-label="4.2.3.ç¼–å†™item.lua">4.2.3.ç¼–å†™item.lua</a></li></ul>
                </li>
                <li>
                    <a href="#43%e8%af%b7%e6%b1%82%e5%8f%82%e6%95%b0%e5%a4%84%e7%90%86" aria-label="4.3.è¯·æ±‚å‚æ•°å¤„ç†">4.3.è¯·æ±‚å‚æ•°å¤„ç†</a><ul>
                        
                <li>
                    <a href="#431%e8%8e%b7%e5%8f%96%e5%8f%82%e6%95%b0%e7%9a%84api" aria-label="4.3.1.è·å–å‚æ•°çš„API">4.3.1.è·å–å‚æ•°çš„API</a></li>
                <li>
                    <a href="#432%e8%8e%b7%e5%8f%96%e5%8f%82%e6%95%b0%e5%b9%b6%e8%bf%94%e5%9b%9e" aria-label="4.3.2.è·å–å‚æ•°å¹¶è¿”å›">4.3.2.è·å–å‚æ•°å¹¶è¿”å›</a></li></ul>
                </li>
                <li>
                    <a href="#44%e6%9f%a5%e8%af%a2tomcat" aria-label="4.4.æŸ¥è¯¢Tomcat">4.4.æŸ¥è¯¢Tomcat</a><ul>
                        
                <li>
                    <a href="#441%e5%8f%91%e9%80%81http%e8%af%b7%e6%b1%82%e7%9a%84api" aria-label="4.4.1.å‘é€httpè¯·æ±‚çš„API">4.4.1.å‘é€httpè¯·æ±‚çš„API</a></li>
                <li>
                    <a href="#442%e5%b0%81%e8%a3%85http%e5%b7%a5%e5%85%b7" aria-label="4.4.2.å°è£…httpå·¥å…·">4.4.2.å°è£…httpå·¥å…·</a></li>
                <li>
                    <a href="#443cjson%e5%b7%a5%e5%85%b7%e7%b1%bb" aria-label="4.4.3.CJSONå·¥å…·ç±»">4.4.3.CJSONå·¥å…·ç±»</a></li>
                <li>
                    <a href="#444%e5%ae%9e%e7%8e%b0tomcat%e6%9f%a5%e8%af%a2" aria-label="4.4.4.å®ç°TomcatæŸ¥è¯¢">4.4.4.å®ç°TomcatæŸ¥è¯¢</a></li>
                <li>
                    <a href="#445%e5%9f%ba%e4%ba%8eid%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1" aria-label="4.4.5.åŸºäºIDè´Ÿè½½å‡è¡¡">4.4.5.åŸºäºIDè´Ÿè½½å‡è¡¡</a><ul>
                        
                <li>
                    <a href="#1%e5%8e%9f%e7%90%86" aria-label="1ï¼‰åŸç†">1ï¼‰åŸç†</a></li>
                <li>
                    <a href="#2%e5%ae%9e%e7%8e%b0" aria-label="2ï¼‰å®ç°">2ï¼‰å®ç°</a></li>
                <li>
                    <a href="#3%e6%b5%8b%e8%af%95" aria-label="3ï¼‰æµ‹è¯•">3ï¼‰æµ‹è¯•</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#45redis%e7%bc%93%e5%ad%98%e9%a2%84%e7%83%ad" aria-label="4.5.Redisç¼“å­˜é¢„çƒ­">4.5.Redisç¼“å­˜é¢„çƒ­</a></li>
                <li>
                    <a href="#46%e6%9f%a5%e8%af%a2redis%e7%bc%93%e5%ad%98" aria-label="4.6.æŸ¥è¯¢Redisç¼“å­˜">4.6.æŸ¥è¯¢Redisç¼“å­˜</a><ul>
                        
                <li>
                    <a href="#461%e5%b0%81%e8%a3%85redis%e5%b7%a5%e5%85%b7" aria-label="4.6.1.å°è£…Rediså·¥å…·">4.6.1.å°è£…Rediså·¥å…·</a></li>
                <li>
                    <a href="#462%e5%ae%9e%e7%8e%b0redis%e6%9f%a5%e8%af%a2" aria-label="4.6.2.å®ç°RedisæŸ¥è¯¢">4.6.2.å®ç°RedisæŸ¥è¯¢</a></li></ul>
                </li>
                <li>
                    <a href="#47nginx%e6%9c%ac%e5%9c%b0%e7%bc%93%e5%ad%98" aria-label="4.7.Nginxæœ¬åœ°ç¼“å­˜">4.7.Nginxæœ¬åœ°ç¼“å­˜</a><ul>
                        
                <li>
                    <a href="#471%e6%9c%ac%e5%9c%b0%e7%bc%93%e5%ad%98api" aria-label="4.7.1.æœ¬åœ°ç¼“å­˜API">4.7.1.æœ¬åœ°ç¼“å­˜API</a></li>
                <li>
                    <a href="#472%e5%ae%9e%e7%8e%b0%e6%9c%ac%e5%9c%b0%e7%bc%93%e5%ad%98%e6%9f%a5%e8%af%a2" aria-label="4.7.2.å®ç°æœ¬åœ°ç¼“å­˜æŸ¥è¯¢">4.7.2.å®ç°æœ¬åœ°ç¼“å­˜æŸ¥è¯¢</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#5%e7%bc%93%e5%ad%98%e5%90%8c%e6%ad%a5" aria-label="5.ç¼“å­˜åŒæ­¥">5.ç¼“å­˜åŒæ­¥</a><ul>
                        
                <li>
                    <a href="#51%e6%95%b0%e6%8d%ae%e5%90%8c%e6%ad%a5%e7%ad%96%e7%95%a5" aria-label="5.1.æ•°æ®åŒæ­¥ç­–ç•¥">5.1.æ•°æ®åŒæ­¥ç­–ç•¥</a></li>
                <li>
                    <a href="#52%e5%ae%89%e8%a3%85canal" aria-label="5.2.å®‰è£…Canal">5.2.å®‰è£…Canal</a><ul>
                        
                <li>
                    <a href="#521%e8%ae%a4%e8%af%86canal" aria-label="5.2.1.è®¤è¯†Canal">5.2.1.è®¤è¯†Canal</a></li>
                <li>
                    <a href="#522%e5%ae%89%e8%a3%85canal" aria-label="5.2.2.å®‰è£…Canal">5.2.2.å®‰è£…Canal</a></li></ul>
                </li>
                <li>
                    <a href="#53%e7%9b%91%e5%90%accanal" aria-label="5.3.ç›‘å¬Canal">5.3.ç›‘å¬Canal</a><ul>
                        
                <li>
                    <a href="#531%e5%bc%95%e5%85%a5%e4%be%9d%e8%b5%96" aria-label="5.3.1.å¼•å…¥ä¾èµ–ï¼š">5.3.1.å¼•å…¥ä¾èµ–ï¼š</a></li>
                <li>
                    <a href="#532%e7%bc%96%e5%86%99%e9%85%8d%e7%bd%ae" aria-label="5.3.2.ç¼–å†™é…ç½®ï¼š">5.3.2.ç¼–å†™é…ç½®ï¼š</a></li>
                <li>
                    <a href="#533%e4%bf%ae%e6%94%b9item%e5%ae%9e%e4%bd%93%e7%b1%bb" aria-label="5.3.3.ä¿®æ”¹Itemå®ä½“ç±»">5.3.3.ä¿®æ”¹Itemå®ä½“ç±»</a></li>
                <li>
                    <a href="#534%e7%bc%96%e5%86%99%e7%9b%91%e5%90%ac%e5%99%a8" aria-label="5.3.4.ç¼–å†™ç›‘å¬å™¨">5.3.4.ç¼–å†™ç›‘å¬å™¨</a>
                </li>
            </ul>
            </li>
            </ul>
            </li>
            </ul>
        </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
        
        activeElement = elements[0];
        const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
        document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
    }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        if (elements) {
            activeElement = Array.from(elements).find((element) => {
                if ((getOffsetTop(element) - window.pageYOffset) > 0 &&
                    (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                    return element;
                }
            }) || activeElement

            elements.forEach(element => {
                const id = encodeURI(element.getAttribute('id')).toLowerCase();
                if (element === activeElement){
                    document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
                } else {
                    document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
                }
            })
        }
    }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;
        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;
    }
</script>
        <div class="post-content"><h1 id="1ä»€ä¹ˆæ˜¯å¤šçº§ç¼“å­˜">1.ä»€ä¹ˆæ˜¯å¤šçº§ç¼“å­˜<a hidden class="anchor" aria-hidden="true" href="#1ä»€ä¹ˆæ˜¯å¤šçº§ç¼“å­˜">#</a></h1>
<p>ä¼ ç»Ÿçš„ç¼“å­˜ç­–ç•¥ä¸€èˆ¬æ˜¯è¯·æ±‚åˆ°è¾¾Tomcatåï¼Œå…ˆæŸ¥è¯¢Redisï¼Œå¦‚æœæœªå‘½ä¸­åˆ™æŸ¥è¯¢æ•°æ®åº“ï¼Œå¦‚å›¾ï¼š</p>
<p><img loading="lazy" src="./assets/image-20210821075259137.png" alt="image-20210821075259137"  />
</p>
<p>å­˜åœ¨ä¸‹é¢çš„é—®é¢˜ï¼š</p>
<p>â€¢è¯·æ±‚è¦ç»è¿‡Tomcatå¤„ç†ï¼ŒTomcatçš„æ€§èƒ½æˆä¸ºæ•´ä¸ªç³»ç»Ÿçš„ç“¶é¢ˆ</p>
<p>â€¢Redisç¼“å­˜å¤±æ•ˆæ—¶ï¼Œä¼šå¯¹æ•°æ®åº“äº§ç”Ÿå†²å‡»</p>
<p>å¤šçº§ç¼“å­˜å°±æ˜¯å……åˆ†åˆ©ç”¨è¯·æ±‚å¤„ç†çš„æ¯ä¸ªç¯èŠ‚ï¼Œåˆ†åˆ«æ·»åŠ ç¼“å­˜ï¼Œå‡è½»Tomcatå‹åŠ›ï¼Œæå‡æœåŠ¡æ€§èƒ½ï¼š</p>
<ul>
<li>æµè§ˆå™¨è®¿é—®é™æ€èµ„æºæ—¶ï¼Œä¼˜å…ˆè¯»å–æµè§ˆå™¨æœ¬åœ°ç¼“å­˜</li>
<li>è®¿é—®éé™æ€èµ„æºï¼ˆajaxæŸ¥è¯¢æ•°æ®ï¼‰æ—¶ï¼Œè®¿é—®æœåŠ¡ç«¯</li>
<li>è¯·æ±‚åˆ°è¾¾Nginxåï¼Œä¼˜å…ˆè¯»å–Nginxæœ¬åœ°ç¼“å­˜</li>
<li>å¦‚æœNginxæœ¬åœ°ç¼“å­˜æœªå‘½ä¸­ï¼Œåˆ™å»ç›´æ¥æŸ¥è¯¢Redisï¼ˆä¸ç»è¿‡Tomcatï¼‰</li>
<li>å¦‚æœRedisæŸ¥è¯¢æœªå‘½ä¸­ï¼Œåˆ™æŸ¥è¯¢Tomcat</li>
<li>è¯·æ±‚è¿›å…¥Tomcatåï¼Œä¼˜å…ˆæŸ¥è¯¢JVMè¿›ç¨‹ç¼“å­˜</li>
<li>å¦‚æœJVMè¿›ç¨‹ç¼“å­˜æœªå‘½ä¸­ï¼Œåˆ™æŸ¥è¯¢æ•°æ®åº“</li>
</ul>
<p><img loading="lazy" src="./assets/image-20210821075558137.png" alt="image-20210821075558137"  />
</p>
<p>åœ¨å¤šçº§ç¼“å­˜æ¶æ„ä¸­ï¼ŒNginxå†…éƒ¨éœ€è¦ç¼–å†™æœ¬åœ°ç¼“å­˜æŸ¥è¯¢ã€RedisæŸ¥è¯¢ã€TomcatæŸ¥è¯¢çš„ä¸šåŠ¡é€»è¾‘ï¼Œå› æ­¤è¿™æ ·çš„nginxæœåŠ¡ä¸å†æ˜¯ä¸€ä¸ª<strong>åå‘ä»£ç†æœåŠ¡å™¨</strong>ï¼Œè€Œæ˜¯ä¸€ä¸ªç¼–å†™<strong>ä¸šåŠ¡çš„WebæœåŠ¡å™¨äº†</strong>ã€‚</p>
<p>å› æ­¤è¿™æ ·çš„ä¸šåŠ¡NginxæœåŠ¡ä¹Ÿéœ€è¦æ­å»ºé›†ç¾¤æ¥æé«˜å¹¶å‘ï¼Œå†æœ‰ä¸“é—¨çš„nginxæœåŠ¡æ¥åšåå‘ä»£ç†ï¼Œå¦‚å›¾ï¼š</p>
<p><img loading="lazy" src="./assets/image-20210821080511581.png" alt="image-20210821080511581"  />
</p>
<p>å¦å¤–ï¼Œæˆ‘ä»¬çš„TomcatæœåŠ¡å°†æ¥ä¹Ÿä¼šéƒ¨ç½²ä¸ºé›†ç¾¤æ¨¡å¼ï¼š</p>
<p><img loading="lazy" src="./assets/image-20210821080954947.png" alt="image-20210821080954947"  />
</p>
<p>å¯è§ï¼Œå¤šçº§ç¼“å­˜çš„å…³é”®æœ‰ä¸¤ä¸ªï¼š</p>
<ul>
<li>
<p>ä¸€ä¸ªæ˜¯åœ¨nginxä¸­ç¼–å†™ä¸šåŠ¡ï¼Œå®ç°nginxæœ¬åœ°ç¼“å­˜ã€Redisã€Tomcatçš„æŸ¥è¯¢</p>
</li>
<li>
<p>å¦ä¸€ä¸ªå°±æ˜¯åœ¨Tomcatä¸­å®ç°JVMè¿›ç¨‹ç¼“å­˜</p>
</li>
</ul>
<p>å…¶ä¸­Nginxç¼–ç¨‹åˆ™ä¼šç”¨åˆ°OpenRestyæ¡†æ¶ç»“åˆLuaè¿™æ ·çš„è¯­è¨€ã€‚</p>
<p>è¿™ä¹Ÿæ˜¯ä»Šå¤©è¯¾ç¨‹çš„éš¾ç‚¹å’Œé‡ç‚¹ã€‚</p>
<h1 id="2jvmè¿›ç¨‹ç¼“å­˜">2.JVMè¿›ç¨‹ç¼“å­˜<a hidden class="anchor" aria-hidden="true" href="#2jvmè¿›ç¨‹ç¼“å­˜">#</a></h1>
<p>ä¸ºäº†æ¼”ç¤ºå¤šçº§ç¼“å­˜çš„æ¡ˆä¾‹ï¼Œæˆ‘ä»¬å…ˆå‡†å¤‡ä¸€ä¸ªå•†å“æŸ¥è¯¢çš„ä¸šåŠ¡ã€‚</p>
<h2 id="21å¯¼å…¥æ¡ˆä¾‹">2.1.å¯¼å…¥æ¡ˆä¾‹<a hidden class="anchor" aria-hidden="true" href="#21å¯¼å…¥æ¡ˆä¾‹">#</a></h2>
<p>å‚è€ƒè¯¾å‰èµ„æ–™çš„ï¼šã€Šæ¡ˆä¾‹å¯¼å…¥è¯´æ˜.mdã€‹</p>
<p><img loading="lazy" src="./assets/image-20210821081418456.png" alt="image-20210821081418456"  />
</p>
<h2 id="22åˆè¯†caffeine">2.2.åˆè¯†Caffeine<a hidden class="anchor" aria-hidden="true" href="#22åˆè¯†caffeine">#</a></h2>
<p>ç¼“å­˜åœ¨æ—¥å¸¸å¼€å‘ä¸­å¯åŠ¨è‡³å…³é‡è¦çš„ä½œç”¨ï¼Œç”±äºæ˜¯å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œæ•°æ®çš„è¯»å–é€Ÿåº¦æ˜¯éå¸¸å¿«çš„ï¼Œèƒ½å¤§é‡å‡å°‘å¯¹æ•°æ®åº“çš„è®¿é—®ï¼Œå‡å°‘æ•°æ®åº“çš„å‹åŠ›ã€‚æˆ‘ä»¬æŠŠç¼“å­˜åˆ†ä¸ºä¸¤ç±»ï¼š</p>
<ul>
<li>åˆ†å¸ƒå¼ç¼“å­˜ï¼Œä¾‹å¦‚Redisï¼š
<ul>
<li>ä¼˜ç‚¹ï¼šå­˜å‚¨å®¹é‡æ›´å¤§ã€å¯é æ€§æ›´å¥½ã€å¯ä»¥åœ¨é›†ç¾¤é—´å…±äº«</li>
<li>ç¼ºç‚¹ï¼šè®¿é—®ç¼“å­˜æœ‰ç½‘ç»œå¼€é”€</li>
<li>åœºæ™¯ï¼šç¼“å­˜æ•°æ®é‡è¾ƒå¤§ã€å¯é æ€§è¦æ±‚è¾ƒé«˜ã€éœ€è¦åœ¨é›†ç¾¤é—´å…±äº«</li>
</ul>
</li>
<li>è¿›ç¨‹æœ¬åœ°ç¼“å­˜ï¼Œä¾‹å¦‚HashMapã€GuavaCacheï¼š
<ul>
<li>ä¼˜ç‚¹ï¼šè¯»å–æœ¬åœ°å†…å­˜ï¼Œæ²¡æœ‰ç½‘ç»œå¼€é”€ï¼Œé€Ÿåº¦æ›´å¿«</li>
<li>ç¼ºç‚¹ï¼šå­˜å‚¨å®¹é‡æœ‰é™ã€å¯é æ€§è¾ƒä½ã€æ— æ³•å…±äº«</li>
<li>åœºæ™¯ï¼šæ€§èƒ½è¦æ±‚è¾ƒé«˜ï¼Œç¼“å­˜æ•°æ®é‡è¾ƒå°</li>
</ul>
</li>
</ul>
<p>æˆ‘ä»¬ä»Šå¤©ä¼šåˆ©ç”¨Caffeineæ¡†æ¶æ¥å®ç°JVMè¿›ç¨‹ç¼“å­˜ã€‚</p>
<p><strong>Caffeine</strong>æ˜¯ä¸€ä¸ªåŸºäºJava8å¼€å‘çš„ï¼Œæä¾›äº†è¿‘ä¹æœ€ä½³å‘½ä¸­ç‡çš„é«˜æ€§èƒ½çš„æœ¬åœ°ç¼“å­˜åº“ã€‚ç›®å‰Springå†…éƒ¨çš„ç¼“å­˜ä½¿ç”¨çš„å°±æ˜¯Caffeineã€‚GitHubåœ°å€ï¼šhttps://github.com/ben-manes/caffeine</p>
<p>Caffeineçš„æ€§èƒ½éå¸¸å¥½ï¼Œä¸‹å›¾æ˜¯å®˜æ–¹ç»™å‡ºçš„æ€§èƒ½å¯¹æ¯”ï¼š</p>
<p><img loading="lazy" src="assets/image-20210821081826399.png" alt="image-20210821081826399"  />
</p>
<p>å¯ä»¥çœ‹åˆ°Caffeineçš„æ€§èƒ½é¥é¥é¢†å…ˆï¼</p>
<p>ç¼“å­˜ä½¿ç”¨çš„åŸºæœ¬APIï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Test</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">testBasicOps</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// æ„å»ºcacheå¯¹è±¡</span>
</span></span><span style="display:flex;"><span>    Cache<span style="color:#f92672">&lt;</span>String, String<span style="color:#f92672">&gt;</span> cache <span style="color:#f92672">=</span> Caffeine.<span style="color:#a6e22e">newBuilder</span>().<span style="color:#a6e22e">build</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// å­˜æ•°æ®</span>
</span></span><span style="display:flex;"><span>    cache.<span style="color:#a6e22e">put</span>(<span style="color:#e6db74">&#34;gf&#34;</span>, <span style="color:#e6db74">&#34;è¿ªä¸½çƒ­å·´&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// å–æ•°æ®</span>
</span></span><span style="display:flex;"><span>    String gf <span style="color:#f92672">=</span> cache.<span style="color:#a6e22e">getIfPresent</span>(<span style="color:#e6db74">&#34;gf&#34;</span>);
</span></span><span style="display:flex;"><span>    System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(<span style="color:#e6db74">&#34;gf = &#34;</span> <span style="color:#f92672">+</span> gf);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// å–æ•°æ®ï¼ŒåŒ…å«ä¸¤ä¸ªå‚æ•°ï¼š</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// å‚æ•°ä¸€ï¼šç¼“å­˜çš„key</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// å‚æ•°äºŒï¼šLambdaè¡¨è¾¾å¼ï¼Œè¡¨è¾¾å¼å‚æ•°å°±æ˜¯ç¼“å­˜çš„keyï¼Œæ–¹æ³•ä½“æ˜¯æŸ¥è¯¢æ•°æ®åº“çš„é€»è¾‘</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ä¼˜å…ˆæ ¹æ®keyæŸ¥è¯¢JVMç¼“å­˜ï¼Œå¦‚æœæœªå‘½ä¸­ï¼Œåˆ™æ‰§è¡Œå‚æ•°äºŒçš„Lambdaè¡¨è¾¾å¼</span>
</span></span><span style="display:flex;"><span>    String defaultGF <span style="color:#f92672">=</span> cache.<span style="color:#a6e22e">get</span>(<span style="color:#e6db74">&#34;defaultGF&#34;</span>, key <span style="color:#f92672">-&gt;</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// æ ¹æ®keyå»æ•°æ®åº“æŸ¥è¯¢æ•°æ®</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;æŸ³å²©&#34;</span>;
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>    System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(<span style="color:#e6db74">&#34;defaultGF = &#34;</span> <span style="color:#f92672">+</span> defaultGF);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Caffeineæ—¢ç„¶æ˜¯ç¼“å­˜çš„ä¸€ç§ï¼Œè‚¯å®šéœ€è¦æœ‰ç¼“å­˜çš„æ¸…é™¤ç­–ç•¥ï¼Œä¸ç„¶çš„è¯å†…å­˜æ€»ä¼šæœ‰è€—å°½çš„æ—¶å€™ã€‚</p>
<p>Caffeineæä¾›äº†ä¸‰ç§ç¼“å­˜é©±é€ç­–ç•¥ï¼š</p>
<ul>
<li>
<p><strong>åŸºäºå®¹é‡</strong>ï¼šè®¾ç½®ç¼“å­˜çš„æ•°é‡ä¸Šé™</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">// åˆ›å»ºç¼“å­˜å¯¹è±¡</span>
</span></span><span style="display:flex;"><span>Cache<span style="color:#f92672">&lt;</span>String, String<span style="color:#f92672">&gt;</span> cache <span style="color:#f92672">=</span> Caffeine.<span style="color:#a6e22e">newBuilder</span>()
</span></span><span style="display:flex;"><span>    .<span style="color:#a6e22e">maximumSize</span>(1) <span style="color:#75715e">// è®¾ç½®ç¼“å­˜å¤§å°ä¸Šé™ä¸º 1</span>
</span></span><span style="display:flex;"><span>    .<span style="color:#a6e22e">build</span>();
</span></span></code></pre></div></li>
<li>
<p><strong>åŸºäºæ—¶é—´</strong>ï¼šè®¾ç½®ç¼“å­˜çš„æœ‰æ•ˆæ—¶é—´</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">// åˆ›å»ºç¼“å­˜å¯¹è±¡</span>
</span></span><span style="display:flex;"><span>Cache<span style="color:#f92672">&lt;</span>String, String<span style="color:#f92672">&gt;</span> cache <span style="color:#f92672">=</span> Caffeine.<span style="color:#a6e22e">newBuilder</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// è®¾ç½®ç¼“å­˜æœ‰æ•ˆæœŸä¸º 10 ç§’ï¼Œä»æœ€åä¸€æ¬¡å†™å…¥å¼€å§‹è®¡æ—¶ </span>
</span></span><span style="display:flex;"><span>    .<span style="color:#a6e22e">expireAfterWrite</span>(Duration.<span style="color:#a6e22e">ofSeconds</span>(10)) 
</span></span><span style="display:flex;"><span>    .<span style="color:#a6e22e">build</span>();
</span></span></code></pre></div></li>
<li>
<p><strong>åŸºäºå¼•ç”¨</strong>ï¼šè®¾ç½®ç¼“å­˜ä¸ºè½¯å¼•ç”¨æˆ–å¼±å¼•ç”¨ï¼Œåˆ©ç”¨GCæ¥å›æ”¶ç¼“å­˜æ•°æ®ã€‚æ€§èƒ½è¾ƒå·®ï¼Œä¸å»ºè®®ä½¿ç”¨ã€‚</p>
</li>
</ul>
<blockquote>
<p><strong>æ³¨æ„</strong>ï¼šåœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œå½“ä¸€ä¸ªç¼“å­˜å…ƒç´ è¿‡æœŸçš„æ—¶å€™ï¼ŒCaffeineä¸ä¼šè‡ªåŠ¨ç«‹å³å°†å…¶æ¸…ç†å’Œé©±é€ã€‚è€Œæ˜¯åœ¨ä¸€æ¬¡è¯»æˆ–å†™æ“ä½œåï¼Œæˆ–è€…åœ¨ç©ºé—²æ—¶é—´å®Œæˆå¯¹å¤±æ•ˆæ•°æ®çš„é©±é€ã€‚</p>
</blockquote>
<h2 id="23å®ç°jvmè¿›ç¨‹ç¼“å­˜">2.3.å®ç°JVMè¿›ç¨‹ç¼“å­˜<a hidden class="anchor" aria-hidden="true" href="#23å®ç°jvmè¿›ç¨‹ç¼“å­˜">#</a></h2>
<h3 id="231éœ€æ±‚">2.3.1.éœ€æ±‚<a hidden class="anchor" aria-hidden="true" href="#231éœ€æ±‚">#</a></h3>
<p>åˆ©ç”¨Caffeineå®ç°ä¸‹åˆ—éœ€æ±‚ï¼š</p>
<ul>
<li>ç»™æ ¹æ®idæŸ¥è¯¢å•†å“çš„ä¸šåŠ¡æ·»åŠ ç¼“å­˜ï¼Œç¼“å­˜æœªå‘½ä¸­æ—¶æŸ¥è¯¢æ•°æ®åº“</li>
<li>ç»™æ ¹æ®idæŸ¥è¯¢å•†å“åº“å­˜çš„ä¸šåŠ¡æ·»åŠ ç¼“å­˜ï¼Œç¼“å­˜æœªå‘½ä¸­æ—¶æŸ¥è¯¢æ•°æ®åº“</li>
<li>ç¼“å­˜åˆå§‹å¤§å°ä¸º100</li>
<li>ç¼“å­˜ä¸Šé™ä¸º10000</li>
</ul>
<h3 id="232å®ç°">2.3.2.å®ç°<a hidden class="anchor" aria-hidden="true" href="#232å®ç°">#</a></h3>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦å®šä¹‰ä¸¤ä¸ªCaffeineçš„ç¼“å­˜å¯¹è±¡ï¼Œåˆ†åˆ«ä¿å­˜å•†å“ã€åº“å­˜çš„ç¼“å­˜æ•°æ®ã€‚</p>
<p>åœ¨item-serviceçš„<code>com.heima.item.config</code>åŒ…ä¸‹å®šä¹‰<code>CaffeineConfig</code>ç±»ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">package</span> com.heima.item.config;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> com.github.benmanes.caffeine.cache.Cache;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> com.github.benmanes.caffeine.cache.Caffeine;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> com.heima.item.pojo.Item;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> com.heima.item.pojo.ItemStock;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.context.annotation.Bean;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.context.annotation.Configuration;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Configuration</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CaffeineConfig</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Bean</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> Cache<span style="color:#f92672">&lt;</span>Long, Item<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">itemCache</span>(){
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> Caffeine.<span style="color:#a6e22e">newBuilder</span>()
</span></span><span style="display:flex;"><span>                .<span style="color:#a6e22e">initialCapacity</span>(100)
</span></span><span style="display:flex;"><span>                .<span style="color:#a6e22e">maximumSize</span>(10_000)
</span></span><span style="display:flex;"><span>                .<span style="color:#a6e22e">build</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Bean</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> Cache<span style="color:#f92672">&lt;</span>Long, ItemStock<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">stockCache</span>(){
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> Caffeine.<span style="color:#a6e22e">newBuilder</span>()
</span></span><span style="display:flex;"><span>                .<span style="color:#a6e22e">initialCapacity</span>(100)
</span></span><span style="display:flex;"><span>                .<span style="color:#a6e22e">maximumSize</span>(10_000)
</span></span><span style="display:flex;"><span>                .<span style="color:#a6e22e">build</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>ç„¶åï¼Œä¿®æ”¹item-serviceä¸­çš„<code>com.heima.item.web</code>åŒ…ä¸‹çš„ItemControllerç±»ï¼Œæ·»åŠ ç¼“å­˜é€»è¾‘ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@RestController</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@RequestMapping</span>(<span style="color:#e6db74">&#34;item&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ItemController</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> IItemService itemService;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> IItemStockService stockService;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> Cache<span style="color:#f92672">&lt;</span>Long, Item<span style="color:#f92672">&gt;</span> itemCache;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> Cache<span style="color:#f92672">&lt;</span>Long, ItemStock<span style="color:#f92672">&gt;</span> stockCache;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ...å…¶å®ƒç•¥</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@GetMapping</span>(<span style="color:#e6db74">&#34;/{id}&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> Item <span style="color:#a6e22e">findById</span>(<span style="color:#a6e22e">@PathVariable</span>(<span style="color:#e6db74">&#34;id&#34;</span>) Long id) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> itemCache.<span style="color:#a6e22e">get</span>(id, key <span style="color:#f92672">-&gt;</span> itemService.<span style="color:#a6e22e">query</span>()
</span></span><span style="display:flex;"><span>                .<span style="color:#a6e22e">ne</span>(<span style="color:#e6db74">&#34;status&#34;</span>, 3).<span style="color:#a6e22e">eq</span>(<span style="color:#e6db74">&#34;id&#34;</span>, key)
</span></span><span style="display:flex;"><span>                .<span style="color:#a6e22e">one</span>()
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@GetMapping</span>(<span style="color:#e6db74">&#34;/stock/{id}&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> ItemStock <span style="color:#a6e22e">findStockById</span>(<span style="color:#a6e22e">@PathVariable</span>(<span style="color:#e6db74">&#34;id&#34;</span>) Long id) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> stockCache.<span style="color:#a6e22e">get</span>(id, key <span style="color:#f92672">-&gt;</span> stockService.<span style="color:#a6e22e">getById</span>(key));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h1 id="3luaè¯­æ³•å…¥é—¨">3.Luaè¯­æ³•å…¥é—¨<a hidden class="anchor" aria-hidden="true" href="#3luaè¯­æ³•å…¥é—¨">#</a></h1>
<p>Nginxç¼–ç¨‹éœ€è¦ç”¨åˆ°Luaè¯­è¨€ï¼Œå› æ­¤æˆ‘ä»¬å¿…é¡»å…ˆå…¥é—¨Luaçš„åŸºæœ¬è¯­æ³•ã€‚</p>
<h2 id="31åˆè¯†lua">3.1.åˆè¯†Lua<a hidden class="anchor" aria-hidden="true" href="#31åˆè¯†lua">#</a></h2>
<p>Lua æ˜¯ä¸€ç§è½»é‡å°å·§çš„è„šæœ¬è¯­è¨€ï¼Œç”¨æ ‡å‡†Cè¯­è¨€ç¼–å†™å¹¶ä»¥æºä»£ç å½¢å¼å¼€æ”¾ï¼Œ å…¶è®¾è®¡ç›®çš„æ˜¯ä¸ºäº†åµŒå…¥åº”ç”¨ç¨‹åºä¸­ï¼Œä»è€Œä¸ºåº”ç”¨ç¨‹åºæä¾›çµæ´»çš„æ‰©å±•å’Œå®šåˆ¶åŠŸèƒ½ã€‚å®˜ç½‘ï¼šhttps://www.lua.org/</p>
<p><img loading="lazy" src="./assets/image-20210821091437975.png" alt="image-20210821091437975"  />
</p>
<p>Luaç»å¸¸åµŒå…¥åˆ°Cè¯­è¨€å¼€å‘çš„ç¨‹åºä¸­ï¼Œä¾‹å¦‚æ¸¸æˆå¼€å‘ã€æ¸¸æˆæ’ä»¶ç­‰ã€‚</p>
<p>Nginxæœ¬èº«ä¹Ÿæ˜¯Cè¯­è¨€å¼€å‘ï¼Œå› æ­¤ä¹Ÿå…è®¸åŸºäºLuaåšæ‹“å±•ã€‚</p>
<h2 id="31helloworld">3.1.HelloWorld<a hidden class="anchor" aria-hidden="true" href="#31helloworld">#</a></h2>
<p>CentOS7é»˜è®¤å·²ç»å®‰è£…äº†Luaè¯­è¨€ç¯å¢ƒï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥è¿è¡ŒLuaä»£ç ã€‚</p>
<p>1ï¼‰åœ¨Linuxè™šæ‹Ÿæœºçš„ä»»æ„ç›®å½•ä¸‹ï¼Œæ–°å»ºä¸€ä¸ªhello.luaæ–‡ä»¶</p>
<p><img loading="lazy" src="./assets/image-20210821091621308.png" alt="image-20210821091621308"  />
</p>
<p>2ï¼‰æ·»åŠ ä¸‹é¢çš„å†…å®¹</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;Hello World!&#34;</span>)  
</span></span></code></pre></div><p>3ï¼‰è¿è¡Œ</p>
<p><img loading="lazy" src="./assets/image-20210821091638140.png" alt="image-20210821091638140"  />
</p>
<h2 id="32å˜é‡å’Œå¾ªç¯">3.2.å˜é‡å’Œå¾ªç¯<a hidden class="anchor" aria-hidden="true" href="#32å˜é‡å’Œå¾ªç¯">#</a></h2>
<p>å­¦ä¹ ä»»ä½•è¯­è¨€å¿…ç„¶ç¦»ä¸å¼€å˜é‡ï¼Œè€Œå˜é‡çš„å£°æ˜å¿…é¡»å…ˆçŸ¥é“æ•°æ®çš„ç±»å‹ã€‚</p>
<h3 id="321luaçš„æ•°æ®ç±»å‹">3.2.1.Luaçš„æ•°æ®ç±»å‹<a hidden class="anchor" aria-hidden="true" href="#321luaçš„æ•°æ®ç±»å‹">#</a></h3>
<p>Luaä¸­æ”¯æŒçš„å¸¸è§æ•°æ®ç±»å‹åŒ…æ‹¬ï¼š</p>
<p><img loading="lazy" src="./assets/image-20210821091835406.png" alt="image-20210821091835406"  />
</p>
<p>å¦å¤–ï¼ŒLuaæä¾›äº†type()å‡½æ•°æ¥åˆ¤æ–­ä¸€ä¸ªå˜é‡çš„æ•°æ®ç±»å‹ï¼š</p>
<p><img loading="lazy" src="./assets/image-20210821091904332.png" alt="image-20210821091904332"  />
</p>
<h3 id="322å£°æ˜å˜é‡">3.2.2.å£°æ˜å˜é‡<a hidden class="anchor" aria-hidden="true" href="#322å£°æ˜å˜é‡">#</a></h3>
<p>Luaå£°æ˜å˜é‡çš„æ—¶å€™æ— éœ€æŒ‡å®šæ•°æ®ç±»å‹ï¼Œè€Œæ˜¯ç”¨localæ¥å£°æ˜å˜é‡ä¸ºå±€éƒ¨å˜é‡ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#75715e">-- å£°æ˜å­—ç¬¦ä¸²ï¼Œå¯ä»¥ç”¨å•å¼•å·æˆ–åŒå¼•å·ï¼Œ</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">local</span> str <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;hello&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- å­—ç¬¦ä¸²æ‹¼æ¥å¯ä»¥ä½¿ç”¨ ..</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">local</span> str2 <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;hello&#39;</span> <span style="color:#f92672">..</span> <span style="color:#e6db74">&#39;world&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- å£°æ˜æ•°å­—</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">local</span> num <span style="color:#f92672">=</span> <span style="color:#ae81ff">21</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- å£°æ˜å¸ƒå°”ç±»å‹</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">local</span> flag <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>
</span></span></code></pre></div><p>Luaä¸­çš„tableç±»å‹æ—¢å¯ä»¥ä½œä¸ºæ•°ç»„ï¼Œåˆå¯ä»¥ä½œä¸ºJavaä¸­çš„mapæ¥ä½¿ç”¨ã€‚æ•°ç»„å°±æ˜¯ç‰¹æ®Šçš„tableï¼Œkeyæ˜¯æ•°ç»„è§’æ ‡è€Œå·²ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#75715e">-- å£°æ˜æ•°ç»„ ï¼Œkeyä¸ºè§’æ ‡çš„ table</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">local</span> arr <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#39;java&#39;</span>, <span style="color:#e6db74">&#39;python&#39;</span>, <span style="color:#e6db74">&#39;lua&#39;</span>}
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- å£°æ˜tableï¼Œç±»ä¼¼javaçš„map</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">local</span> map <span style="color:#f92672">=</span>  {name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Jack&#39;</span>, age<span style="color:#f92672">=</span><span style="color:#ae81ff">21</span>}
</span></span></code></pre></div><p>Luaä¸­çš„æ•°ç»„è§’æ ‡æ˜¯ä»1å¼€å§‹ï¼Œè®¿é—®çš„æ—¶å€™ä¸Javaä¸­ç±»ä¼¼ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#75715e">-- è®¿é—®æ•°ç»„ï¼Œluaæ•°ç»„çš„è§’æ ‡ä»1å¼€å§‹</span>
</span></span><span style="display:flex;"><span>print(arr[<span style="color:#ae81ff">1</span>])
</span></span></code></pre></div><p>Luaä¸­çš„tableå¯ä»¥ç”¨keyæ¥è®¿é—®ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#75715e">-- è®¿é—®table</span>
</span></span><span style="display:flex;"><span>print(map[<span style="color:#e6db74">&#39;name&#39;</span>])
</span></span><span style="display:flex;"><span>print(map.name)
</span></span></code></pre></div><h3 id="323å¾ªç¯">3.2.3.å¾ªç¯<a hidden class="anchor" aria-hidden="true" href="#323å¾ªç¯">#</a></h3>
<p>å¯¹äºtableï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨forå¾ªç¯æ¥éå†ã€‚ä¸è¿‡æ•°ç»„å’Œæ™®é€štableéå†ç•¥æœ‰å·®å¼‚ã€‚</p>
<p>éå†æ•°ç»„ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#75715e">-- å£°æ˜æ•°ç»„ keyä¸ºç´¢å¼•çš„ table</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">local</span> arr <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#39;java&#39;</span>, <span style="color:#e6db74">&#39;python&#39;</span>, <span style="color:#e6db74">&#39;lua&#39;</span>}
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- éå†æ•°ç»„</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> index,value <span style="color:#66d9ef">in</span> ipairs(arr) <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>    print(index, value) 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span></code></pre></div><p>éå†æ™®é€štable</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#75715e">-- å£°æ˜mapï¼Œä¹Ÿå°±æ˜¯table</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">local</span> map <span style="color:#f92672">=</span> {name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Jack&#39;</span>, age<span style="color:#f92672">=</span><span style="color:#ae81ff">21</span>}
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- éå†table</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> key,value <span style="color:#66d9ef">in</span> pairs(map) <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>   print(key, value) 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span></code></pre></div><h2 id="33æ¡ä»¶æ§åˆ¶å‡½æ•°">3.3.æ¡ä»¶æ§åˆ¶ã€å‡½æ•°<a hidden class="anchor" aria-hidden="true" href="#33æ¡ä»¶æ§åˆ¶å‡½æ•°">#</a></h2>
<p>Luaä¸­çš„æ¡ä»¶æ§åˆ¶å’Œå‡½æ•°å£°æ˜ä¸Javaç±»ä¼¼ã€‚</p>
<h3 id="331å‡½æ•°">3.3.1.å‡½æ•°<a hidden class="anchor" aria-hidden="true" href="#331å‡½æ•°">#</a></h3>
<p>å®šä¹‰å‡½æ•°çš„è¯­æ³•ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">å‡½æ•°å</span>( argument1, argument2..., argumentn)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">-- å‡½æ•°ä½“</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#960050;background-color:#1e0010">è¿”å›å€¼</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span></code></pre></div><p>ä¾‹å¦‚ï¼Œå®šä¹‰ä¸€ä¸ªå‡½æ•°ï¼Œç”¨æ¥æ‰“å°æ•°ç»„ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">printArr</span>(arr)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> index, value <span style="color:#66d9ef">in</span> ipairs(arr) <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>        print(value)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span></code></pre></div><h3 id="332æ¡ä»¶æ§åˆ¶">3.3.2.æ¡ä»¶æ§åˆ¶<a hidden class="anchor" aria-hidden="true" href="#332æ¡ä»¶æ§åˆ¶">#</a></h3>
<p>ç±»ä¼¼Javaçš„æ¡ä»¶æ§åˆ¶ï¼Œä¾‹å¦‚ifã€elseè¯­æ³•ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#66d9ef">if</span>(<span style="color:#960050;background-color:#1e0010">å¸ƒå°”è¡¨è¾¾å¼</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">--[ å¸ƒå°”è¡¨è¾¾å¼ä¸º true æ—¶æ‰§è¡Œè¯¥è¯­å¥å— --]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">--[ å¸ƒå°”è¡¨è¾¾å¼ä¸º false æ—¶æ‰§è¡Œè¯¥è¯­å¥å— --]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span></code></pre></div><p>ä¸javaä¸åŒï¼Œå¸ƒå°”è¡¨è¾¾å¼ä¸­çš„é€»è¾‘è¿ç®—æ˜¯åŸºäºè‹±æ–‡å•è¯ï¼š</p>
<p><img loading="lazy" src="./assets/image-20210821092657918.png" alt="image-20210821092657918"  />
</p>
<h3 id="333æ¡ˆä¾‹">3.3.3.æ¡ˆä¾‹<a hidden class="anchor" aria-hidden="true" href="#333æ¡ˆä¾‹">#</a></h3>
<p>éœ€æ±‚ï¼šè‡ªå®šä¹‰ä¸€ä¸ªå‡½æ•°ï¼Œå¯ä»¥æ‰“å°tableï¼Œå½“å‚æ•°ä¸ºnilæ—¶ï¼Œæ‰“å°é”™è¯¯ä¿¡æ¯</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">printArr</span>(arr)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> arr <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#39;æ•°ç»„ä¸èƒ½ä¸ºç©ºï¼&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> index, value <span style="color:#66d9ef">in</span> ipairs(arr) <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>        print(value)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span></code></pre></div><h1 id="4å®ç°å¤šçº§ç¼“å­˜">4.å®ç°å¤šçº§ç¼“å­˜<a hidden class="anchor" aria-hidden="true" href="#4å®ç°å¤šçº§ç¼“å­˜">#</a></h1>
<p>å¤šçº§ç¼“å­˜çš„å®ç°ç¦»ä¸å¼€Nginxç¼–ç¨‹ï¼Œè€ŒNginxç¼–ç¨‹åˆç¦»ä¸å¼€OpenRestyã€‚</p>
<h2 id="41å®‰è£…openresty">4.1.å®‰è£…OpenResty<a hidden class="anchor" aria-hidden="true" href="#41å®‰è£…openresty">#</a></h2>
<p>OpenRestyÂ® æ˜¯ä¸€ä¸ªåŸºäº Nginxçš„é«˜æ€§èƒ½ Web å¹³å°ï¼Œç”¨äºæ–¹ä¾¿åœ°æ­å»ºèƒ½å¤Ÿå¤„ç†è¶…é«˜å¹¶å‘ã€æ‰©å±•æ€§æé«˜çš„åŠ¨æ€ Web åº”ç”¨ã€Web æœåŠ¡å’ŒåŠ¨æ€ç½‘å…³ã€‚å…·å¤‡ä¸‹åˆ—ç‰¹ç‚¹ï¼š</p>
<ul>
<li>å…·å¤‡Nginxçš„å®Œæ•´åŠŸèƒ½</li>
<li>åŸºäºLuaè¯­è¨€è¿›è¡Œæ‰©å±•ï¼Œé›†æˆäº†å¤§é‡ç²¾è‰¯çš„ Lua åº“ã€ç¬¬ä¸‰æ–¹æ¨¡å—</li>
<li>å…è®¸ä½¿ç”¨Lua<strong>è‡ªå®šä¹‰ä¸šåŠ¡é€»è¾‘</strong>ã€<strong>è‡ªå®šä¹‰åº“</strong></li>
</ul>
<p>å®˜æ–¹ç½‘ç«™ï¼š <a href="https://openresty.org/cn/">https://openresty.org/cn/</a></p>
<p><img loading="lazy" src="./assets/image-20210821092902946.png" alt="image-20210821092902946"  />
</p>
<p>å®‰è£…Luaå¯ä»¥å‚è€ƒè¯¾å‰èµ„æ–™æä¾›çš„ã€Šå®‰è£…OpenResty.mdã€‹ï¼š</p>
<p><img loading="lazy" src="./assets/image-20210821092941139.png" alt="image-20210821092941139"  />
</p>
<h2 id="42openrestyå¿«é€Ÿå…¥é—¨">4.2.OpenRestyå¿«é€Ÿå…¥é—¨<a hidden class="anchor" aria-hidden="true" href="#42openrestyå¿«é€Ÿå…¥é—¨">#</a></h2>
<p>æˆ‘ä»¬å¸Œæœ›è¾¾åˆ°çš„å¤šçº§ç¼“å­˜æ¶æ„å¦‚å›¾ï¼š</p>
<p><img loading="lazy" src="assets/yeVDlwtfMx.png" alt="yeVDlwtfMx"  />
</p>
<p>å…¶ä¸­ï¼š</p>
<ul>
<li>
<p>windowsä¸Šçš„nginxç”¨æ¥åšåå‘ä»£ç†æœåŠ¡ï¼Œå°†å‰ç«¯çš„æŸ¥è¯¢å•†å“çš„ajaxè¯·æ±‚ä»£ç†åˆ°OpenRestyé›†ç¾¤</p>
</li>
<li>
<p>OpenRestyé›†ç¾¤ç”¨æ¥ç¼–å†™å¤šçº§ç¼“å­˜ä¸šåŠ¡</p>
</li>
</ul>
<h3 id="421åå‘ä»£ç†æµç¨‹">4.2.1.åå‘ä»£ç†æµç¨‹<a hidden class="anchor" aria-hidden="true" href="#421åå‘ä»£ç†æµç¨‹">#</a></h3>
<p>ç°åœ¨ï¼Œå•†å“è¯¦æƒ…é¡µä½¿ç”¨çš„æ˜¯å‡çš„å•†å“æ•°æ®ã€‚ä¸è¿‡åœ¨æµè§ˆå™¨ä¸­ï¼Œå¯ä»¥çœ‹åˆ°é¡µé¢æœ‰å‘èµ·ajaxè¯·æ±‚æŸ¥è¯¢çœŸå®å•†å“æ•°æ®ã€‚</p>
<p>è¿™ä¸ªè¯·æ±‚å¦‚ä¸‹ï¼š</p>
<p><img loading="lazy" src="assets/image-20210821093144700.png" alt="image-20210821093144700"  />
</p>
<p>è¯·æ±‚åœ°å€æ˜¯localhostï¼Œç«¯å£æ˜¯80ï¼Œå°±è¢«windowsä¸Šå®‰è£…çš„NginxæœåŠ¡ç»™æ¥æ”¶åˆ°äº†ã€‚ç„¶åä»£ç†ç»™äº†OpenRestyé›†ç¾¤ï¼š</p>
<p><img loading="lazy" src="assets/image-20210821094447709.png" alt="image-20210821094447709"  />
</p>
<p>æˆ‘ä»¬éœ€è¦åœ¨OpenRestyä¸­ç¼–å†™ä¸šåŠ¡ï¼ŒæŸ¥è¯¢å•†å“æ•°æ®å¹¶è¿”å›åˆ°æµè§ˆå™¨ã€‚</p>
<p>ä½†æ˜¯è¿™æ¬¡ï¼Œæˆ‘ä»¬å…ˆåœ¨OpenRestyæ¥æ”¶è¯·æ±‚ï¼Œè¿”å›å‡çš„å•†å“æ•°æ®ã€‚</p>
<h3 id="422openrestyç›‘å¬è¯·æ±‚">4.2.2.OpenRestyç›‘å¬è¯·æ±‚<a hidden class="anchor" aria-hidden="true" href="#422openrestyç›‘å¬è¯·æ±‚">#</a></h3>
<p>OpenRestyçš„å¾ˆå¤šåŠŸèƒ½éƒ½ä¾èµ–äºå…¶ç›®å½•ä¸‹çš„Luaåº“ï¼Œéœ€è¦åœ¨nginx.confä¸­æŒ‡å®šä¾èµ–åº“çš„ç›®å½•ï¼Œå¹¶å¯¼å…¥ä¾èµ–ï¼š</p>
<p>1ï¼‰æ·»åŠ å¯¹OpenRestyçš„Luaæ¨¡å—çš„åŠ è½½</p>
<p>ä¿®æ”¹<code>/usr/local/openresty/nginx/conf/nginx.conf</code>æ–‡ä»¶ï¼Œåœ¨å…¶ä¸­çš„httpä¸‹é¢ï¼Œæ·»åŠ ä¸‹é¢ä»£ç ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#75715e">#lua æ¨¡å—
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">lua_package_path</span> <span style="color:#e6db74">&#34;/usr/local/openresty/lualib/?.lua</span>;;<span style="color:#66d9ef">&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e">#cæ¨¡å—     
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">lua_package_cpath</span> <span style="color:#e6db74">&#34;/usr/local/openresty/lualib/?.so</span>;;<span style="color:#66d9ef">&#34;</span>;  
</span></span></code></pre></div><p>2ï¼‰ç›‘å¬/api/itemè·¯å¾„</p>
<p>ä¿®æ”¹<code>/usr/local/openresty/nginx/conf/nginx.conf</code>æ–‡ä»¶ï¼Œåœ¨nginx.confçš„serverä¸‹é¢ï¼Œæ·»åŠ å¯¹/api/itemè¿™ä¸ªè·¯å¾„çš„ç›‘å¬ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">location</span>  <span style="color:#e6db74">/api/item</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># é»˜è®¤çš„å“åº”ç±»å‹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">default_type</span> <span style="color:#e6db74">application/json</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># å“åº”ç»“æœç”±lua/item.luaæ–‡ä»¶æ¥å†³å®š
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">content_by_lua_file</span> <span style="color:#e6db74">lua/item.lua</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>è¿™ä¸ªç›‘å¬ï¼Œå°±ç±»ä¼¼äºSpringMVCä¸­çš„<code>@GetMapping(&quot;/api/item&quot;)</code>åšè·¯å¾„æ˜ å°„ã€‚</p>
<p>è€Œ<code>content_by_lua_file lua/item.lua</code>åˆ™ç›¸å½“äºè°ƒç”¨item.luaè¿™ä¸ªæ–‡ä»¶ï¼Œæ‰§è¡Œå…¶ä¸­çš„ä¸šåŠ¡ï¼ŒæŠŠç»“æœè¿”å›ç»™ç”¨æˆ·ã€‚ç›¸å½“äºjavaä¸­è°ƒç”¨serviceã€‚</p>
<h3 id="423ç¼–å†™itemlua">4.2.3.ç¼–å†™item.lua<a hidden class="anchor" aria-hidden="true" href="#423ç¼–å†™itemlua">#</a></h3>
<p>1ï¼‰åœ¨<code>/usr/loca/openresty/nginx</code>ç›®å½•åˆ›å»ºæ–‡ä»¶å¤¹ï¼šlua</p>
<p><img loading="lazy" src="assets/image-20210821100755080.png" alt="image-20210821100755080"  />
</p>
<p>2ï¼‰åœ¨<code>/usr/loca/openresty/nginx/lua</code>æ–‡ä»¶å¤¹ä¸‹ï¼Œæ–°å»ºæ–‡ä»¶ï¼šitem.lua</p>
<p><img loading="lazy" src="assets/image-20210821100801756.png" alt="image-20210821100801756"  />
</p>
<p>3ï¼‰ç¼–å†™item.luaï¼Œè¿”å›å‡æ•°æ®</p>
<p>item.luaä¸­ï¼Œåˆ©ç”¨ngx.say()å‡½æ•°è¿”å›æ•°æ®åˆ°Responseä¸­</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>ngx.say(<span style="color:#e6db74">&#39;{&#34;id&#34;:10001,&#34;name&#34;:&#34;SALSA AIR&#34;,&#34;title&#34;:&#34;RIMOWA 21å¯¸æ‰˜è¿ç®±æ‹‰æ†ç®± SALSA AIRç³»åˆ—æœç»¿è‰² 820.70.36.4&#34;,&#34;price&#34;:17900,&#34;image&#34;:&#34;https://m.360buyimg.com/mobilecms/s720x720_jfs/t6934/364/1195375010/84676/e9f2c55f/597ece38N0ddcbc77.jpg!q70.jpg.webp&#34;,&#34;category&#34;:&#34;æ‹‰æ†ç®±&#34;,&#34;brand&#34;:&#34;RIMOWA&#34;,&#34;spec&#34;:&#34;&#34;,&#34;status&#34;:1,&#34;createTime&#34;:&#34;2019-04-30T16:00:00.000+00:00&#34;,&#34;updateTime&#34;:&#34;2019-04-30T16:00:00.000+00:00&#34;,&#34;stock&#34;:2999,&#34;sold&#34;:31290}&#39;</span>)
</span></span></code></pre></div><p>4ï¼‰é‡æ–°åŠ è½½é…ç½®</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>nginx -s reload
</span></span></code></pre></div><p>åˆ·æ–°å•†å“é¡µé¢ï¼šhttp://localhost/item.html?id=1001ï¼Œå³å¯çœ‹åˆ°æ•ˆæœï¼š</p>
<p><img loading="lazy" src="assets/image-20210821101217089.png" alt="image-20210821101217089"  />
</p>
<h2 id="43è¯·æ±‚å‚æ•°å¤„ç†">4.3.è¯·æ±‚å‚æ•°å¤„ç†<a hidden class="anchor" aria-hidden="true" href="#43è¯·æ±‚å‚æ•°å¤„ç†">#</a></h2>
<p>ä¸Šä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬åœ¨OpenRestyæ¥æ”¶å‰ç«¯è¯·æ±‚ï¼Œä½†æ˜¯è¿”å›çš„æ˜¯å‡æ•°æ®ã€‚</p>
<p>è¦è¿”å›çœŸå®æ•°æ®ï¼Œå¿…é¡»æ ¹æ®å‰ç«¯ä¼ é€’æ¥çš„å•†å“idï¼ŒæŸ¥è¯¢å•†å“ä¿¡æ¯æ‰å¯ä»¥ã€‚</p>
<p>é‚£ä¹ˆå¦‚ä½•è·å–å‰ç«¯ä¼ é€’çš„å•†å“å‚æ•°å‘¢ï¼Ÿ</p>
<h3 id="431è·å–å‚æ•°çš„api">4.3.1.è·å–å‚æ•°çš„API<a hidden class="anchor" aria-hidden="true" href="#431è·å–å‚æ•°çš„api">#</a></h3>
<p>OpenRestyä¸­æä¾›äº†ä¸€äº›APIç”¨æ¥è·å–ä¸åŒç±»å‹çš„å‰ç«¯è¯·æ±‚å‚æ•°ï¼š</p>
<p><img loading="lazy" src="assets/image-20210821101433528.png" alt="image-20210821101433528"  />
</p>
<h3 id="432è·å–å‚æ•°å¹¶è¿”å›">4.3.2.è·å–å‚æ•°å¹¶è¿”å›<a hidden class="anchor" aria-hidden="true" href="#432è·å–å‚æ•°å¹¶è¿”å›">#</a></h3>
<p>åœ¨å‰ç«¯å‘èµ·çš„ajaxè¯·æ±‚å¦‚å›¾ï¼š</p>
<p><img loading="lazy" src="assets/image-20210821101721649.png" alt="image-20210821101721649"  />
</p>
<p>å¯ä»¥çœ‹åˆ°å•†å“idæ˜¯ä»¥è·¯å¾„å ä½ç¬¦æ–¹å¼ä¼ é€’çš„ï¼Œå› æ­¤å¯ä»¥åˆ©ç”¨æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…çš„æ–¹å¼æ¥è·å–ID</p>
<p>1ï¼‰è·å–å•†å“id</p>
<p>ä¿®æ”¹<code>/usr/loca/openresty/nginx/nginx.conf</code>æ–‡ä»¶ä¸­ç›‘å¬/api/itemçš„ä»£ç ï¼Œåˆ©ç”¨æ­£åˆ™è¡¨è¾¾å¼è·å–IDï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">location</span> ~ <span style="color:#e6db74">/api/item/(\d+)</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># é»˜è®¤çš„å“åº”ç±»å‹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">default_type</span> <span style="color:#e6db74">application/json</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># å“åº”ç»“æœç”±lua/item.luaæ–‡ä»¶æ¥å†³å®š
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">content_by_lua_file</span> <span style="color:#e6db74">lua/item.lua</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>2ï¼‰æ‹¼æ¥IDå¹¶è¿”å›</p>
<p>ä¿®æ”¹<code>/usr/loca/openresty/nginx/lua/item.lua</code>æ–‡ä»¶ï¼Œè·å–idå¹¶æ‹¼æ¥åˆ°ç»“æœä¸­è¿”å›ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#75715e">-- è·å–å•†å“id</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">local</span> id <span style="color:#f92672">=</span> ngx.var[<span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- æ‹¼æ¥å¹¶è¿”å›</span>
</span></span><span style="display:flex;"><span>ngx.say(<span style="color:#e6db74">&#39;{&#34;id&#34;:&#39;</span> <span style="color:#f92672">..</span> id <span style="color:#f92672">..</span> <span style="color:#e6db74">&#39;,&#34;name&#34;:&#34;SALSA AIR&#34;,&#34;title&#34;:&#34;RIMOWA 21å¯¸æ‰˜è¿ç®±æ‹‰æ†ç®± SALSA AIRç³»åˆ—æœç»¿è‰² 820.70.36.4&#34;,&#34;price&#34;:17900,&#34;image&#34;:&#34;https://m.360buyimg.com/mobilecms/s720x720_jfs/t6934/364/1195375010/84676/e9f2c55f/597ece38N0ddcbc77.jpg!q70.jpg.webp&#34;,&#34;category&#34;:&#34;æ‹‰æ†ç®±&#34;,&#34;brand&#34;:&#34;RIMOWA&#34;,&#34;spec&#34;:&#34;&#34;,&#34;status&#34;:1,&#34;createTime&#34;:&#34;2019-04-30T16:00:00.000+00:00&#34;,&#34;updateTime&#34;:&#34;2019-04-30T16:00:00.000+00:00&#34;,&#34;stock&#34;:2999,&#34;sold&#34;:31290}&#39;</span>)
</span></span></code></pre></div><p>3ï¼‰é‡æ–°åŠ è½½å¹¶æµ‹è¯•</p>
<p>è¿è¡Œå‘½ä»¤ä»¥é‡æ–°åŠ è½½OpenRestyé…ç½®ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>nginx -s reload
</span></span></code></pre></div><p>åˆ·æ–°é¡µé¢å¯ä»¥çœ‹åˆ°ç»“æœä¸­å·²ç»å¸¦ä¸Šäº†IDï¼š</p>
<p><img loading="lazy" src="assets/image-20210821102235467.png" alt="image-20210821102235467"  />
</p>
<h2 id="44æŸ¥è¯¢tomcat">4.4.æŸ¥è¯¢Tomcat<a hidden class="anchor" aria-hidden="true" href="#44æŸ¥è¯¢tomcat">#</a></h2>
<p>æ‹¿åˆ°å•†å“IDåï¼Œæœ¬åº”å»ç¼“å­˜ä¸­æŸ¥è¯¢å•†å“ä¿¡æ¯ï¼Œä¸è¿‡ç›®å‰æˆ‘ä»¬è¿˜æœªå»ºç«‹nginxã€redisç¼“å­˜ã€‚å› æ­¤ï¼Œè¿™é‡Œæˆ‘ä»¬å…ˆæ ¹æ®å•†å“idå»tomcatæŸ¥è¯¢å•†å“ä¿¡æ¯ã€‚æˆ‘ä»¬å®ç°å¦‚å›¾éƒ¨åˆ†ï¼š</p>
<p><img loading="lazy" src="assets/image-20210821102610167.png" alt="image-20210821102610167"  />
</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬çš„OpenRestyæ˜¯åœ¨è™šæ‹Ÿæœºï¼ŒTomcatæ˜¯åœ¨Windowsç”µè„‘ä¸Šã€‚ä¸¤è€…IPä¸€å®šä¸è¦æé”™äº†ã€‚</p>
<p><img loading="lazy" src="assets/image-20210821102959829.png" alt="image-20210821102959829"  />
</p>
<h3 id="441å‘é€httpè¯·æ±‚çš„api">4.4.1.å‘é€httpè¯·æ±‚çš„API<a hidden class="anchor" aria-hidden="true" href="#441å‘é€httpè¯·æ±‚çš„api">#</a></h3>
<p>nginxæä¾›äº†å†…éƒ¨APIç”¨ä»¥å‘é€httpè¯·æ±‚ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#66d9ef">local</span> resp <span style="color:#f92672">=</span> ngx.location.capture(<span style="color:#e6db74">&#34;/path&#34;</span>,{
</span></span><span style="display:flex;"><span>    method <span style="color:#f92672">=</span> ngx.HTTP_GET,   <span style="color:#75715e">-- è¯·æ±‚æ–¹å¼</span>
</span></span><span style="display:flex;"><span>    args <span style="color:#f92672">=</span> {a<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,b<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>},  <span style="color:#75715e">-- getæ–¹å¼ä¼ å‚æ•°</span>
</span></span><span style="display:flex;"><span>})
</span></span></code></pre></div><p>è¿”å›çš„å“åº”å†…å®¹åŒ…æ‹¬ï¼š</p>
<ul>
<li>resp.statusï¼šå“åº”çŠ¶æ€ç </li>
<li>resp.headerï¼šå“åº”å¤´ï¼Œæ˜¯ä¸€ä¸ªtable</li>
<li>resp.bodyï¼šå“åº”ä½“ï¼Œå°±æ˜¯å“åº”æ•°æ®</li>
</ul>
<p>æ³¨æ„ï¼šè¿™é‡Œçš„pathæ˜¯è·¯å¾„ï¼Œå¹¶ä¸åŒ…å«IPå’Œç«¯å£ã€‚è¿™ä¸ªè¯·æ±‚ä¼šè¢«nginxå†…éƒ¨çš„serverç›‘å¬å¹¶å¤„ç†ã€‚</p>
<p>ä½†æ˜¯æˆ‘ä»¬å¸Œæœ›è¿™ä¸ªè¯·æ±‚å‘é€åˆ°TomcatæœåŠ¡å™¨ï¼Œæ‰€ä»¥è¿˜éœ€è¦ç¼–å†™ä¸€ä¸ªserveræ¥å¯¹è¿™ä¸ªè·¯å¾„åšåå‘ä»£ç†ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span> <span style="color:#66d9ef">location</span> <span style="color:#e6db74">/path</span> {
</span></span><span style="display:flex;"><span>     <span style="color:#75715e"># è¿™é‡Œæ˜¯windowsç”µè„‘çš„ipå’ŒJavaæœåŠ¡ç«¯å£ï¼Œéœ€è¦ç¡®ä¿windowsé˜²ç«å¢™å¤„äºå…³é—­çŠ¶æ€
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>     <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://192.168.150.1:8081</span>; 
</span></span><span style="display:flex;"><span> }
</span></span></code></pre></div><p>åŸç†å¦‚å›¾ï¼š</p>
<p><img loading="lazy" src="assets/image-20210821104149061.png" alt="image-20210821104149061"  />
</p>
<h3 id="442å°è£…httpå·¥å…·">4.4.2.å°è£…httpå·¥å…·<a hidden class="anchor" aria-hidden="true" href="#442å°è£…httpå·¥å…·">#</a></h3>
<p>ä¸‹é¢ï¼Œæˆ‘ä»¬å°è£…ä¸€ä¸ªå‘é€Httpè¯·æ±‚çš„å·¥å…·ï¼ŒåŸºäºngx.location.captureæ¥å®ç°æŸ¥è¯¢tomcatã€‚</p>
<p>1ï¼‰æ·»åŠ åå‘ä»£ç†ï¼Œåˆ°windowsçš„JavaæœåŠ¡</p>
<p>å› ä¸ºitem-serviceä¸­çš„æ¥å£éƒ½æ˜¯/itemå¼€å¤´ï¼Œæ‰€ä»¥æˆ‘ä»¬ç›‘å¬/itemè·¯å¾„ï¼Œä»£ç†åˆ°windowsä¸Šçš„tomcatæœåŠ¡ã€‚</p>
<p>ä¿®æ”¹ <code>/usr/local/openresty/nginx/conf/nginx.conf</code>æ–‡ä»¶ï¼Œæ·»åŠ ä¸€ä¸ªlocationï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">location</span> <span style="color:#e6db74">/item</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://192.168.150.1:8081</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>ä»¥åï¼Œåªè¦æˆ‘ä»¬è°ƒç”¨<code>ngx.location.capture(&quot;/item&quot;)</code>ï¼Œå°±ä¸€å®šèƒ½å‘é€è¯·æ±‚åˆ°windowsçš„tomcatæœåŠ¡ã€‚</p>
<p>2ï¼‰å°è£…å·¥å…·ç±»</p>
<p>ä¹‹å‰æˆ‘ä»¬è¯´è¿‡ï¼ŒOpenRestyå¯åŠ¨æ—¶ä¼šåŠ è½½ä»¥ä¸‹ä¸¤ä¸ªç›®å½•ä¸­çš„å·¥å…·æ–‡ä»¶ï¼š</p>
<p><img loading="lazy" src="assets/image-20210821104857413.png" alt="image-20210821104857413"  />
</p>
<p>æ‰€ä»¥ï¼Œè‡ªå®šä¹‰çš„httpå·¥å…·ä¹Ÿéœ€è¦æ”¾åˆ°è¿™ä¸ªç›®å½•ä¸‹ã€‚</p>
<p>åœ¨<code>/usr/local/openresty/lualib</code>ç›®å½•ä¸‹ï¼Œæ–°å»ºä¸€ä¸ªcommon.luaæ–‡ä»¶ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>vi /usr/local/openresty/lualib/common.lua
</span></span></code></pre></div><p>å†…å®¹å¦‚ä¸‹:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#75715e">-- å°è£…å‡½æ•°ï¼Œå‘é€httpè¯·æ±‚ï¼Œå¹¶è§£æå“åº”</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">local</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">read_http</span>(path, params)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">local</span> resp <span style="color:#f92672">=</span> ngx.location.capture(path,{
</span></span><span style="display:flex;"><span>        method <span style="color:#f92672">=</span> ngx.HTTP_GET,
</span></span><span style="display:flex;"><span>        args <span style="color:#f92672">=</span> params,
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> resp <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">-- è®°å½•é”™è¯¯ä¿¡æ¯ï¼Œè¿”å›404</span>
</span></span><span style="display:flex;"><span>        ngx.log(ngx.ERR, <span style="color:#e6db74">&#34;httpè¯·æ±‚æŸ¥è¯¢å¤±è´¥, path: &#34;</span>, path , <span style="color:#e6db74">&#34;, args: &#34;</span>, args)
</span></span><span style="display:flex;"><span>        ngx.exit(<span style="color:#ae81ff">404</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> resp.body
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- å°†æ–¹æ³•å¯¼å‡º</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">local</span> _M <span style="color:#f92672">=</span> {  
</span></span><span style="display:flex;"><span>    read_http <span style="color:#f92672">=</span> read_http
</span></span><span style="display:flex;"><span>}  
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span> _M
</span></span></code></pre></div><p>è¿™ä¸ªå·¥å…·å°†read_httpå‡½æ•°å°è£…åˆ°_Mè¿™ä¸ªtableç±»å‹çš„å˜é‡ä¸­ï¼Œå¹¶ä¸”è¿”å›ï¼Œè¿™ç±»ä¼¼äºå¯¼å‡ºã€‚</p>
<p>ä½¿ç”¨çš„æ—¶å€™ï¼Œå¯ä»¥åˆ©ç”¨<code>require('common')</code>æ¥å¯¼å…¥è¯¥å‡½æ•°åº“ï¼Œè¿™é‡Œçš„commonæ˜¯å‡½æ•°åº“çš„æ–‡ä»¶åã€‚</p>
<p>3ï¼‰å®ç°å•†å“æŸ¥è¯¢</p>
<p>æœ€åï¼Œæˆ‘ä»¬ä¿®æ”¹<code>/usr/local/openresty/lua/item.lua</code>æ–‡ä»¶ï¼Œåˆ©ç”¨åˆšåˆšå°è£…çš„å‡½æ•°åº“å®ç°å¯¹tomcatçš„æŸ¥è¯¢ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#75715e">-- å¼•å…¥è‡ªå®šä¹‰commonå·¥å…·æ¨¡å—ï¼Œè¿”å›å€¼æ˜¯commonä¸­è¿”å›çš„ _M</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">local</span> common <span style="color:#f92672">=</span> require(<span style="color:#e6db74">&#34;common&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- ä» commonä¸­è·å–read_httpè¿™ä¸ªå‡½æ•°</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">local</span> read_http <span style="color:#f92672">=</span> common.read_http
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- è·å–è·¯å¾„å‚æ•°</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">local</span> id <span style="color:#f92672">=</span> ngx.var[<span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- æ ¹æ®idæŸ¥è¯¢å•†å“</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">local</span> itemJSON <span style="color:#f92672">=</span> read_http(<span style="color:#e6db74">&#34;/item/&#34;</span><span style="color:#f92672">..</span> id, <span style="color:#66d9ef">nil</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- æ ¹æ®idæŸ¥è¯¢å•†å“åº“å­˜</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">local</span> itemStockJSON <span style="color:#f92672">=</span> read_http(<span style="color:#e6db74">&#34;/item/stock/&#34;</span><span style="color:#f92672">..</span> id, <span style="color:#66d9ef">nil</span>)
</span></span></code></pre></div><p>è¿™é‡ŒæŸ¥è¯¢åˆ°çš„ç»“æœæ˜¯jsonå­—ç¬¦ä¸²ï¼Œå¹¶ä¸”åŒ…å«å•†å“ã€åº“å­˜ä¸¤ä¸ªjsonå­—ç¬¦ä¸²ï¼Œé¡µé¢æœ€ç»ˆéœ€è¦çš„æ˜¯æŠŠä¸¤ä¸ªjsonæ‹¼æ¥ä¸ºä¸€ä¸ªjsonï¼š</p>
<p><img loading="lazy" src="assets/image-20210821110441222.png" alt="image-20210821110441222"  />
</p>
<p>è¿™å°±éœ€è¦æˆ‘ä»¬å…ˆæŠŠJSONå˜ä¸ºluaçš„tableï¼Œå®Œæˆæ•°æ®æ•´åˆåï¼Œå†è½¬ä¸ºJSONã€‚</p>
<h3 id="443cjsonå·¥å…·ç±»">4.4.3.CJSONå·¥å…·ç±»<a hidden class="anchor" aria-hidden="true" href="#443cjsonå·¥å…·ç±»">#</a></h3>
<p>OpenRestyæä¾›äº†ä¸€ä¸ªcjsonçš„æ¨¡å—ç”¨æ¥å¤„ç†JSONçš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚</p>
<p>å®˜æ–¹åœ°å€ï¼š <a href="https://github.com/openresty/lua-cjson/">https://github.com/openresty/lua-cjson/</a></p>
<p>1ï¼‰å¼•å…¥cjsonæ¨¡å—ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#66d9ef">local</span> cjson <span style="color:#f92672">=</span> require <span style="color:#e6db74">&#34;cjson&#34;</span>
</span></span></code></pre></div><p>2ï¼‰åºåˆ—åŒ–ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#66d9ef">local</span> obj <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;jack&#39;</span>,
</span></span><span style="display:flex;"><span>    age <span style="color:#f92672">=</span> <span style="color:#ae81ff">21</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- æŠŠ table åºåˆ—åŒ–ä¸º json</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">local</span> json <span style="color:#f92672">=</span> cjson.encode(obj)
</span></span></code></pre></div><p>3ï¼‰ååºåˆ—åŒ–ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#66d9ef">local</span> json <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;{&#34;name&#34;: &#34;jack&#34;, &#34;age&#34;: 21}&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- ååºåˆ—åŒ– jsonä¸º table</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">local</span> obj <span style="color:#f92672">=</span> cjson.decode(json);
</span></span><span style="display:flex;"><span>print(obj.name)
</span></span></code></pre></div><h3 id="444å®ç°tomcatæŸ¥è¯¢">4.4.4.å®ç°TomcatæŸ¥è¯¢<a hidden class="anchor" aria-hidden="true" href="#444å®ç°tomcatæŸ¥è¯¢">#</a></h3>
<p>ä¸‹é¢ï¼Œæˆ‘ä»¬ä¿®æ”¹ä¹‹å‰çš„item.luaä¸­çš„ä¸šåŠ¡ï¼Œæ·»åŠ jsonå¤„ç†åŠŸèƒ½ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#75715e">-- å¯¼å…¥commonå‡½æ•°åº“</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">local</span> common <span style="color:#f92672">=</span> require(<span style="color:#e6db74">&#39;common&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">local</span> read_http <span style="color:#f92672">=</span> common.read_http
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- å¯¼å…¥cjsonåº“</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">local</span> cjson <span style="color:#f92672">=</span> require(<span style="color:#e6db74">&#39;cjson&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- è·å–è·¯å¾„å‚æ•°</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">local</span> id <span style="color:#f92672">=</span> ngx.var[<span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- æ ¹æ®idæŸ¥è¯¢å•†å“</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">local</span> itemJSON <span style="color:#f92672">=</span> read_http(<span style="color:#e6db74">&#34;/item/&#34;</span><span style="color:#f92672">..</span> id, <span style="color:#66d9ef">nil</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- æ ¹æ®idæŸ¥è¯¢å•†å“åº“å­˜</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">local</span> itemStockJSON <span style="color:#f92672">=</span> read_http(<span style="color:#e6db74">&#34;/item/stock/&#34;</span><span style="color:#f92672">..</span> id, <span style="color:#66d9ef">nil</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- JSONè½¬åŒ–ä¸ºluaçš„table</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">local</span> item <span style="color:#f92672">=</span> cjson.decode(itemJSON)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">local</span> stock <span style="color:#f92672">=</span> cjson.decode(stockJSON)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- ç»„åˆæ•°æ®</span>
</span></span><span style="display:flex;"><span>item.stock <span style="color:#f92672">=</span> stock.stock
</span></span><span style="display:flex;"><span>item.sold <span style="color:#f92672">=</span> stock.sold
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- æŠŠitemåºåˆ—åŒ–ä¸ºjson è¿”å›ç»“æœ</span>
</span></span><span style="display:flex;"><span>ngx.say(cjson.encode(item))
</span></span></code></pre></div><h3 id="445åŸºäºidè´Ÿè½½å‡è¡¡">4.4.5.åŸºäºIDè´Ÿè½½å‡è¡¡<a hidden class="anchor" aria-hidden="true" href="#445åŸºäºidè´Ÿè½½å‡è¡¡">#</a></h3>
<p>åˆšæ‰çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬çš„tomcatæ˜¯å•æœºéƒ¨ç½²ã€‚è€Œå®é™…å¼€å‘ä¸­ï¼Œtomcatä¸€å®šæ˜¯é›†ç¾¤æ¨¡å¼ï¼š</p>
<p><img loading="lazy" src="assets/image-20210821111023255.png" alt="image-20210821111023255"  />
</p>
<p>å› æ­¤ï¼ŒOpenRestyéœ€è¦å¯¹tomcaté›†ç¾¤åšè´Ÿè½½å‡è¡¡ã€‚</p>
<p>è€Œé»˜è®¤çš„è´Ÿè½½å‡è¡¡è§„åˆ™æ˜¯è½®è¯¢æ¨¡å¼ï¼Œå½“æˆ‘ä»¬æŸ¥è¯¢/item/10001æ—¶ï¼š</p>
<ul>
<li>ç¬¬ä¸€æ¬¡ä¼šè®¿é—®8081ç«¯å£çš„tomcatæœåŠ¡ï¼Œåœ¨è¯¥æœåŠ¡å†…éƒ¨å°±å½¢æˆäº†JVMè¿›ç¨‹ç¼“å­˜</li>
<li>ç¬¬äºŒæ¬¡ä¼šè®¿é—®8082ç«¯å£çš„tomcatæœåŠ¡ï¼Œè¯¥æœåŠ¡å†…éƒ¨æ²¡æœ‰JVMç¼“å­˜ï¼ˆå› ä¸ºJVMç¼“å­˜æ— æ³•å…±äº«ï¼‰ï¼Œä¼šæŸ¥è¯¢æ•°æ®åº“</li>
<li>&hellip;</li>
</ul>
<p>ä½ çœ‹ï¼Œå› ä¸ºè½®è¯¢çš„åŸå› ï¼Œç¬¬ä¸€æ¬¡æŸ¥è¯¢8081å½¢æˆçš„JVMç¼“å­˜å¹¶æœªç”Ÿæ•ˆï¼Œç›´åˆ°ä¸‹ä¸€æ¬¡å†æ¬¡è®¿é—®åˆ°8081æ—¶æ‰å¯ä»¥ç”Ÿæ•ˆï¼Œç¼“å­˜å‘½ä¸­ç‡å¤ªä½äº†ã€‚</p>
<p>æ€ä¹ˆåŠï¼Ÿ</p>
<p>å¦‚æœèƒ½è®©åŒä¸€ä¸ªå•†å“ï¼Œæ¯æ¬¡æŸ¥è¯¢æ—¶éƒ½è®¿é—®åŒä¸€ä¸ªtomcatæœåŠ¡ï¼Œé‚£ä¹ˆJVMç¼“å­˜å°±ä¸€å®šèƒ½ç”Ÿæ•ˆäº†ã€‚</p>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬éœ€è¦æ ¹æ®å•†å“idåšè´Ÿè½½å‡è¡¡ï¼Œè€Œä¸æ˜¯è½®è¯¢ã€‚</p>
<h4 id="1åŸç†">1ï¼‰åŸç†<a hidden class="anchor" aria-hidden="true" href="#1åŸç†">#</a></h4>
<p>nginxæä¾›äº†åŸºäºè¯·æ±‚è·¯å¾„åšè´Ÿè½½å‡è¡¡çš„ç®—æ³•ï¼š</p>
<p>nginxæ ¹æ®è¯·æ±‚è·¯å¾„åšhashè¿ç®—ï¼ŒæŠŠå¾—åˆ°çš„æ•°å€¼å¯¹tomcatæœåŠ¡çš„æ•°é‡å–ä½™ï¼Œä½™æ•°æ˜¯å‡ ï¼Œå°±è®¿é—®ç¬¬å‡ ä¸ªæœåŠ¡ï¼Œå®ç°è´Ÿè½½å‡è¡¡ã€‚</p>
<p>ä¾‹å¦‚ï¼š</p>
<ul>
<li>æˆ‘ä»¬çš„è¯·æ±‚è·¯å¾„æ˜¯ /item/10001</li>
<li>tomcatæ€»æ•°ä¸º2å°ï¼ˆ8081ã€8082ï¼‰</li>
<li>å¯¹è¯·æ±‚è·¯å¾„/item/1001åšhashè¿ç®—æ±‚ä½™çš„ç»“æœä¸º1</li>
<li>åˆ™è®¿é—®ç¬¬ä¸€ä¸ªtomcatæœåŠ¡ï¼Œä¹Ÿå°±æ˜¯8081</li>
</ul>
<p>åªè¦idä¸å˜ï¼Œæ¯æ¬¡hashè¿ç®—ç»“æœä¹Ÿä¸ä¼šå˜ï¼Œé‚£å°±å¯ä»¥ä¿è¯åŒä¸€ä¸ªå•†å“ï¼Œä¸€ç›´è®¿é—®åŒä¸€ä¸ªtomcatæœåŠ¡ï¼Œç¡®ä¿JVMç¼“å­˜ç”Ÿæ•ˆã€‚</p>
<h4 id="2å®ç°">2ï¼‰å®ç°<a hidden class="anchor" aria-hidden="true" href="#2å®ç°">#</a></h4>
<p>ä¿®æ”¹<code>/usr/local/openresty/nginx/conf/nginx.conf</code>æ–‡ä»¶ï¼Œå®ç°åŸºäºIDåšè´Ÿè½½å‡è¡¡ã€‚</p>
<p>é¦–å…ˆï¼Œå®šä¹‰tomcaté›†ç¾¤ï¼Œå¹¶è®¾ç½®åŸºäºè·¯å¾„åšè´Ÿè½½å‡è¡¡ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">upstream</span> <span style="color:#e6db74">tomcat-cluster</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">hash</span> $request_uri;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">server</span> 192.168.150.1:<span style="color:#ae81ff">8081</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">server</span> 192.168.150.1:<span style="color:#ae81ff">8082</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>ç„¶åï¼Œä¿®æ”¹å¯¹tomcatæœåŠ¡çš„åå‘ä»£ç†ï¼Œç›®æ ‡æŒ‡å‘tomcaté›†ç¾¤ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">location</span> <span style="color:#e6db74">/item</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://tomcat-cluster</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>é‡æ–°åŠ è½½OpenResty</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>nginx -s reload
</span></span></code></pre></div><h4 id="3æµ‹è¯•">3ï¼‰æµ‹è¯•<a hidden class="anchor" aria-hidden="true" href="#3æµ‹è¯•">#</a></h4>
<p>å¯åŠ¨ä¸¤å°tomcatæœåŠ¡ï¼š</p>
<p><img loading="lazy" src="assets/image-20210821112420464.png" alt="image-20210821112420464"  />
</p>
<p>åŒæ—¶å¯åŠ¨ï¼š</p>
<p><img loading="lazy" src="assets/image-20210821112444482.png" alt="image-20210821112444482"  />
</p>
<p>æ¸…ç©ºæ—¥å¿—åï¼Œå†æ¬¡è®¿é—®é¡µé¢ï¼Œå¯ä»¥çœ‹åˆ°ä¸åŒidçš„å•†å“ï¼Œè®¿é—®åˆ°äº†ä¸åŒçš„tomcatæœåŠ¡ï¼š</p>
<p><img loading="lazy" src="assets/image-20210821112559965.png" alt="image-20210821112559965"  />
</p>
<p><img loading="lazy" src="assets/image-20210821112637430.png" alt="image-20210821112637430"  />
</p>
<h2 id="45redisç¼“å­˜é¢„çƒ­">4.5.Redisç¼“å­˜é¢„çƒ­<a hidden class="anchor" aria-hidden="true" href="#45redisç¼“å­˜é¢„çƒ­">#</a></h2>
<p>Redisç¼“å­˜ä¼šé¢ä¸´å†·å¯åŠ¨é—®é¢˜ï¼š</p>
<p><strong>å†·å¯åŠ¨</strong>ï¼šæœåŠ¡åˆšåˆšå¯åŠ¨æ—¶ï¼ŒRedisä¸­å¹¶æ²¡æœ‰ç¼“å­˜ï¼Œå¦‚æœæ‰€æœ‰å•†å“æ•°æ®éƒ½åœ¨ç¬¬ä¸€æ¬¡æŸ¥è¯¢æ—¶æ·»åŠ ç¼“å­˜ï¼Œå¯èƒ½ä¼šç»™æ•°æ®åº“å¸¦æ¥è¾ƒå¤§å‹åŠ›ã€‚</p>
<p><strong>ç¼“å­˜é¢„çƒ­</strong>ï¼šåœ¨å®é™…å¼€å‘ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨å¤§æ•°æ®ç»Ÿè®¡ç”¨æˆ·è®¿é—®çš„çƒ­ç‚¹æ•°æ®ï¼Œåœ¨é¡¹ç›®å¯åŠ¨æ—¶å°†è¿™äº›çƒ­ç‚¹æ•°æ®æå‰æŸ¥è¯¢å¹¶ä¿å­˜åˆ°Redisä¸­ã€‚</p>
<p>æˆ‘ä»¬æ•°æ®é‡è¾ƒå°‘ï¼Œå¹¶ä¸”æ²¡æœ‰æ•°æ®ç»Ÿè®¡ç›¸å…³åŠŸèƒ½ï¼Œç›®å‰å¯ä»¥åœ¨å¯åŠ¨æ—¶å°†æ‰€æœ‰æ•°æ®éƒ½æ”¾å…¥ç¼“å­˜ä¸­ã€‚</p>
<p>1ï¼‰åˆ©ç”¨Dockerå®‰è£…Redis</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>docker run --name redis -p 6379:6379 -d redis redis-server --appendonly yes
</span></span></code></pre></div><p>2ï¼‰åœ¨item-serviceæœåŠ¡ä¸­å¼•å…¥Redisä¾èµ–</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;artifactId&gt;</span>spring-boot-starter-data-redis<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>3ï¼‰é…ç½®Redisåœ°å€</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">spring</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">redis</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">host</span>: <span style="color:#ae81ff">192.168.150.101</span>
</span></span></code></pre></div><p>4ï¼‰ç¼–å†™åˆå§‹åŒ–ç±»</p>
<p>ç¼“å­˜é¢„çƒ­éœ€è¦åœ¨é¡¹ç›®å¯åŠ¨æ—¶å®Œæˆï¼Œå¹¶ä¸”å¿…é¡»æ˜¯æ‹¿åˆ°RedisTemplateä¹‹åã€‚</p>
<p>è¿™é‡Œæˆ‘ä»¬åˆ©ç”¨InitializingBeanæ¥å£æ¥å®ç°ï¼Œå› ä¸ºInitializingBeanå¯ä»¥åœ¨å¯¹è±¡è¢«Springåˆ›å»ºå¹¶ä¸”æˆå‘˜å˜é‡å…¨éƒ¨æ³¨å…¥åæ‰§è¡Œã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">package</span> com.heima.item.config;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> com.fasterxml.jackson.core.JsonProcessingException;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> com.fasterxml.jackson.databind.ObjectMapper;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> com.heima.item.pojo.Item;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> com.heima.item.pojo.ItemStock;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> com.heima.item.service.IItemService;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> com.heima.item.service.IItemStockService;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.beans.factory.InitializingBean;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.beans.factory.annotation.Autowired;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.data.redis.core.StringRedisTemplate;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.stereotype.Component;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.util.List;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Component</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">RedisHandler</span> <span style="color:#66d9ef">implements</span> InitializingBean {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> StringRedisTemplate redisTemplate;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> IItemService itemService;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> IItemStockService stockService;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> ObjectMapper MAPPER <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ObjectMapper();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">afterPropertiesSet</span>() <span style="color:#66d9ef">throws</span> Exception {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// åˆå§‹åŒ–ç¼“å­˜</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 1.æŸ¥è¯¢å•†å“ä¿¡æ¯</span>
</span></span><span style="display:flex;"><span>        List<span style="color:#f92672">&lt;</span>Item<span style="color:#f92672">&gt;</span> itemList <span style="color:#f92672">=</span> itemService.<span style="color:#a6e22e">list</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 2.æ”¾å…¥ç¼“å­˜</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> (Item item : itemList) {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 2.1.itemåºåˆ—åŒ–ä¸ºJSON</span>
</span></span><span style="display:flex;"><span>            String json <span style="color:#f92672">=</span> MAPPER.<span style="color:#a6e22e">writeValueAsString</span>(item);
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 2.2.å­˜å…¥redis</span>
</span></span><span style="display:flex;"><span>            redisTemplate.<span style="color:#a6e22e">opsForValue</span>().<span style="color:#a6e22e">set</span>(<span style="color:#e6db74">&#34;item:id:&#34;</span> <span style="color:#f92672">+</span> item.<span style="color:#a6e22e">getId</span>(), json);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 3.æŸ¥è¯¢å•†å“åº“å­˜ä¿¡æ¯</span>
</span></span><span style="display:flex;"><span>        List<span style="color:#f92672">&lt;</span>ItemStock<span style="color:#f92672">&gt;</span> stockList <span style="color:#f92672">=</span> stockService.<span style="color:#a6e22e">list</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 4.æ”¾å…¥ç¼“å­˜</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> (ItemStock stock : stockList) {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 2.1.itemåºåˆ—åŒ–ä¸ºJSON</span>
</span></span><span style="display:flex;"><span>            String json <span style="color:#f92672">=</span> MAPPER.<span style="color:#a6e22e">writeValueAsString</span>(stock);
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 2.2.å­˜å…¥redis</span>
</span></span><span style="display:flex;"><span>            redisTemplate.<span style="color:#a6e22e">opsForValue</span>().<span style="color:#a6e22e">set</span>(<span style="color:#e6db74">&#34;item:stock:id:&#34;</span> <span style="color:#f92672">+</span> stock.<span style="color:#a6e22e">getId</span>(), json);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="46æŸ¥è¯¢redisç¼“å­˜">4.6.æŸ¥è¯¢Redisç¼“å­˜<a hidden class="anchor" aria-hidden="true" href="#46æŸ¥è¯¢redisç¼“å­˜">#</a></h2>
<p>ç°åœ¨ï¼ŒRedisç¼“å­˜å·²ç»å‡†å¤‡å°±ç»ªï¼Œæˆ‘ä»¬å¯ä»¥å†OpenRestyä¸­å®ç°æŸ¥è¯¢Redisçš„é€»è¾‘äº†ã€‚å¦‚ä¸‹å›¾çº¢æ¡†æ‰€ç¤ºï¼š</p>
<p><img loading="lazy" src="assets/image-20210821113340111.png" alt="image-20210821113340111"  />
</p>
<p>å½“è¯·æ±‚è¿›å…¥OpenRestyä¹‹åï¼š</p>
<ul>
<li>ä¼˜å…ˆæŸ¥è¯¢Redisç¼“å­˜</li>
<li>å¦‚æœRedisç¼“å­˜æœªå‘½ä¸­ï¼Œå†æŸ¥è¯¢Tomcat</li>
</ul>
<h3 id="461å°è£…rediså·¥å…·">4.6.1.å°è£…Rediså·¥å…·<a hidden class="anchor" aria-hidden="true" href="#461å°è£…rediså·¥å…·">#</a></h3>
<p>OpenRestyæä¾›äº†æ“ä½œRedisçš„æ¨¡å—ï¼Œæˆ‘ä»¬åªè¦å¼•å…¥è¯¥æ¨¡å—å°±èƒ½ç›´æ¥ä½¿ç”¨ã€‚ä½†æ˜¯ä¸ºäº†æ–¹ä¾¿ï¼Œæˆ‘ä»¬å°†Redisæ“ä½œå°è£…åˆ°ä¹‹å‰çš„common.luaå·¥å…·åº“ä¸­ã€‚</p>
<p>ä¿®æ”¹<code>/usr/local/openresty/lualib/common.lua</code>æ–‡ä»¶ï¼š</p>
<p>1ï¼‰å¼•å…¥Redisæ¨¡å—ï¼Œå¹¶åˆå§‹åŒ–Rediså¯¹è±¡</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#75715e">-- å¯¼å…¥redis</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">local</span> redis <span style="color:#f92672">=</span> require(<span style="color:#e6db74">&#39;resty.redis&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- åˆå§‹åŒ–redis</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">local</span> red <span style="color:#f92672">=</span> redis:new()
</span></span><span style="display:flex;"><span>red:set_timeouts(<span style="color:#ae81ff">1000</span>, <span style="color:#ae81ff">1000</span>, <span style="color:#ae81ff">1000</span>)
</span></span></code></pre></div><p>2ï¼‰å°è£…å‡½æ•°ï¼Œç”¨æ¥é‡Šæ”¾Redisè¿æ¥ï¼Œå…¶å®æ˜¯æ”¾å…¥è¿æ¥æ± </p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">local</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">close_redis</span>(red)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">local</span> pool_max_idle_time <span style="color:#f92672">=</span> <span style="color:#ae81ff">10000</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">local</span> pool_size <span style="color:#f92672">=</span> <span style="color:#ae81ff">100</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">local</span> ok, err <span style="color:#f92672">=</span> red:set_keepalive(pool_max_idle_time, pool_size)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> ok <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>        ngx.log(ngx.ERR, <span style="color:#e6db74">&#34;æ”¾å…¥redisè¿æ¥æ± å¤±è´¥: &#34;</span>, err)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span></code></pre></div><p>3ï¼‰å°è£…å‡½æ•°ï¼Œæ ¹æ®keyæŸ¥è¯¢Redisæ•°æ®</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">local</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">read_redis</span>(ip, port, key)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">local</span> ok, err <span style="color:#f92672">=</span> red:connect(ip, port)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> ok <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>        ngx.log(ngx.ERR, <span style="color:#e6db74">&#34;è¿æ¥rediså¤±è´¥ : &#34;</span>, err)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">local</span> resp, err <span style="color:#f92672">=</span> red:get(key)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> resp <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>        ngx.log(ngx.ERR, <span style="color:#e6db74">&#34;æŸ¥è¯¢Rediså¤±è´¥: &#34;</span>, err, <span style="color:#e6db74">&#34;, key = &#34;</span> , key)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> resp <span style="color:#f92672">==</span> ngx.null <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>        resp <span style="color:#f92672">=</span> <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>        ngx.log(ngx.ERR, <span style="color:#e6db74">&#34;æŸ¥è¯¢Redisæ•°æ®ä¸ºç©º, key = &#34;</span>, key)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>    close_redis(red)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> resp
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span></code></pre></div><p>4ï¼‰å¯¼å‡º</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#75715e">-- å°†æ–¹æ³•å¯¼å‡º</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">local</span> _M <span style="color:#f92672">=</span> {  
</span></span><span style="display:flex;"><span>    read_http <span style="color:#f92672">=</span> read_http,
</span></span><span style="display:flex;"><span>    read_redis <span style="color:#f92672">=</span> read_redis
</span></span><span style="display:flex;"><span>}  
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span> _M
</span></span></code></pre></div><p>å®Œæ•´çš„common.luaï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#75715e">-- å¯¼å…¥redis</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">local</span> redis <span style="color:#f92672">=</span> require(<span style="color:#e6db74">&#39;resty.redis&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- åˆå§‹åŒ–redis</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">local</span> red <span style="color:#f92672">=</span> redis:new()
</span></span><span style="display:flex;"><span>red:set_timeouts(<span style="color:#ae81ff">1000</span>, <span style="color:#ae81ff">1000</span>, <span style="color:#ae81ff">1000</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- å…³é—­redisè¿æ¥çš„å·¥å…·æ–¹æ³•ï¼Œå…¶å®æ˜¯æ”¾å…¥è¿æ¥æ± </span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">local</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">close_redis</span>(red)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">local</span> pool_max_idle_time <span style="color:#f92672">=</span> <span style="color:#ae81ff">10000</span> <span style="color:#75715e">-- è¿æ¥çš„ç©ºé—²æ—¶é—´ï¼Œå•ä½æ˜¯æ¯«ç§’</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">local</span> pool_size <span style="color:#f92672">=</span> <span style="color:#ae81ff">100</span> <span style="color:#75715e">--è¿æ¥æ± å¤§å°</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">local</span> ok, err <span style="color:#f92672">=</span> red:set_keepalive(pool_max_idle_time, pool_size)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> ok <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>        ngx.log(ngx.ERR, <span style="color:#e6db74">&#34;æ”¾å…¥redisè¿æ¥æ± å¤±è´¥: &#34;</span>, err)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- æŸ¥è¯¢redisçš„æ–¹æ³• ipå’Œportæ˜¯redisåœ°å€ï¼Œkeyæ˜¯æŸ¥è¯¢çš„key</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">local</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">read_redis</span>(ip, port, key)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">-- è·å–ä¸€ä¸ªè¿æ¥</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">local</span> ok, err <span style="color:#f92672">=</span> red:connect(ip, port)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> ok <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>        ngx.log(ngx.ERR, <span style="color:#e6db74">&#34;è¿æ¥rediså¤±è´¥ : &#34;</span>, err)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">-- æŸ¥è¯¢redis</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">local</span> resp, err <span style="color:#f92672">=</span> red:get(key)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">-- æŸ¥è¯¢å¤±è´¥å¤„ç†</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> resp <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>        ngx.log(ngx.ERR, <span style="color:#e6db74">&#34;æŸ¥è¯¢Rediså¤±è´¥: &#34;</span>, err, <span style="color:#e6db74">&#34;, key = &#34;</span> , key)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">--å¾—åˆ°çš„æ•°æ®ä¸ºç©ºå¤„ç†</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> resp <span style="color:#f92672">==</span> ngx.null <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>        resp <span style="color:#f92672">=</span> <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>        ngx.log(ngx.ERR, <span style="color:#e6db74">&#34;æŸ¥è¯¢Redisæ•°æ®ä¸ºç©º, key = &#34;</span>, key)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>    close_redis(red)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> resp
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- å°è£…å‡½æ•°ï¼Œå‘é€httpè¯·æ±‚ï¼Œå¹¶è§£æå“åº”</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">local</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">read_http</span>(path, params)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">local</span> resp <span style="color:#f92672">=</span> ngx.location.capture(path,{
</span></span><span style="display:flex;"><span>        method <span style="color:#f92672">=</span> ngx.HTTP_GET,
</span></span><span style="display:flex;"><span>        args <span style="color:#f92672">=</span> params,
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> resp <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">-- è®°å½•é”™è¯¯ä¿¡æ¯ï¼Œè¿”å›404</span>
</span></span><span style="display:flex;"><span>        ngx.log(ngx.ERR, <span style="color:#e6db74">&#34;httpæŸ¥è¯¢å¤±è´¥, path: &#34;</span>, path , <span style="color:#e6db74">&#34;, args: &#34;</span>, args)
</span></span><span style="display:flex;"><span>        ngx.exit(<span style="color:#ae81ff">404</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> resp.body
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- å°†æ–¹æ³•å¯¼å‡º</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">local</span> _M <span style="color:#f92672">=</span> {  
</span></span><span style="display:flex;"><span>    read_http <span style="color:#f92672">=</span> read_http,
</span></span><span style="display:flex;"><span>    read_redis <span style="color:#f92672">=</span> read_redis
</span></span><span style="display:flex;"><span>}  
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span> _M
</span></span></code></pre></div><h3 id="462å®ç°redisæŸ¥è¯¢">4.6.2.å®ç°RedisæŸ¥è¯¢<a hidden class="anchor" aria-hidden="true" href="#462å®ç°redisæŸ¥è¯¢">#</a></h3>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥å»ä¿®æ”¹item.luaæ–‡ä»¶ï¼Œå®ç°å¯¹Redisçš„æŸ¥è¯¢äº†ã€‚</p>
<p>æŸ¥è¯¢é€»è¾‘æ˜¯ï¼š</p>
<ul>
<li>æ ¹æ®idæŸ¥è¯¢Redis</li>
<li>å¦‚æœæŸ¥è¯¢å¤±è´¥åˆ™ç»§ç»­æŸ¥è¯¢Tomcat</li>
<li>å°†æŸ¥è¯¢ç»“æœè¿”å›</li>
</ul>
<p>1ï¼‰ä¿®æ”¹<code>/usr/local/openresty/lua/item.lua</code>æ–‡ä»¶ï¼Œæ·»åŠ ä¸€ä¸ªæŸ¥è¯¢å‡½æ•°ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#75715e">-- å¯¼å…¥commonå‡½æ•°åº“</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">local</span> common <span style="color:#f92672">=</span> require(<span style="color:#e6db74">&#39;common&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">local</span> read_http <span style="color:#f92672">=</span> common.read_http
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">local</span> read_redis <span style="color:#f92672">=</span> common.read_redis
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- å°è£…æŸ¥è¯¢å‡½æ•°</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">read_data</span>(key, path, params)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">local</span> val <span style="color:#f92672">=</span> read_redis(<span style="color:#e6db74">&#34;127.0.0.1&#34;</span>, <span style="color:#ae81ff">6379</span>, key)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> val <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>        ngx.log(ngx.ERR, <span style="color:#e6db74">&#34;redisæŸ¥è¯¢å¤±è´¥ï¼Œå°è¯•æŸ¥è¯¢httpï¼Œ key: &#34;</span>, key)
</span></span><span style="display:flex;"><span>        val <span style="color:#f92672">=</span> read_http(path, params)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> val
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span></code></pre></div><p>2ï¼‰è€Œåä¿®æ”¹å•†å“æŸ¥è¯¢ã€åº“å­˜æŸ¥è¯¢çš„ä¸šåŠ¡ï¼š</p>
<p><img loading="lazy" src="assets/image-20210821114528954.png" alt="image-20210821114528954"  />
</p>
<p>3ï¼‰å®Œæ•´çš„item.luaä»£ç ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#75715e">-- å¯¼å…¥commonå‡½æ•°åº“</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">local</span> common <span style="color:#f92672">=</span> require(<span style="color:#e6db74">&#39;common&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">local</span> read_http <span style="color:#f92672">=</span> common.read_http
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">local</span> read_redis <span style="color:#f92672">=</span> common.read_redis
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- å¯¼å…¥cjsonåº“</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">local</span> cjson <span style="color:#f92672">=</span> require(<span style="color:#e6db74">&#39;cjson&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- å°è£…æŸ¥è¯¢å‡½æ•°</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">read_data</span>(key, path, params)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">-- æŸ¥è¯¢æœ¬åœ°ç¼“å­˜</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">local</span> val <span style="color:#f92672">=</span> read_redis(<span style="color:#e6db74">&#34;127.0.0.1&#34;</span>, <span style="color:#ae81ff">6379</span>, key)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">-- åˆ¤æ–­æŸ¥è¯¢ç»“æœ</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> val <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>        ngx.log(ngx.ERR, <span style="color:#e6db74">&#34;redisæŸ¥è¯¢å¤±è´¥ï¼Œå°è¯•æŸ¥è¯¢httpï¼Œ key: &#34;</span>, key)
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">-- redisæŸ¥è¯¢å¤±è´¥ï¼Œå»æŸ¥è¯¢http</span>
</span></span><span style="display:flex;"><span>        val <span style="color:#f92672">=</span> read_http(path, params)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">-- è¿”å›æ•°æ®</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> val
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- è·å–è·¯å¾„å‚æ•°</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">local</span> id <span style="color:#f92672">=</span> ngx.var[<span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">local</span> itemJSON <span style="color:#f92672">=</span> read_data(<span style="color:#e6db74">&#34;item:id:&#34;</span> <span style="color:#f92672">..</span> id,  <span style="color:#e6db74">&#34;/item/&#34;</span> <span style="color:#f92672">..</span> id, <span style="color:#66d9ef">nil</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">local</span> stockJSON <span style="color:#f92672">=</span> read_data(<span style="color:#e6db74">&#34;item:stock:id:&#34;</span> <span style="color:#f92672">..</span> id, <span style="color:#e6db74">&#34;/item/stock/&#34;</span> <span style="color:#f92672">..</span> id, <span style="color:#66d9ef">nil</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- JSONè½¬åŒ–ä¸ºluaçš„table</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">local</span> item <span style="color:#f92672">=</span> cjson.decode(itemJSON)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">local</span> stock <span style="color:#f92672">=</span> cjson.decode(stockJSON)
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- ç»„åˆæ•°æ®</span>
</span></span><span style="display:flex;"><span>item.stock <span style="color:#f92672">=</span> stock.stock
</span></span><span style="display:flex;"><span>item.sold <span style="color:#f92672">=</span> stock.sold
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- æŠŠitemåºåˆ—åŒ–ä¸ºjson è¿”å›ç»“æœ</span>
</span></span><span style="display:flex;"><span>ngx.say(cjson.encode(item))
</span></span></code></pre></div><h2 id="47nginxæœ¬åœ°ç¼“å­˜">4.7.Nginxæœ¬åœ°ç¼“å­˜<a hidden class="anchor" aria-hidden="true" href="#47nginxæœ¬åœ°ç¼“å­˜">#</a></h2>
<p>ç°åœ¨ï¼Œæ•´ä¸ªå¤šçº§ç¼“å­˜ä¸­åªå·®æœ€åä¸€ç¯ï¼Œä¹Ÿå°±æ˜¯nginxçš„æœ¬åœ°ç¼“å­˜äº†ã€‚å¦‚å›¾ï¼š</p>
<p><img loading="lazy" src="assets/image-20210821114742950.png" alt="image-20210821114742950"  />
</p>
<h3 id="471æœ¬åœ°ç¼“å­˜api">4.7.1.æœ¬åœ°ç¼“å­˜API<a hidden class="anchor" aria-hidden="true" href="#471æœ¬åœ°ç¼“å­˜api">#</a></h3>
<p>OpenRestyä¸ºNginxæä¾›äº†<strong>shard dict</strong>çš„åŠŸèƒ½ï¼Œå¯ä»¥åœ¨nginxçš„å¤šä¸ªworkerä¹‹é—´å…±äº«æ•°æ®ï¼Œå®ç°ç¼“å­˜åŠŸèƒ½ã€‚</p>
<p>1ï¼‰å¼€å¯å…±äº«å­—å…¸ï¼Œåœ¨nginx.confçš„httpä¸‹æ·»åŠ é…ç½®ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span> <span style="color:#75715e"># å…±äº«å­—å…¸ï¼Œä¹Ÿå°±æ˜¯æœ¬åœ°ç¼“å­˜ï¼Œåç§°å«åšï¼šitem_cacheï¼Œå¤§å°150m
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span> <span style="color:#66d9ef">lua_shared_dict</span> <span style="color:#e6db74">item_cache</span> <span style="color:#ae81ff">150m</span>; 
</span></span></code></pre></div><p>2ï¼‰æ“ä½œå…±äº«å­—å…¸ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#75715e">-- è·å–æœ¬åœ°ç¼“å­˜å¯¹è±¡</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">local</span> item_cache <span style="color:#f92672">=</span> ngx.shared.item_cache
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- å­˜å‚¨, æŒ‡å®škeyã€valueã€è¿‡æœŸæ—¶é—´ï¼Œå•ä½sï¼Œé»˜è®¤ä¸º0ä»£è¡¨æ°¸ä¸è¿‡æœŸ</span>
</span></span><span style="display:flex;"><span>item_cache:set(<span style="color:#e6db74">&#39;key&#39;</span>, <span style="color:#e6db74">&#39;value&#39;</span>, <span style="color:#ae81ff">1000</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- è¯»å–</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">local</span> val <span style="color:#f92672">=</span> item_cache:get(<span style="color:#e6db74">&#39;key&#39;</span>)
</span></span></code></pre></div><h3 id="472å®ç°æœ¬åœ°ç¼“å­˜æŸ¥è¯¢">4.7.2.å®ç°æœ¬åœ°ç¼“å­˜æŸ¥è¯¢<a hidden class="anchor" aria-hidden="true" href="#472å®ç°æœ¬åœ°ç¼“å­˜æŸ¥è¯¢">#</a></h3>
<p>1ï¼‰ä¿®æ”¹<code>/usr/local/openresty/lua/item.lua</code>æ–‡ä»¶ï¼Œä¿®æ”¹read_dataæŸ¥è¯¢å‡½æ•°ï¼Œæ·»åŠ æœ¬åœ°ç¼“å­˜é€»è¾‘ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#75715e">-- å¯¼å…¥å…±äº«è¯å…¸ï¼Œæœ¬åœ°ç¼“å­˜</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">local</span> item_cache <span style="color:#f92672">=</span> ngx.shared.item_cache
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- å°è£…æŸ¥è¯¢å‡½æ•°</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">read_data</span>(key, expire, path, params)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">-- æŸ¥è¯¢æœ¬åœ°ç¼“å­˜</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">local</span> val <span style="color:#f92672">=</span> item_cache:get(key)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> val <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>        ngx.log(ngx.ERR, <span style="color:#e6db74">&#34;æœ¬åœ°ç¼“å­˜æŸ¥è¯¢å¤±è´¥ï¼Œå°è¯•æŸ¥è¯¢Redisï¼Œ key: &#34;</span>, key)
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">-- æŸ¥è¯¢redis</span>
</span></span><span style="display:flex;"><span>        val <span style="color:#f92672">=</span> read_redis(<span style="color:#e6db74">&#34;127.0.0.1&#34;</span>, <span style="color:#ae81ff">6379</span>, key)
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">-- åˆ¤æ–­æŸ¥è¯¢ç»“æœ</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> val <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>            ngx.log(ngx.ERR, <span style="color:#e6db74">&#34;redisæŸ¥è¯¢å¤±è´¥ï¼Œå°è¯•æŸ¥è¯¢httpï¼Œ key: &#34;</span>, key)
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">-- redisæŸ¥è¯¢å¤±è´¥ï¼Œå»æŸ¥è¯¢http</span>
</span></span><span style="display:flex;"><span>            val <span style="color:#f92672">=</span> read_http(path, params)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">-- æŸ¥è¯¢æˆåŠŸï¼ŒæŠŠæ•°æ®å†™å…¥æœ¬åœ°ç¼“å­˜</span>
</span></span><span style="display:flex;"><span>    item_cache:set(key, val, expire)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">-- è¿”å›æ•°æ®</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> val
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span></code></pre></div><p>2ï¼‰ä¿®æ”¹item.luaä¸­æŸ¥è¯¢å•†å“å’Œåº“å­˜çš„ä¸šåŠ¡ï¼Œå®ç°æœ€æ–°çš„read_dataå‡½æ•°ï¼š</p>
<p><img loading="lazy" src="assets/image-20210821115108528.png" alt="image-20210821115108528"  />
</p>
<p>å…¶å®å°±æ˜¯å¤šäº†ç¼“å­˜æ—¶é—´å‚æ•°ï¼Œè¿‡æœŸånginxç¼“å­˜ä¼šè‡ªåŠ¨åˆ é™¤ï¼Œä¸‹æ¬¡è®¿é—®å³å¯æ›´æ–°ç¼“å­˜ã€‚</p>
<p>è¿™é‡Œç»™å•†å“åŸºæœ¬ä¿¡æ¯è®¾ç½®è¶…æ—¶æ—¶é—´ä¸º30åˆ†é’Ÿï¼Œåº“å­˜ä¸º1åˆ†é’Ÿã€‚</p>
<p>å› ä¸ºåº“å­˜æ›´æ–°é¢‘ç‡è¾ƒé«˜ï¼Œå¦‚æœç¼“å­˜æ—¶é—´è¿‡é•¿ï¼Œå¯èƒ½ä¸æ•°æ®åº“å·®å¼‚è¾ƒå¤§ã€‚</p>
<p>3ï¼‰å®Œæ•´çš„item.luaæ–‡ä»¶ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#75715e">-- å¯¼å…¥commonå‡½æ•°åº“</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">local</span> common <span style="color:#f92672">=</span> require(<span style="color:#e6db74">&#39;common&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">local</span> read_http <span style="color:#f92672">=</span> common.read_http
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">local</span> read_redis <span style="color:#f92672">=</span> common.read_redis
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- å¯¼å…¥cjsonåº“</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">local</span> cjson <span style="color:#f92672">=</span> require(<span style="color:#e6db74">&#39;cjson&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- å¯¼å…¥å…±äº«è¯å…¸ï¼Œæœ¬åœ°ç¼“å­˜</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">local</span> item_cache <span style="color:#f92672">=</span> ngx.shared.item_cache
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- å°è£…æŸ¥è¯¢å‡½æ•°</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">read_data</span>(key, expire, path, params)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">-- æŸ¥è¯¢æœ¬åœ°ç¼“å­˜</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">local</span> val <span style="color:#f92672">=</span> item_cache:get(key)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> val <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>        ngx.log(ngx.ERR, <span style="color:#e6db74">&#34;æœ¬åœ°ç¼“å­˜æŸ¥è¯¢å¤±è´¥ï¼Œå°è¯•æŸ¥è¯¢Redisï¼Œ key: &#34;</span>, key)
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">-- æŸ¥è¯¢redis</span>
</span></span><span style="display:flex;"><span>        val <span style="color:#f92672">=</span> read_redis(<span style="color:#e6db74">&#34;127.0.0.1&#34;</span>, <span style="color:#ae81ff">6379</span>, key)
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">-- åˆ¤æ–­æŸ¥è¯¢ç»“æœ</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> val <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>            ngx.log(ngx.ERR, <span style="color:#e6db74">&#34;redisæŸ¥è¯¢å¤±è´¥ï¼Œå°è¯•æŸ¥è¯¢httpï¼Œ key: &#34;</span>, key)
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">-- redisæŸ¥è¯¢å¤±è´¥ï¼Œå»æŸ¥è¯¢http</span>
</span></span><span style="display:flex;"><span>            val <span style="color:#f92672">=</span> read_http(path, params)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">-- æŸ¥è¯¢æˆåŠŸï¼ŒæŠŠæ•°æ®å†™å…¥æœ¬åœ°ç¼“å­˜</span>
</span></span><span style="display:flex;"><span>    item_cache:set(key, val, expire)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">-- è¿”å›æ•°æ®</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> val
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- è·å–è·¯å¾„å‚æ•°</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">local</span> id <span style="color:#f92672">=</span> ngx.var[<span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- æŸ¥è¯¢å•†å“ä¿¡æ¯</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">local</span> itemJSON <span style="color:#f92672">=</span> read_data(<span style="color:#e6db74">&#34;item:id:&#34;</span> <span style="color:#f92672">..</span> id, <span style="color:#ae81ff">1800</span>,  <span style="color:#e6db74">&#34;/item/&#34;</span> <span style="color:#f92672">..</span> id, <span style="color:#66d9ef">nil</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- æŸ¥è¯¢åº“å­˜ä¿¡æ¯</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">local</span> stockJSON <span style="color:#f92672">=</span> read_data(<span style="color:#e6db74">&#34;item:stock:id:&#34;</span> <span style="color:#f92672">..</span> id, <span style="color:#ae81ff">60</span>, <span style="color:#e6db74">&#34;/item/stock/&#34;</span> <span style="color:#f92672">..</span> id, <span style="color:#66d9ef">nil</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- JSONè½¬åŒ–ä¸ºluaçš„table</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">local</span> item <span style="color:#f92672">=</span> cjson.decode(itemJSON)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">local</span> stock <span style="color:#f92672">=</span> cjson.decode(stockJSON)
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- ç»„åˆæ•°æ®</span>
</span></span><span style="display:flex;"><span>item.stock <span style="color:#f92672">=</span> stock.stock
</span></span><span style="display:flex;"><span>item.sold <span style="color:#f92672">=</span> stock.sold
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- æŠŠitemåºåˆ—åŒ–ä¸ºjson è¿”å›ç»“æœ</span>
</span></span><span style="display:flex;"><span>ngx.say(cjson.encode(item))
</span></span></code></pre></div><h1 id="5ç¼“å­˜åŒæ­¥">5.ç¼“å­˜åŒæ­¥<a hidden class="anchor" aria-hidden="true" href="#5ç¼“å­˜åŒæ­¥">#</a></h1>
<p>å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæµè§ˆå™¨æŸ¥è¯¢åˆ°çš„éƒ½æ˜¯ç¼“å­˜æ•°æ®ï¼Œå¦‚æœç¼“å­˜æ•°æ®ä¸æ•°æ®åº“æ•°æ®å­˜åœ¨è¾ƒå¤§å·®å¼‚ï¼Œå¯èƒ½ä¼šäº§ç”Ÿæ¯”è¾ƒä¸¥é‡çš„åæœã€‚</p>
<p>æ‰€ä»¥æˆ‘ä»¬å¿…é¡»ä¿è¯æ•°æ®åº“æ•°æ®ã€ç¼“å­˜æ•°æ®çš„ä¸€è‡´æ€§ï¼Œè¿™å°±æ˜¯ç¼“å­˜ä¸æ•°æ®åº“çš„åŒæ­¥ã€‚</p>
<h2 id="51æ•°æ®åŒæ­¥ç­–ç•¥">5.1.æ•°æ®åŒæ­¥ç­–ç•¥<a hidden class="anchor" aria-hidden="true" href="#51æ•°æ®åŒæ­¥ç­–ç•¥">#</a></h2>
<p>ç¼“å­˜æ•°æ®åŒæ­¥çš„å¸¸è§æ–¹å¼æœ‰ä¸‰ç§ï¼š</p>
<p><strong>è®¾ç½®æœ‰æ•ˆæœŸ</strong>ï¼šç»™ç¼“å­˜è®¾ç½®æœ‰æ•ˆæœŸï¼Œåˆ°æœŸåè‡ªåŠ¨åˆ é™¤ã€‚å†æ¬¡æŸ¥è¯¢æ—¶æ›´æ–°</p>
<ul>
<li>ä¼˜åŠ¿ï¼šç®€å•ã€æ–¹ä¾¿</li>
<li>ç¼ºç‚¹ï¼šæ—¶æ•ˆæ€§å·®ï¼Œç¼“å­˜è¿‡æœŸä¹‹å‰å¯èƒ½ä¸ä¸€è‡´</li>
<li>åœºæ™¯ï¼šæ›´æ–°é¢‘ç‡è¾ƒä½ï¼Œæ—¶æ•ˆæ€§è¦æ±‚ä½çš„ä¸šåŠ¡</li>
</ul>
<p><strong>åŒæ­¥åŒå†™</strong>ï¼šåœ¨ä¿®æ”¹æ•°æ®åº“çš„åŒæ—¶ï¼Œç›´æ¥ä¿®æ”¹ç¼“å­˜</p>
<ul>
<li>ä¼˜åŠ¿ï¼šæ—¶æ•ˆæ€§å¼ºï¼Œç¼“å­˜ä¸æ•°æ®åº“å¼ºä¸€è‡´</li>
<li>ç¼ºç‚¹ï¼šæœ‰ä»£ç ä¾µå…¥ï¼Œè€¦åˆåº¦é«˜ï¼›</li>
<li>åœºæ™¯ï¼šå¯¹ä¸€è‡´æ€§ã€æ—¶æ•ˆæ€§è¦æ±‚è¾ƒé«˜çš„ç¼“å­˜æ•°æ®</li>
</ul>
<p>**å¼‚æ­¥é€šçŸ¥ï¼š**ä¿®æ”¹æ•°æ®åº“æ—¶å‘é€äº‹ä»¶é€šçŸ¥ï¼Œç›¸å…³æœåŠ¡ç›‘å¬åˆ°é€šçŸ¥åä¿®æ”¹ç¼“å­˜æ•°æ®</p>
<ul>
<li>ä¼˜åŠ¿ï¼šä½è€¦åˆï¼Œå¯ä»¥åŒæ—¶é€šçŸ¥å¤šä¸ªç¼“å­˜æœåŠ¡</li>
<li>ç¼ºç‚¹ï¼šæ—¶æ•ˆæ€§ä¸€èˆ¬ï¼Œå¯èƒ½å­˜åœ¨ä¸­é—´ä¸ä¸€è‡´çŠ¶æ€</li>
<li>åœºæ™¯ï¼šæ—¶æ•ˆæ€§è¦æ±‚ä¸€èˆ¬ï¼Œæœ‰å¤šä¸ªæœåŠ¡éœ€è¦åŒæ­¥</li>
</ul>
<p>è€Œå¼‚æ­¥å®ç°åˆå¯ä»¥åŸºäºMQæˆ–è€…Canalæ¥å®ç°ï¼š</p>
<p>1ï¼‰åŸºäºMQçš„å¼‚æ­¥é€šçŸ¥ï¼š</p>
<p><img loading="lazy" src="assets/image-20210821115552327.png" alt="image-20210821115552327"  />
</p>
<p>è§£è¯»ï¼š</p>
<ul>
<li>å•†å“æœåŠ¡å®Œæˆå¯¹æ•°æ®çš„ä¿®æ”¹åï¼Œåªéœ€è¦å‘é€ä¸€æ¡æ¶ˆæ¯åˆ°MQä¸­ã€‚</li>
<li>ç¼“å­˜æœåŠ¡ç›‘å¬MQæ¶ˆæ¯ï¼Œç„¶åå®Œæˆå¯¹ç¼“å­˜çš„æ›´æ–°</li>
</ul>
<p>ä¾ç„¶æœ‰å°‘é‡çš„ä»£ç ä¾µå…¥ã€‚</p>
<p>2ï¼‰åŸºäºCanalçš„é€šçŸ¥</p>
<p><img loading="lazy" src="assets/image-20210821115719363.png" alt="image-20210821115719363"  />
</p>
<p>è§£è¯»ï¼š</p>
<ul>
<li>å•†å“æœåŠ¡å®Œæˆå•†å“ä¿®æ”¹åï¼Œä¸šåŠ¡ç›´æ¥ç»“æŸï¼Œæ²¡æœ‰ä»»ä½•ä»£ç ä¾µå…¥</li>
<li>Canalç›‘å¬MySQLå˜åŒ–ï¼Œå½“å‘ç°å˜åŒ–åï¼Œç«‹å³é€šçŸ¥ç¼“å­˜æœåŠ¡</li>
<li>ç¼“å­˜æœåŠ¡æ¥æ”¶åˆ°canalé€šçŸ¥ï¼Œæ›´æ–°ç¼“å­˜</li>
</ul>
<p>ä»£ç é›¶ä¾µå…¥</p>
<h2 id="52å®‰è£…canal">5.2.å®‰è£…Canal<a hidden class="anchor" aria-hidden="true" href="#52å®‰è£…canal">#</a></h2>
<h3 id="521è®¤è¯†canal">5.2.1.è®¤è¯†Canal<a hidden class="anchor" aria-hidden="true" href="#521è®¤è¯†canal">#</a></h3>
<p><strong>Canal [kÉ™&rsquo;nÃ¦l]</strong>ï¼Œè¯‘æ„ä¸ºæ°´é“/ç®¡é“/æ²Ÿæ¸ ï¼Œcanalæ˜¯é˜¿é‡Œå·´å·´æ——ä¸‹çš„ä¸€æ¬¾å¼€æºé¡¹ç›®ï¼ŒåŸºäºJavaå¼€å‘ã€‚åŸºäºæ•°æ®åº“å¢é‡æ—¥å¿—è§£æï¼Œæä¾›å¢é‡æ•°æ®è®¢é˜…&amp;æ¶ˆè´¹ã€‚GitHubçš„åœ°å€ï¼šhttps://github.com/alibaba/canal</p>
<p>Canalæ˜¯åŸºäºmysqlçš„ä¸»ä»åŒæ­¥æ¥å®ç°çš„ï¼ŒMySQLä¸»ä»åŒæ­¥çš„åŸç†å¦‚ä¸‹ï¼š</p>
<p><img loading="lazy" src="assets/image-20210821115914748.png" alt="image-20210821115914748"  />
</p>
<ul>
<li>1ï¼‰MySQL master å°†æ•°æ®å˜æ›´å†™å…¥äºŒè¿›åˆ¶æ—¥å¿—( binary logï¼‰ï¼Œå…¶ä¸­è®°å½•çš„æ•°æ®å«åšbinary log events</li>
<li>2ï¼‰MySQL slave å°† master çš„ binary log eventsæ‹·è´åˆ°å®ƒçš„ä¸­ç»§æ—¥å¿—(relay log)</li>
<li>3ï¼‰MySQL slave é‡æ”¾ relay log ä¸­äº‹ä»¶ï¼Œå°†æ•°æ®å˜æ›´åæ˜ å®ƒè‡ªå·±çš„æ•°æ®</li>
</ul>
<p>è€ŒCanalå°±æ˜¯æŠŠè‡ªå·±ä¼ªè£…æˆMySQLçš„ä¸€ä¸ªslaveèŠ‚ç‚¹ï¼Œä»è€Œç›‘å¬masterçš„binary logå˜åŒ–ã€‚å†æŠŠå¾—åˆ°çš„å˜åŒ–ä¿¡æ¯é€šçŸ¥ç»™Canalçš„å®¢æˆ·ç«¯ï¼Œè¿›è€Œå®Œæˆå¯¹å…¶å®ƒæ•°æ®åº“çš„åŒæ­¥ã€‚</p>
<p><img loading="lazy" src="assets/image-20210821115948395.png" alt="image-20210821115948395"  />
</p>
<h3 id="522å®‰è£…canal">5.2.2.å®‰è£…Canal<a hidden class="anchor" aria-hidden="true" href="#522å®‰è£…canal">#</a></h3>
<p>å®‰è£…å’Œé…ç½®Canalå‚è€ƒè¯¾å‰èµ„æ–™æ–‡æ¡£ï¼š</p>
<p><img loading="lazy" src="assets/image-20210821120017324.png" alt="image-20210821120017324"  />
</p>
<h2 id="53ç›‘å¬canal">5.3.ç›‘å¬Canal<a hidden class="anchor" aria-hidden="true" href="#53ç›‘å¬canal">#</a></h2>
<p>Canalæä¾›äº†å„ç§è¯­è¨€çš„å®¢æˆ·ç«¯ï¼Œå½“Canalç›‘å¬åˆ°binlogå˜åŒ–æ—¶ï¼Œä¼šé€šçŸ¥Canalçš„å®¢æˆ·ç«¯ã€‚</p>
<p><img loading="lazy" src="assets/image-20210821120049024.png" alt="image-20210821120049024"  />
</p>
<p>æˆ‘ä»¬å¯ä»¥åˆ©ç”¨Canalæä¾›çš„Javaå®¢æˆ·ç«¯ï¼Œç›‘å¬Canalé€šçŸ¥æ¶ˆæ¯ã€‚å½“æ”¶åˆ°å˜åŒ–çš„æ¶ˆæ¯æ—¶ï¼Œå®Œæˆå¯¹ç¼“å­˜çš„æ›´æ–°ã€‚</p>
<p>ä¸è¿‡è¿™é‡Œæˆ‘ä»¬ä¼šä½¿ç”¨GitHubä¸Šçš„ç¬¬ä¸‰æ–¹å¼€æºçš„canal-starterå®¢æˆ·ç«¯ã€‚åœ°å€ï¼šhttps://github.com/NormanGyllenhaal/canal-client</p>
<p>ä¸SpringBootå®Œç¾æ•´åˆï¼Œè‡ªåŠ¨è£…é…ï¼Œæ¯”å®˜æ–¹å®¢æˆ·ç«¯è¦ç®€å•å¥½ç”¨å¾ˆå¤šã€‚</p>
<h3 id="531å¼•å…¥ä¾èµ–">5.3.1.å¼•å…¥ä¾èµ–ï¼š<a hidden class="anchor" aria-hidden="true" href="#531å¼•å…¥ä¾èµ–">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;groupId&gt;</span>top.javatool<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;artifactId&gt;</span>canal-spring-boot-starter<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;version&gt;</span>1.2.1-RELEASE<span style="color:#f92672">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span></code></pre></div><h3 id="532ç¼–å†™é…ç½®">5.3.2.ç¼–å†™é…ç½®ï¼š<a hidden class="anchor" aria-hidden="true" href="#532ç¼–å†™é…ç½®">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">canal</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">destination</span>: <span style="color:#ae81ff">heima</span> <span style="color:#75715e"># canalçš„é›†ç¾¤åå­—ï¼Œè¦ä¸å®‰è£…canalæ—¶è®¾ç½®çš„åç§°ä¸€è‡´</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">server</span>: <span style="color:#ae81ff">192.168.150.101</span>:<span style="color:#ae81ff">11111</span> <span style="color:#75715e"># canalæœåŠ¡åœ°å€</span>
</span></span></code></pre></div><h3 id="533ä¿®æ”¹itemå®ä½“ç±»">5.3.3.ä¿®æ”¹Itemå®ä½“ç±»<a hidden class="anchor" aria-hidden="true" href="#533ä¿®æ”¹itemå®ä½“ç±»">#</a></h3>
<p>é€šè¿‡@Idã€@Columnã€ç­‰æ³¨è§£å®ŒæˆItemä¸æ•°æ®åº“è¡¨å­—æ®µçš„æ˜ å°„ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">package</span> com.heima.item.pojo;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> com.baomidou.mybatisplus.annotation.IdType;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> com.baomidou.mybatisplus.annotation.TableField;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> com.baomidou.mybatisplus.annotation.TableId;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> com.baomidou.mybatisplus.annotation.TableName;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> lombok.Data;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.data.annotation.Id;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.data.annotation.Transient;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> javax.persistence.Column;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.util.Date;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Data</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@TableName</span>(<span style="color:#e6db74">&#34;tb_item&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Item</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@TableId</span>(type <span style="color:#f92672">=</span> IdType.<span style="color:#a6e22e">AUTO</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Id</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> Long id;<span style="color:#75715e">//å•†å“id</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Column</span>(name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;name&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> String name;<span style="color:#75715e">//å•†å“åç§°</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> String title;<span style="color:#75715e">//å•†å“æ ‡é¢˜</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> Long price;<span style="color:#75715e">//ä»·æ ¼ï¼ˆåˆ†ï¼‰</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> String image;<span style="color:#75715e">//å•†å“å›¾ç‰‡</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> String category;<span style="color:#75715e">//åˆ†ç±»åç§°</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> String brand;<span style="color:#75715e">//å“ç‰Œåç§°</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> String spec;<span style="color:#75715e">//è§„æ ¼</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> Integer status;<span style="color:#75715e">//å•†å“çŠ¶æ€ 1-æ­£å¸¸ï¼Œ2-ä¸‹æ¶</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> Date createTime;<span style="color:#75715e">//åˆ›å»ºæ—¶é—´</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> Date updateTime;<span style="color:#75715e">//æ›´æ–°æ—¶é—´</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@TableField</span>(exist <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Transient</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> Integer stock;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@TableField</span>(exist <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Transient</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> Integer sold;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="534ç¼–å†™ç›‘å¬å™¨">5.3.4.ç¼–å†™ç›‘å¬å™¨<a hidden class="anchor" aria-hidden="true" href="#534ç¼–å†™ç›‘å¬å™¨">#</a></h3>
<p>é€šè¿‡å®ç°<code>EntryHandler&lt;T&gt;</code>æ¥å£ç¼–å†™ç›‘å¬å™¨ï¼Œç›‘å¬Canalæ¶ˆæ¯ã€‚æ³¨æ„ä¸¤ç‚¹ï¼š</p>
<ul>
<li>å®ç°ç±»é€šè¿‡<code>@CanalTable(&quot;tb_item&quot;)</code>æŒ‡å®šç›‘å¬çš„è¡¨ä¿¡æ¯</li>
<li>EntryHandlerçš„æ³›å‹æ˜¯ä¸è¡¨å¯¹åº”çš„å®ä½“ç±»</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">package</span> com.heima.item.canal;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> com.github.benmanes.caffeine.cache.Cache;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> com.heima.item.config.RedisHandler;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> com.heima.item.pojo.Item;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.beans.factory.annotation.Autowired;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.stereotype.Component;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> top.javatool.canal.client.annotation.CanalTable;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> top.javatool.canal.client.handler.EntryHandler;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@CanalTable</span>(<span style="color:#e6db74">&#34;tb_item&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Component</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ItemHandler</span> <span style="color:#66d9ef">implements</span> EntryHandler<span style="color:#f92672">&lt;</span>Item<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> RedisHandler redisHandler;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> Cache<span style="color:#f92672">&lt;</span>Long, Item<span style="color:#f92672">&gt;</span> itemCache;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">insert</span>(Item item) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// å†™æ•°æ®åˆ°JVMè¿›ç¨‹ç¼“å­˜</span>
</span></span><span style="display:flex;"><span>        itemCache.<span style="color:#a6e22e">put</span>(item.<span style="color:#a6e22e">getId</span>(), item);
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// å†™æ•°æ®åˆ°redis</span>
</span></span><span style="display:flex;"><span>        redisHandler.<span style="color:#a6e22e">saveItem</span>(item);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">update</span>(Item before, Item after) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// å†™æ•°æ®åˆ°JVMè¿›ç¨‹ç¼“å­˜</span>
</span></span><span style="display:flex;"><span>        itemCache.<span style="color:#a6e22e">put</span>(after.<span style="color:#a6e22e">getId</span>(), after);
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// å†™æ•°æ®åˆ°redis</span>
</span></span><span style="display:flex;"><span>        redisHandler.<span style="color:#a6e22e">saveItem</span>(after);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">delete</span>(Item item) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// åˆ é™¤æ•°æ®åˆ°JVMè¿›ç¨‹ç¼“å­˜</span>
</span></span><span style="display:flex;"><span>        itemCache.<span style="color:#a6e22e">invalidate</span>(item.<span style="color:#a6e22e">getId</span>());
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// åˆ é™¤æ•°æ®åˆ°redis</span>
</span></span><span style="display:flex;"><span>        redisHandler.<span style="color:#a6e22e">deleteItemById</span>(item.<span style="color:#a6e22e">getId</span>());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>åœ¨è¿™é‡Œå¯¹Redisçš„æ“ä½œéƒ½å°è£…åˆ°äº†RedisHandlerè¿™ä¸ªå¯¹è±¡ä¸­ï¼Œæ˜¯æˆ‘ä»¬ä¹‹å‰åšç¼“å­˜é¢„çƒ­æ—¶ç¼–å†™çš„ä¸€ä¸ªç±»ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">package</span> com.heima.item.config;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> com.fasterxml.jackson.core.JsonProcessingException;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> com.fasterxml.jackson.databind.ObjectMapper;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> com.heima.item.pojo.Item;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> com.heima.item.pojo.ItemStock;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> com.heima.item.service.IItemService;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> com.heima.item.service.IItemStockService;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.beans.factory.InitializingBean;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.beans.factory.annotation.Autowired;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.data.redis.core.StringRedisTemplate;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.stereotype.Component;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.util.List;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Component</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">RedisHandler</span> <span style="color:#66d9ef">implements</span> InitializingBean {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> StringRedisTemplate redisTemplate;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> IItemService itemService;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> IItemStockService stockService;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> ObjectMapper MAPPER <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ObjectMapper();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">afterPropertiesSet</span>() <span style="color:#66d9ef">throws</span> Exception {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// åˆå§‹åŒ–ç¼“å­˜</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 1.æŸ¥è¯¢å•†å“ä¿¡æ¯</span>
</span></span><span style="display:flex;"><span>        List<span style="color:#f92672">&lt;</span>Item<span style="color:#f92672">&gt;</span> itemList <span style="color:#f92672">=</span> itemService.<span style="color:#a6e22e">list</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 2.æ”¾å…¥ç¼“å­˜</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> (Item item : itemList) {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 2.1.itemåºåˆ—åŒ–ä¸ºJSON</span>
</span></span><span style="display:flex;"><span>            String json <span style="color:#f92672">=</span> MAPPER.<span style="color:#a6e22e">writeValueAsString</span>(item);
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 2.2.å­˜å…¥redis</span>
</span></span><span style="display:flex;"><span>            redisTemplate.<span style="color:#a6e22e">opsForValue</span>().<span style="color:#a6e22e">set</span>(<span style="color:#e6db74">&#34;item:id:&#34;</span> <span style="color:#f92672">+</span> item.<span style="color:#a6e22e">getId</span>(), json);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 3.æŸ¥è¯¢å•†å“åº“å­˜ä¿¡æ¯</span>
</span></span><span style="display:flex;"><span>        List<span style="color:#f92672">&lt;</span>ItemStock<span style="color:#f92672">&gt;</span> stockList <span style="color:#f92672">=</span> stockService.<span style="color:#a6e22e">list</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 4.æ”¾å…¥ç¼“å­˜</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> (ItemStock stock : stockList) {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 2.1.itemåºåˆ—åŒ–ä¸ºJSON</span>
</span></span><span style="display:flex;"><span>            String json <span style="color:#f92672">=</span> MAPPER.<span style="color:#a6e22e">writeValueAsString</span>(stock);
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 2.2.å­˜å…¥redis</span>
</span></span><span style="display:flex;"><span>            redisTemplate.<span style="color:#a6e22e">opsForValue</span>().<span style="color:#a6e22e">set</span>(<span style="color:#e6db74">&#34;item:stock:id:&#34;</span> <span style="color:#f92672">+</span> stock.<span style="color:#a6e22e">getId</span>(), json);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">saveItem</span>(Item item) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>            String json <span style="color:#f92672">=</span> MAPPER.<span style="color:#a6e22e">writeValueAsString</span>(item);
</span></span><span style="display:flex;"><span>            redisTemplate.<span style="color:#a6e22e">opsForValue</span>().<span style="color:#a6e22e">set</span>(<span style="color:#e6db74">&#34;item:id:&#34;</span> <span style="color:#f92672">+</span> item.<span style="color:#a6e22e">getId</span>(), json);
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">catch</span> (JsonProcessingException e) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> RuntimeException(e);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">deleteItemById</span>(Long id) {
</span></span><span style="display:flex;"><span>        redisTemplate.<span style="color:#a6e22e">delete</span>(<span style="color:#e6db74">&#34;item:id:&#34;</span> <span style="color:#f92672">+</span> id);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>

        </div>

        <footer class="post-footer">
            
<nav class="paginav">
  <a class="prev" href="https://XianCH.github.io/posts/tech/distributed/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%BF%9D%E6%8A%A4/">
    <span class="title">Â« ä¸Šä¸€é¡µ</span>
    <br>
    <span>å¾®æœåŠ¡ä¿æŠ¤</span>
  </a>
  <a class="next" href="https://XianCH.github.io/posts/tech/distributed/springcloud/">
    <span class="title">ä¸‹ä¸€é¡µ Â»</span>
    <br>
    <span>springcloud</span>
  </a>
</nav>

        </footer>
    </div>

<style>
    .comments_details summary::marker {
        font-size: 20px;
        content: 'ğŸ‘‰å±•å¼€è¯„è®º';
        color: var(--content);
    }
    .comments_details[open] summary::marker{
        font-size: 20px;
        content: 'ğŸ‘‡å…³é—­è¯„è®º';
        color: var(--content);
    }
</style>


<div>
    <details class="comments_details">
        <summary style="cursor: pointer; margin: 50px 0 20px 0;width: 130px;">
            <span style="font-size: 20px;color: var(--content);">...</span>
        </summary>
        <div id="tcomment"></div>
    </details>
    <script src="https://cdn.staticfile.org/twikoo/1.5.8/twikoo.all.min.js">
    </script>
    <script>
        twikoo.init({
            envId:  null ,
        el: "#tcomment",
            lang: 'zh-CN',
            region:  null ,
        path: window.TWIKOO_MAGIC_PATH||window.location.pathname,
        })
    </script>
</div>
</article>
</main>

<footer class="footer">
    <span>
        Copyright
        &copy;
        -2024
        <a href="https://XianCH.github.io/" style="color:#939393;">X14n&#39;s Blog</a>
        All Rights Reserved
    </span>
    <a href="https://beian.miit.gov.cn/" target="_blank" style="color:#939393;"></a>&nbsp;
    <span>
        <a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=null"
           style="display:inline-block;text-decoration:none;height:20px;color:#939393;">
            <img src="" style="float:left;margin: 0px 5px 0px 0px;"/>
            
        </a>
    </span>
    <span id="busuanzi_container">
        <span class="fa fa-user"></span> <span id="busuanzi_value_site_uv"></span>
        <span class="fa fa-eye"></span> <span id="busuanzi_value_site_pv"></span>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <span class="topInner">
        <svg class="topSvg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
            <path d="M12 6H0l6-6z"/>
        </svg>
        <span id="read_progress"></span>
    </span>
</a>

<script>
    document.addEventListener('scroll', function (e) {
        const readProgress = document.getElementById("read_progress");
        const scrollHeight = document.documentElement.scrollHeight;
        const clientHeight = document.documentElement.clientHeight;
        const scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
        readProgress.innerText = ((scrollTop / (scrollHeight - clientHeight)).toFixed(2) * 100).toFixed(0);
    })
</script>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });
</script>
<script>
    let mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 200 || document.documentElement.scrollTop > 200) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };
</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        (function() {
            document.cookie = "change-themes" + "="+ escape ("false");
        })()

        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    });
</script>

<script>
    document.body.addEventListener('copy', function (e) {
        if (window.getSelection().toString() && window.getSelection().toString().length > 50) {
            let clipboardData = e.clipboardData || window.clipboardData;
            if (clipboardData) {
                e.preventDefault();
                let htmlData = window.getSelection().toString() +
                    '\r\n\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\r\n' +
                    'ç‰ˆæƒå£°æ˜ï¼šæœ¬æ–‡ä¸ºã€Œ'+"X14n's Blog"+'ã€çš„åŸåˆ›æ–‡ç« ï¼Œéµå¾ªCC 4.0 BY-SAç‰ˆæƒåè®®ï¼Œè½¬è½½è¯·é™„ä¸ŠåŸæ–‡å‡ºå¤„é“¾æ¥åŠæœ¬å£°æ˜ã€‚' +
                '\r\nåŸæ–‡é“¾æ¥ï¼š' + location.href;
                let textData = window.getSelection().toString() +
                    '\r\n\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\r\n' +
                    'ç‰ˆæƒå£°æ˜ï¼šæœ¬æ–‡ä¸ºã€Œ'+"X14n's Blog"+'ã€çš„åŸåˆ›æ–‡ç« ï¼Œéµå¾ªCC 4.0 BY-SAç‰ˆæƒåè®®ï¼Œè½¬è½½è¯·é™„ä¸ŠåŸæ–‡å‡ºå¤„é“¾æ¥åŠæœ¬å£°æ˜ã€‚' +
                '\r\nåŸæ–‡é“¾æ¥ï¼š' + location.href;
                clipboardData.setData('text/html', htmlData);
                clipboardData.setData('text/plain', textData);
            }
        }
    });
</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;
        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerText = 'å¤åˆ¶';

        function copyingDone() {
            copybutton.innerText = 'å·²å¤åˆ¶ï¼';
            setTimeout(() => {
                copybutton.innerText = 'å¤åˆ¶';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                let text = codeblock.textContent +
                    '\r\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\r\n' +
                    'ç‰ˆæƒå£°æ˜ï¼šæœ¬æ–‡ä¸ºã€Œ'+"X14n's Blog"+'ã€çš„åŸåˆ›æ–‡ç« ï¼Œéµå¾ªCC 4.0 BY-SAç‰ˆæƒåè®®ï¼Œè½¬è½½è¯·é™„ä¸ŠåŸæ–‡å‡ºå¤„é“¾æ¥åŠæœ¬å£°æ˜ã€‚' +
                '\r\nåŸæ–‡é“¾æ¥ï¼š' + location.href;
                navigator.clipboard.writeText(text);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) {}
            selection.removeRange(range);
        });

        let language = codeblock.className.replaceAll("language-", "")
        let macTool = document.createElement("div")
        let macTool1 = document.createElement("div")
        let macTool2 = document.createElement("div")
        let macTool3 = document.createElement("div")
        let languageType = document.createElement("div")
        languageType.innerText = language
        macTool.setAttribute('class', 'mac-tool')
        macTool1.setAttribute('class', 'mac bb1')
        macTool2.setAttribute('class', 'mac bb2')
        macTool3.setAttribute('class', 'mac bb3')
        languageType.setAttribute('class', 'language-type')
        macTool.appendChild(macTool1)
        macTool.appendChild(macTool2)
        macTool.appendChild(macTool3)
        macTool.appendChild(languageType)

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
            container.appendChild(macTool)
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
            container.appendChild(macTool)
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
            container.appendChild(macTool)
        }
    });
</script>
</body>

</html>
